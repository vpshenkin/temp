/* @preserve
    Copyright (c) 2005-2016, Mendix bv. All rights reserved.
    See mxclientsystem/licenses.txt for third party licenses that apply.
*/
(window.mxJsonp=window.mxJsonp||[]).push([[1],{692:function(t,e,n){var r=n(15);Object.defineProperty(e,"__esModule",{value:!0}),e.buildOfflineDataBackend=function(t,e,n,r,i){return f.apply(this,arguments)};var i=r(n(95)),u=r(n(96)),a=n(732),c=n(712),o=n(713),s=n(721);function f(){return(f=(0,u.default)(i.default.mark((function t(e,n,r,u,f){var l,d,p,h;return i.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return l=new o.SqlStore(r.schema,n),d=new s.Synchronizer(l,u,e,r),p=new c.OfflineDataBackend(e,l,u,d,f),t.next=5,p.initialize();case 5:return h=new a.OfflineData(e,n),t.abrupt("return",{dataBackend:p,offlineData:h});case 7:case"end":return t.stop()}}),t)})))).apply(this,arguments)}},693:function(t,e,n){var r=n(15);Object.defineProperty(e,"__esModule",{value:!0}),e.FileBackend=void 0;var i=r(n(89)),u=r(n(95)),a=r(n(96)),c=r(n(26)),o=r(n(27)),s=n(703),f=n(256),l=n(31),d=function(){function t(e){(0,c.default)(this,t),this._config=e,this._storageDirPromise=null}var e,n,r,d,b,v;return(0,o.default)(t,[{key:"listDir",value:(v=(0,a.default)(u.default.mark((function t(e){var n,r,i;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this._openDir(e);case 3:return n=t.sent,r=n.createReader(),t.next=7,(0,f.callbackToPromise)(r.readEntries.bind(r));case 7:return i=t.sent,t.abrupt("return",i.map((function(t){return t.name})));case 11:return t.prev=11,t.t0=t.catch(0),t.abrupt("return",[]);case 14:case"end":return t.stop()}}),t,this,[[0,11]])}))),function(t){return v.apply(this,arguments)})},{key:"removeDir",value:(b=(0,a.default)(u.default.mark((function t(e){var n;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this._openDir(e);case 3:return n=t.sent,t.next=6,(0,f.callbackToPromise)(n.removeRecursively.bind(n));case 6:t.next=10;break;case 8:t.prev=8,t.t0=t.catch(0);case 10:case"end":return t.stop()}}),t,this,[[0,8]])}))),function(t){return b.apply(this,arguments)})},{key:"readFile",value:function(t){return this._openFile(t).then((function(t){return function(t){return(0,f.callbackToPromise)(t.file.bind(t)).then(h).then((function(t){return new Blob([t])}))}(t)}))}},{key:"storeFile",value:function(t,e){return this._openFile(e,!0).then((function(e){return n=e,r=t,(0,f.callbackToPromise)(n.createWriter.bind(n)).then((function(t){return function(t,e){return new Promise((function(n,r){e.onwrite=n,e.onerror=r,e.write(t)}))}(r,t)}));var n,r}))}},{key:"moveFile",value:(d=(0,a.default)(u.default.mark((function t(e,n){var r,a,c,o,s,f;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._openFile(e);case 2:return r=t.sent,a=p(n),c=(0,i.default)(a,2),o=c[0],s=c[1],t.next=6,this._openDir(o);case 6:return f=t.sent,t.next=9,m(r,f,s);case 9:case"end":return t.stop()}}),t,this)}))),function(t,e){return d.apply(this,arguments)})},{key:"removeFile",value:(r=(0,a.default)(u.default.mark((function t(e){var n;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._openFile(e);case 2:return n=t.sent,t.next=5,(0,f.callbackToPromise)(n.remove.bind(n));case 5:case"end":return t.stop()}}),t,this)}))),function(t){return r.apply(this,arguments)})},{key:"downloadFile",value:function(t,e){var n=this;return this._config.downloadFileFn?(0,f.callbackToPromise)(this._config.downloadFileFn,t,e):(0,l.get)(t,"blob").then((function(t){return n.storeFile(t,e)}))}},{key:"_openFile",value:(n=(0,a.default)(u.default.mark((function t(e){var n,r,a,c,o,s,l=arguments;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=l.length>1&&void 0!==l[1]&&l[1],r=p(e),a=(0,i.default)(r,2),c=a[0],o=a[1],t.next=4,this._openDir(c,n);case 4:return s=t.sent,t.abrupt("return",(0,f.callbackToPromise)(s.getFile.bind(s),o,{create:n}));case 6:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"_openDir",value:(e=(0,a.default)(u.default.mark((function t(e){var n,r,i,a,c=arguments;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=c.length>1&&void 0!==c[1]&&c[1],r=e.split("/").filter((function(t){return""!==t})),t.next=4,this._getStorageDir();case 4:i=t.sent,a=0;case 6:if(!(a<r.length)){t.next=13;break}return t.next=9,(0,f.callbackToPromise)(i.getDirectory.bind(i),r[a],{create:n});case 9:i=t.sent;case 10:++a,t.next=6;break;case 13:return t.abrupt("return",i);case 14:case"end":return t.stop()}}),t,this)}))),function(t){return e.apply(this,arguments)})},{key:"toAbsolutePath",value:function(t){return(0,s.toAbsolutePath)(s.DEFAULT_FILES_DIRECTORY,t)}},{key:"_getStorageDir",value:function(){return this._config.getStorageDirFn?(0,f.callbackToPromise)(this._config.getStorageDirFn):(null===this._storageDirPromise&&(this._storageDirPromise=(0,f.callbackToPromise)(window.webkitRequestFileSystem,window.TEMPORARY,1048576).then((function(t){return t.root}))),this._storageDirPromise)}}]),t}();function p(t){return t.split(/\/([^/]+)$/)}function h(t){return new Promise((function(e,n){var r=new FileReader;r.onload=function(t){return e(t.target.result)},r.onerror=function(t){return n(t.target.error)},r.readAsArrayBuffer(t)}))}function m(t,e,n){return new Promise((function(r,i){t.moveTo(e,n,r,i)}))}e.FileBackend=d},701:function(t,e,n){n.d(e,"g",(function(){return r})),n.d(e,"f",(function(){return i})),n.d(e,"b",(function(){return u})),n.d(e,"i",(function(){return a})),n.d(e,"h",(function(){return c})),n.d(e,"a",(function(){return o})),n.d(e,"e",(function(){return s})),n.d(e,"c",(function(){return f})),n.d(e,"d",(function(){return l}));var r=20,i="_guidToTable",u="guid",a="tableName",c="readonlyAttrs",o="dirty",s=[u,a,c,o],f="%",l="_"},702:function(t,e,n){n.r(e),n.d(e,"toSafeKey",(function(){return a})),n.d(e,"fromSafeKey",(function(){return c})),n.d(e,"attributeToSql",(function(){return o})),n.d(e,"sqlToRuntime",(function(){return s})),n.d(e,"runtimeToSql",(function(){return f})),n.d(e,"booleanToSql",(function(){return d})),n.d(e,"escapeLikeString",(function(){return p}));var r=n(8),i=n(10),u=n(701);function a(t){return t.replace(".","$")}function c(t){return t.replace("$",".")}function o(t){if(void 0===t)return null;if(t instanceof r.Big)return l(t);if(t instanceof Date)return Number(t);if("boolean"==typeof t)return d(t);if(Array.isArray(t))throw new i.AssertionError;return t}function s(t,e){if(null===t)return null;switch(e){case"DateTime":return t;case"Boolean":return Boolean(t);case"Decimal":case"Integer":case"Long":return r=(n=t).startsWith("-")?"-":"",i=n.replace(/^-?0*/,""),r+(""!==i?i:"0");case"ObjectReferenceSet":return""===t?null:t.split(",");default:return String(t)}var n,r,i}function f(t,e){switch(e){case"AutoNumber":case"Binary":case"HashString":case"Enum":case"ObjectReference":case"ObjectReferenceSet":case"String":return null!=t?String(t):null;case"DateTime":return null!=t?Number(t):null;case"Boolean":return Number(t);case"Decimal":case"Integer":case"Long":return function(t){if(null==t)return null;return l(new r.Big(t))}(t);default:throw new i.AssertionError}}function l(t){var e=u.g-Math.max(0,t.e)-1;return(t.s<0?"-":"")+new Array(e+1).join("0")+t.abs().toFixed()}function d(t){return t?1:0}function p(t,e){return"replace("+("replace("+("replace("+t+', "'+e+'", "'+(e+e)+'")')+', "'+u.c+'", "'+(e+u.c)+'")')+', "'+u.d+'", "'+(e+u.d)+'")'}},703:function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.getFsFileName=function(t,e){return t.replace(/:/g,"_")+"@"+(null!=e&&""!==e?e.toString():"local")},e.createUnsyncedGuid=function(){return"GUID:"+(0,r.getUniqueId)()},e.wasGuidSynced=function(t){return!i.test(t)},e.isSpecialAttributeName=u,e.isReadonlyAttr=a,e.objectToJson=function(t){var e=Object.keys(t).filter((function(t){return!u(t)})).reduce((function(e,n){return e[n]={value:t[n]},a(t,n)&&(e[n].readonly=!0),e}),{});return{guid:t.guid,objectType:t.$objectType,attributes:e}},e.jsonToObject=function(t){var e={guid:t.guid,$objectType:t.objectType,$readonlyAttrs:[]};for(var n in t.attributes)e[n]=t.attributes[n].value,t.attributes[n].readonly&&e.$readonlyAttrs.push(n);return e},e.toAbsolutePath=function(t,e){return t+"/"+e},e.THUMBNAIL_DIR=e.DOCUMENT_DIR=e.DEFAULT_FILES_DIRECTORY=void 0;var r=n(18);e.DEFAULT_FILES_DIRECTORY="files";e.DOCUMENT_DIR="documents";e.THUMBNAIL_DIR="thumbnails";var i=new RegExp("^GUID:");function u(t){return"guid"===t||"$"===t[0]}function a(t,e){return t.$readonlyAttrs.includes(e)}},704:function(t,e,n){n.r(e),n.d(e,"syncedObjsRuntimeToOfflineMap",(function(){return r})),n.d(e,"getRuntimeGuid",(function(){return i}));var r=new(n(705).a);function i(t){return r.reverse().map(t)}},705:function(t,e,n){n.d(e,"a",(function(){return i}));var r=n(0),i=function(){function t(){this.guidMap={}}return t.prototype.add=function(t,e){this.guidMap[t]=e},t.prototype.has=function(t){return t in this.guidMap},t.prototype.map=function(t){return Array.isArray(t)?t.map(this.mapGuid.bind(this)):this.mapGuid(t)},t.prototype.mapChange=function(t,e){var n=this,i={};return Object.keys(t).forEach((function(u){var a=t[u],c=e.isObjectReference(u)&&null!=a.value?n.map(a.value):a.value;i[u]=Object(r.a)(Object(r.a)({},a),{value:c})})),i},t.prototype.mapMxObjectJSON=function(t){var e=this,n=mx.meta.getEntity(t.objectType),i={};return Object.keys(t.attributes).forEach((function(u){var a=t.attributes[u];n.isReference(u)?i[u]=Object(r.a)(Object(r.a)({},a),{value:e.map(a.value)}):i[u]=a})),Object(r.a)(Object(r.a)({},t),{guid:this.map(t.guid),attributes:i})},t.prototype.reverse=function(){var e=this,n=new t;return Object.keys(this.guidMap).forEach((function(t){return n.add(e.map(t),t)})),n},t.prototype.import=function(t){var e=this;Object.keys(t.guidMap).forEach((function(n){return e.add(n,t.guidMap[n])}))},t.prototype.mapGuid=function(t){return t in this.guidMap?this.guidMap[t]:t},t}()},706:function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.QUOTE_CHAR=e.LIKE_ESCAPE_CHAR=void 0;e.LIKE_ESCAPE_CHAR="~";e.QUOTE_CHAR='"'},707:function(t,e,n){function r(t){this.fork=t}Object.defineProperty(e,"__esModule",{value:!0}),e.Task=r,r.of=function(t){return new r((function(e,n){n(t)}))},r.prototype.chain=function(t){var e=this;return new r((function(n,r){e.fork(n,(function(e){t(e).fork(n,r)}))}))},r.prototype.orElse=function(t){var e=this;return new r((function(n,r){e.fork((function(e){t(e).fork(n,r)}),r)}))},r.prototype.ap=function(t){var e,n,i,u=this,a=2;return new r((function(r,c){function o(){0==--a&&c(e(n))}function s(t){void 0===i&&r(i=t)}u.fork(s,(function(t){e=t,o()})),t.fork(s,(function(t){n=t,o()}))}))},r.prototype.map=function(t){return this.chain((function(e){return r.of(t(e))}))},r.rejected=r.prototype.rejected=function(t){return new r((function(e,n){e(t)}))},r.parallel=function(t){return new r((function(e,n){var r,i=t.length,u=new Array(t.length);0!==t.length?t.forEach((function(t,a){t.fork((function(t){void 0===r&&(r=t,e(t))}),function(t){return function(e){u[t]=e,void 0===r&&0==--i&&n(u)}}(a))})):n(u)}))},r.sequence=function(t){return t.reduce((function(t,e){return t.chain((function(t){return e}))}),r.of(null))}},708:function(t,e,n){n.r(e),n.d(e,"instantiateObjects",(function(){return c})),n.d(e,"createChange",(function(){return o}));var r=n(0),i=n(2),u=n(44),a=n(705);function c(t){return Object(r.b)(this,void 0,void 0,(function(){var e,n,c=this;return Object(r.d)(this,(function(o){switch(o.label){case 0:return e=[],n=new a.a,[4,Promise.all(t.map((function(t){return Object(r.b)(c,void 0,void 0,(function(){var a,c;return Object(r.d)(this,(function(r){switch(r.label){case 0:return[4,Object(u.instantiate)(t.objectType,{},[])];case 1:return a=r.sent(),c=Object(i.ensure)(a.objects.find((function(t){return t.guid===a.actionResult}))),e.push(c),n.add(t.guid,c.guid),[2]}}))}))})))];case 1:return o.sent(),[2,[e,n]]}}))}))}function o(t){var e=mx.meta.getEntity(t.objectType),n=Object.keys(t.attributes).filter((function(n){return e.isSyncable(n)&&!t.attributes[n].readonly})).map((function(e){var n,r=t.attributes[e].value;return(n={})[e]={value:r},n}));return Object.assign.apply(Object,Object(r.e)([{}],n))}},709:function(t,e,n){n.r(e),n.d(e,"createDeleteSqlQueries",(function(){return a})),n.d(e,"createDeleteAllSqlQueries",(function(){return c}));var r=n(10),i=n(701),u=n(702);function a(t,e){if(0===e.length)throw new r.AssertionError("No guids specified");var n=new Array(e.length).fill("?").join(", ");return[['DELETE FROM "'+Object(u.toSafeKey)(t)+'" WHERE '+i.b+" IN ("+n+")",e],['DELETE FROM "'+i.f+'" WHERE '+i.i+' = "'+t+'" AND '+i.b+" IN ("+n+")",e]]}function c(t){return[['DELETE FROM "'+Object(u.toSafeKey)(t)+'"',[]],['DELETE FROM "'+i.f+'" WHERE '+i.i+' = "'+t+'"',[]]]}},710:function(t,e,n){n.r(e),n.d(e,"createInsertSqlQueries",(function(){return u}));var r=n(701),i=n(702);function u(t,e){return void 0===e&&(e=!1),[a(t,mx.meta.getEntity(t.objectType)),c(t,e)]}function a(t,e){var n=['"'+r.b+'"'],u=[t.guid];return Object.entries(t.attributes).filter((function(t){var n=t[0];return e.getAttributes().includes(n)})).forEach((function(t){var r=t[0],a=t[1].value;n.push('"'+Object(i.toSafeKey)(r)+'"'),u.push(Object(i.runtimeToSql)(a,e.getAttributeType(r)))})),['INSERT OR REPLACE INTO "'+Object(i.toSafeKey)(t.objectType)+'" ('+n.join(", ")+") VALUES ("+new Array(u.length).fill("?").join(", ")+")",u]}function c(t,e){var n='INSERT OR REPLACE INTO "'+r.f+'" ("'+r.b+'", "'+r.i+'", "'+r.a+'", "'+r.h+'") VALUES (?, ?, ?, ?)',u=Object.keys(t.attributes).filter((function(e){return t.attributes[e].readonly}));return[n,[t.guid,t.objectType,Object(i.booleanToSql)(e),JSON.stringify(u)]]}},712:function(t,e,n){var r=n(15);Object.defineProperty(e,"__esModule",{value:!0}),e.OfflineDataBackend=void 0;var i=r(n(139)),u=r(n(89)),a=r(n(95)),c=r(n(96)),o=r(n(26)),s=r(n(27)),f=r(n(43)),l=r(n(39)),d=r(n(38)),p=n(703),h=n(255),m=n(704),b=n(18),v=n(56),y=n(16),j=n(345),g=n(151),O=n(2),w=n(50);function _(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=(0,d.default)(t);if(e){var i=(0,d.default)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,l.default)(this,n)}}var T={String:null,Integer:"0",Long:"0",Decimal:"0",Enum:null,HashString:null,ObjectReference:null,DateTime:null,Boolean:!1,AutoNumber:"0",Binary:null},k=function(t){(0,f.default)(D,t);var e,n,r,l,d,j,T,k,R=_(D);function D(t,e,n,r,i){var u;return(0,o.default)(this,D),(u=R.call(this))._store=e,u._getDocumentUrl=i||S,u._objectCache=t,u._fileBackend=n,u._synchronizer=r,u}return(0,s.default)(D,[{key:"initialize",value:(k=(0,c.default)(a.default.mark((function t(){var e;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._store.fetchDirty();case 2:e=t.sent,(0,h.markAsDirty)(e.map((function(t){return t.guid})));case 4:case"end":return t.stop()}}),t,this)}))),function(){return k.apply(this,arguments)})},{key:"getByGuid",value:(T=(0,c.default)(a.default.mark((function t(e,n){var r,i,u=this;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Promise.all(e.map((function(t){return u._getByGuid(t)})));case 2:return r=t.sent,i=r.filter((function(t){return null!=t})).map((function(t){return(0,p.objectToJson)(t)})),this._objectCache.setMxObjects(i),t.abrupt("return",{mxobjs:i.map((function(t){var e=t.guid;return u._objectCache.getObject(e)})),count:i.length});case 6:case"end":return t.stop()}}),t,this)}))),function(t,e){return T.apply(this,arguments)})},{key:"getByPath",value:(j=(0,c.default)(a.default.mark((function t(e,n,r,i){var c,o,s,f,l,d,p,h,m,b,v,y,j,g,O,w,_,T=this;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(c=n.split("/"),o=1===c.length?n:c[0],"reverse"!==i){t.next=19;break}if(s=this._objectCache.getAllObjects().filter((function(t){return t.getReferences(o).includes(e)})),!window.mx.meta.getEntity(r).isPersistable()){t.next=10;break}return t.next=7,this.getSlice(r,[{attribute:o,operator:"equals",value:e}]);case 7:t.t0=t.sent.mxobjs,t.next=11;break;case 10:t.t0=[];case 11:return f=t.t0,l=f.filter((function(t){return t.getReferences(o).includes(e)})),d=l.filter((function(t){return!s.some((function(e){return e.getGuid()===t.getGuid()}))})),this._objectCache.setMxObjects(d.map((function(t){return t.jsonData}))),p=s.concat(d),t.abrupt("return",{mxobjs:p,count:p.length});case 19:if(h=this._objectCache.getObject(e)){t.next=27;break}return t.next=23,this.getByGuid([e]);case 23:m=t.sent,b=(0,u.default)(m.mxobjs,1),(v=b[0])&&(h=v);case 27:if(h){t.next=29;break}return t.abrupt("return",{mxobjs:[],count:0});case 29:return y=h.getReferences(o),j=y.map((function(t){return T._objectCache.getObject(t)})).filter((function(t){return null!==t})),g=y.filter((function(t){return!T._objectCache.has(t)})),t.next=34,this.getByGuid(g);case 34:return O=t.sent,w=O.mxobjs,_=w.concat(j),this._objectCache.setMxObjects(w.map((function(t){return t.jsonData}))),t.abrupt("return",{mxobjs:_,count:_.length});case 39:case"end":return t.stop()}}),t,this)}))),function(t,e,n,r){return j.apply(this,arguments)})},{key:"getSlice",value:(d=(0,c.default)(a.default.mark((function t(e,n,r,i){var c,o,s,f,l,d,h,b,v=this;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return b=function(t){return t.attribute&&c.isReference(t.attribute)?Object.assign({},t,{value:(0,m.getRuntimeGuid)(t.value)}):Array.isArray(t.constraints)?Object.assign({},t,{constraints:t.constraints.map((function(t){return b(t)}))}):t},c=window.mx.meta.getEntity(e),t.next=4,this._store.getSlice(e,(n||[]).map((function(t){return b(t)})),r);case 4:return o=t.sent,s=(0,u.default)(o,2),f=s[0],l=s[1],d=f.map(p.objectToJson).map((function(t){return m.syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(t)})),h=[],i?(this._objectCache.setMxObjects(d),h=d.map((function(t){return v._objectCache.getObject(t.guid)}))):h=d.map(y.MxObject.fromJson),t.abrupt("return",{mxobjs:h,count:l});case 12:case"end":return t.stop()}}),t,this)}))),function(t,e,n,r){return d.apply(this,arguments)})},{key:"create",value:function(t){var e=(0,p.createUnsyncedGuid)();return this._objectCache.onCreate([e]),this._objectCache.setMxObjects([x(e,t)]),Promise.resolve(this._objectCache.getObject(e))}},{key:"commit",value:(l=(0,c.default)(a.default.mark((function t(e,n){var r,i,c,o,s,f,l,d,v,y,j,g,w,_,T,k,x=this;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return k=function(t){var e={};return Object.keys(t).forEach((function(n){e[n]=Object.keys(t[n])})),e},T=function(t){return Object.assign({},t,(0,b.mapObject)(r[t.guid],(function(t){return t.value})))},r=(0,b.objectFromArray)(e.map((function(t){return[t,x._objectCache.getChanges(t)]}))),i=(0,O.partition)((function(t){return x._objectCache.has(t)}),e),c=(0,u.default)(i,2),o=c[0],s=c[1],f=o.map((function(t){return x._objectCache.getObject(t)})),l=(0,O.partition)((function(t){return t.isPersistable()}),f),d=(0,u.default)(l,2),v=d[0],y=d[1],j=v.map(E),t.next=9,Promise.all(s.map((function(t){return x._getByGuid(t)})));case 9:if(g=t.sent,!((w=g.concat(j).map(T)).length>0)){t.next=16;break}return t.next=14,this._store.insertOrReplace(w.map((function(t){return(0,p.jsonToObject)(m.syncedObjsRuntimeToOfflineMap.reverse().mapMxObjectJSON((0,p.objectToJson)(t)))})));case 14:(0,h.markAsDirty)(w.map((function(t){return t.guid}))),this._objectCache.setMxObjects(w.map((function(t){return(0,p.objectToJson)(t)})));case 16:return _=y.map(E).map(T),this._objectCache.setMxObjects(_.map((function(t){return(0,p.objectToJson)(t)}))),this._objectCache.onCommit(e),this._objectCache.removeChanges(k(r)),t.abrupt("return",{});case 21:case"end":return t.stop()}}),t,this)}))),function(t,e){return l.apply(this,arguments)})},{key:"rollback",value:function(t){var e=this;this._objectCache.removeAllChanges(t);var n=t.filter((function(t){return e._objectCache.isNew(t)}));return this._objectCache.removeObjects(n),Promise.resolve({})}},{key:"validate",value:function(t){return Promise.resolve({})}},{key:"saveDocument",value:(r=(0,c.default)(a.default.mark((function t(e,n,r,i){var u,c;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(i.size/1048576>r.maxFileSize)){t.next=2;break}throw new v.DescribedError("File too large");case 2:return t.next=4,this._getByGuid(e);case 4:return u=t.sent,c=(0,p.getFsFileName)((0,m.getRuntimeGuid)(e),u?u.changedDate:void 0),t.next=8,this._fileBackend.storeFile(i,this._fileBackend.toAbsolutePath(p.DOCUMENT_DIR+"/"+c));case 8:return this._objectCache.makeChange(e,"HasContents",!0),t.next=11,this.commit([e],null);case 11:case"end":return t.stop()}}),t,this)}))),function(t,e,n,i){return r.apply(this,arguments)})},{key:"getDocumentUrl",value:function(t,e,n){return this._getDocumentUrl((0,p.getFsFileName)((0,m.getRuntimeGuid)(t),e),e,n)}},{key:"getImageUrl",value:function(t){return Promise.resolve(t)}},{key:"upload",value:function(){return this._synchronizer.upload()}},{key:"download",value:(n=(0,c.default)(a.default.mark((function t(e,n){var r;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._synchronizer.download(e,n);case 2:return r=t.sent,(0,h.clearDirtyGuids)(),t.next=6,w.publish.apply(void 0,(0,i.default)(r));case 6:case"end":return t.stop()}}),t,this)}))),function(t,e){return n.apply(this,arguments)})},{key:"cleanupDirtyObjects",value:function(){return this._store.cleanupDirtyObjects()}},{key:"cleanup",value:(e=(0,c.default)(a.default.mark((function t(){return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._store.cleanDatabase();case 2:return t.next=4,this._fileBackend.removeDir(this._fileBackend.toAbsolutePath(p.DOCUMENT_DIR));case 4:return t.next=6,this._fileBackend.removeDir(this._fileBackend.toAbsolutePath(p.THUMBNAIL_DIR));case 6:(0,h.clearDirtyGuids)();case 7:case"end":return t.stop()}}),t,this)}))),function(){return e.apply(this,arguments)})},{key:"_getByGuid",value:function(t){var e=this;return(0,g.memoizeConcurrent)(t,(function(){return e._store.getByGuid((0,m.getRuntimeGuid)(t)).then((function(t){return null===t?null:(0,p.jsonToObject)(m.syncedObjsRuntimeToOfflineMap.mapMxObjectJSON((0,p.objectToJson)(t)))}))}))}}]),D}(j._DataBackend);function E(t){return(0,p.jsonToObject)(t.jsonData)}function x(t,e){var n={guid:t,objectType:e,attributes:{}},r=window.mx.meta.getEntity(e);return r.getAttributes().forEach((function(t){n.attributes[t]={value:T[r.getAttributeType(t)],readonly:r.isAttributeReadonly(t)}})),n}function S(t,e,n){var r=p.DEFAULT_FILES_DIRECTORY+"/"+(n?"thumbnails":"documents");return"filesystem:".concat(window.mx.appUrl,"temporary/").concat(r,"/").concat(t,"?").concat(Date.now())}e.OfflineDataBackend=k},713:function(t,e,n){var r=n(141),i=n(15);Object.defineProperty(e,"__esModule",{value:!0}),e.SqlStore=void 0;var u=i(n(95)),a=i(n(96)),c=i(n(26)),o=i(n(27)),s=r(n(714)),f=n(719),l=n(720),d=function(){function t(e,n){(0,c.default)(this,t),this._tableNames=e;var r=s.createCreateTransaction(this._tableNames);this._databasePromise=(0,l.promiseFromTask)((0,f.runWriteTransaction)(n,r)).then((function(){return n}))}var e,n,r,i,d,p,h,m;return(0,o.default)(t,[{key:"getByGuid",value:(m=(0,a.default)(u.default.mark((function t(e){var n,r;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._databasePromise;case 2:return n=t.sent,r=s.createFetchByGuidTransaction(e),t.abrupt("return",(0,l.promiseFromTask)((0,f.runReadTransaction)(n,r)));case 5:case"end":return t.stop()}}),t,this)}))),function(t){return m.apply(this,arguments)})},{key:"getSlice",value:(h=(0,a.default)(u.default.mark((function t(e,n){var r,i,a,c=arguments;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=c.length>2&&void 0!==c[2]?c[2]:{},t.next=3,this._databasePromise;case 3:return i=t.sent,a=s.createFetchSliceTransaction(e,n,r.offset,r.limit,r.sort),t.abrupt("return",(0,l.promiseFromTask)((0,f.runReadTransaction)(i,a)));case 6:case"end":return t.stop()}}),t,this)}))),function(t,e){return h.apply(this,arguments)})},{key:"rebuildDatabase",value:(p=(0,a.default)(u.default.mark((function t(e,n,r){var i,a;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._databasePromise;case 2:return i=t.sent,a=s.createRebuildTransaction(this._tableNames,r,n,e),t.abrupt("return",(0,l.promiseFromTask)((0,f.runWriteTransaction)(i,a)));case 5:case"end":return t.stop()}}),t,this)}))),function(t,e,n){return p.apply(this,arguments)})},{key:"insertOrReplace",value:(d=(0,a.default)(u.default.mark((function t(e){var n,r;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._databasePromise;case 2:return n=t.sent,r=s.createInsertOrReplaceTransaction(e),t.abrupt("return",(0,l.promiseFromTask)((0,f.runWriteTransaction)(n,r)));case 5:case"end":return t.stop()}}),t,this)}))),function(t){return d.apply(this,arguments)})},{key:"cleanDatabase",value:(i=(0,a.default)(u.default.mark((function t(){var e,n;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._databasePromise;case 2:return e=t.sent,n=s.createCleanTransaction(this._tableNames),t.abrupt("return",(0,l.promiseFromTask)((0,f.runWriteTransaction)(e,n)));case 5:case"end":return t.stop()}}),t,this)}))),function(){return i.apply(this,arguments)})},{key:"fetchDirty",value:(r=(0,a.default)(u.default.mark((function t(){var e,n;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._databasePromise;case 2:return e=t.sent,n=s.createFetchDirtyObjectsTransaction(),t.abrupt("return",(0,l.promiseFromTask)((0,f.runReadTransaction)(e,n)));case 5:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"makeClean",value:(n=(0,a.default)(u.default.mark((function t(e){var n,r;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._databasePromise;case 2:return n=t.sent,r=s.createMakeCleanTransaction(e),t.abrupt("return",(0,l.promiseFromTask)((0,f.runWriteTransaction)(n,r)));case 5:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"cleanupDirtyObjects",value:(e=(0,a.default)(u.default.mark((function t(){var e,n;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._databasePromise;case 2:return e=t.sent,n=s.createDirtyCleanupTransaction(),t.abrupt("return",(0,l.promiseFromTask)((0,f.runWriteTransaction)(e,n)));case 5:case"end":return t.stop()}}),t,this)}))),function(){return e.apply(this,arguments)})}]),t}();e.SqlStore=d},714:function(t,e,n){var r=n(15);Object.defineProperty(e,"__esModule",{value:!0}),e.createCleanTransaction=function(t){var e=[h].concat(t).map(w).map((function(t){return"DELETE FROM '".concat(t,"'")})).map((function(t){return x(t,[])}));return f.TaskReader.parallel(e).map((function(t){}))},e.createFetchByGuidTransaction=function(t){return x((new u.SqlSelectBuilder).from(h).where(u.constraintBuilder.equals("guid")).select(),[t]).chain((function(e){if(0===e.rows.length)return f.TaskReader.of(null);if(1!==e.rows.length)return f.TaskReader.rejected(new Error("db consistency error"));var n=e.rows.item(0),r=n.tableName,i=Boolean(n.dirty),a=n.readonlyAttrs;return x((new u.SqlSelectBuilder).from(w(r)).where(u.constraintBuilder.equals("guid")).select(),[t]).chain((function(t){return 0===t.rows.length?f.TaskReader.rejected(new Error("entity not found")):1!==t.rows.length?f.TaskReader.rejected(new Error("db consistency error")):f.TaskReader.of(T(window.mx.meta.getEntity(r),i,a,t.rows.item(0)))}))}))},e.createFetchSliceTransaction=function(t,e,n,r,i){e=e||[],i=i||[];var c=window.mx.meta.getEntity(t),o=function(t,e){var n=[];return{builder:(new u.SqlSelectBuilder).where(e.map((function e(r){if(r.constraints)return u.constraintBuilder[r.operator](r.constraints.map(e).filter((function(t){return null!==t})));if(null==r.value)switch(r.operator){case"contains":return null;case"equals":return u.constraintBuilder.isNull(w(r.attribute),r.negate)}var i=t.getAttributeType(r.attribute),c=b[i],o=(0,a.runtimeToSql)(c(r.value),i);return n.push("contains"===r.operator?O(o):o),u.constraintBuilder[r.operator](w(r.attribute),r.negate)})).filter((function(t){return null!==t}))),args:n}}(c,e),s=o.builder.from(w(t)),l=o.args,d=s.offset(n).limit(r).join(h,"guid",["dirty","readonlyAttrs"]),p=x((d=i.reduce((function(t,e){return t.order(e[0],e[1])}),d)).select(),l).map((function(t){for(var e=[],n=0;n<t.rows.length;++n){var r=t.rows.item(n),i=Boolean(r["".concat(h,".dirty")]),u=k(r,"readonlyAttrs");e.push(T(c,i,u,r))}return e})),m=x(s.selectCount("cnt"),l).map((function(t){return t.rows.item(0).cnt}));return f.TaskReader.parallel([p,m])},e.createInsertOrReplaceTransaction=function(t){return f.TaskReader.parallel(t.map((function(t){return E((0,d.createInsertSqlQueries)((0,p.objectToJson)(t),!0))})).reduce((function(t,e){return t.concat(e)}),[])).map((function(t){}))},e.createFetchDirtyObjectsTransaction=function(){return y().chain((function(t){var e=g(t.rows).map((function(t){var e=t.tableName,n=(new u.SqlSelectBuilder).from(w(e)).join(h,"guid",["dirty","readonlyAttrs"]).where(u.constraintBuilder.equals("".concat(h,".dirty"))).select(),r=window.mx.meta.getEntity(e);return x(n,[1]).map((function(t){return g(t.rows).map((function(t){return T(r,!0,k(t,"readonlyAttrs"),t)}))}))}));return f.TaskReader.parallel(e)})).map((function(t){return t.reduce((function(t,e){return t.concat(e)}),[])}))},e.createMakeCleanTransaction=function(t){var e=t.map((function(t){return x("UPDATE ".concat(h," set dirty = 0 where guid = ?"),[t.guid])}));return f.TaskReader.parallel(e).map((function(t){}))},e.createDirtyCleanupTransaction=function(){return y().chain((function(t){var e=g(t.rows).map((function(t){var e=t.tableName;return x("DELETE FROM ".concat(w(e)," WHERE guid IN (\n                            SELECT guid FROM ").concat(h," WHERE tableName = ? AND dirty = 1)"),[e])}));return f.TaskReader.sequence([f.TaskReader.parallel(e),x("DELETE FROM ".concat(h," WHERE dirty = 1"))]).map((function(t){}))}))},e.createRebuildTransaction=function(t,e,n,r){var u=t.filter((function(t){return!e.includes(t)})),a=0===e.length,c=function(t,e){var n=(e?[h]:[]).concat(t).map((function(t){return"DROP TABLE IF EXISTS '".concat(w(t),"'")})).map((function(t){return x(t,[])})),r=[f.TaskReader.parallel(n),v(t)];if(!e){var i="DELETE FROM ".concat(h," WHERE tableName IN (").concat(t.map((function(t){return"?"})).join(", "),")");r.push(x(i,t))}return f.TaskReader.sequence(r)}(u,a),o=a?void 0:(b=n,f.TaskReader.parallel(Object.entries(b).flatMap((function(t){var e=(0,i.default)(t,2),n=e[0],r=e[1];return(0,l.createDeleteSqlQueries)(n,r)})).map((function(t){var e=(0,i.default)(t,2);return x(e[0],e[1])})))),s=t.map((function(t){return function(t,e){var n=e.map(p.objectToJson).map((function(t){return E((0,d.createInsertSqlQueries)(t))})).reduce((function(t,e){return t.concat(e)}),[]);return f.TaskReader.parallel(n).map((function(t){}))}(0,r.filter((function(e){return e.$objectType===t})))})),m=[c,o,f.TaskReader.parallel(s)].filter((function(t){return void 0!==t}));var b;return f.TaskReader.sequence(m).map((function(t){}))},e.createCreateTransaction=v;var i=r(n(89)),u=n(715),a=n(702),c=n(706),o=n(716),s=n(707),f=n(717),l=n(709),d=n(710),p=n(703),h="_guidToTable",m={String:"text",Integer:"text",Long:"text",Decimal:"text",Enum:"text",HashString:"text",ObjectReference:"text",DateTime:"integer",Boolean:"integer",AutoNumber:"integer",Binary:"blob"},b={String:j,Integer:j,Long:j,Decimal:j,Enum:j,HashString:j,ObjectReference:j,DateTime:function(t){return t?Number(t):null},Boolean:function(t){return"false"!==t},AutoNumber:j,Binary:j};function v(t){var e,n=[(e=(new o.SqlCreateBuilder).table(h).primaryKeyColumn("guid","text").column("tableName","text").column("dirty","boolean").column("readonlyAttrs","text").createIfNotExists(),x(e,[]))].concat(t.map((function(t){return x(function(t){var e=window.mx.meta.getEntity(t);return e.getAttributes().map((function(t){var n=e.getAttributeType(t);return{attr:t,type:m[n]}}))}(t).reduce((function(t,e){return t.column(w(e.attr),e.type)}),(new o.SqlCreateBuilder).table(w(t)).primaryKeyColumn("guid","text")).createIfNotExists(),[])})));return f.TaskReader.parallel(n).map((function(t){}))}function y(){return x((new u.SqlSelectBuilder).from(h).where(u.constraintBuilder.equals("dirty")).selectDistinct("tableName"),[1])}function j(t){return t}function g(t){for(var e=[],n=0;n<t.length;++n)e.push(t.item(n));return e}function O(t){var e=c.LIKE_ESCAPE_CHAR;return t.replace(new RegExp(e,"g"),e+e).replace(/%/g,e+"%").replace(/_/g,e+"_")}function w(t){return t.replace(".","$")}function _(t){return t.replace("$",".")}function T(t,e,n,r){var i,u={guid:r.guid,$objectType:t.getEntity(),$dirty:e,$readonlyAttrs:JSON.parse(n)};for(var c in r)if(!("guid"===(i=c)||i.indexOf(".")>-1)){var o=_(c),s=t.getAttributeType(o);u[o]=(0,a.sqlToRuntime)(r[c],s)}return u}function k(t,e){return t["".concat(h,".").concat(e)]}function E(t){return t.map((function(t){var e=(0,i.default)(t,2);return x(e[0],e[1])}))}function x(t,e){return e=e||[],new f.TaskReader((function(n){return new s.Task((function(r,i){n.executeSql(t,e,(function(t,e){return i(e)}),(function(t,e){return r(e)}))}))}))}},715:function(t,e,n){var r=n(15);Object.defineProperty(e,"__esModule",{value:!0}),e.constraintBuilder=e.SqlSelectBuilder=void 0;var i=r(n(26)),u=r(n(27)),a=n(706),c=function(){function t(e,n){(0,i.default)(this,t),this._select=n&&n.select||e&&e._select||null,this._from=n&&n.from||e&&e._from||null,this._join=n&&n.join||e&&e._join||null,this._constraints=n&&n.constraints||e&&e._constraints||[],this._orderBy=n&&n.orderBy||e&&e._orderBy||[],this._limit=n&&n.limit||e&&e._limit||null,this._offset=n&&n.offset||e&&e._offset||null}return(0,u.default)(t,[{key:"from",value:function(e){return new t(this,{from:e})}},{key:"join",value:function(e,n,r){return new t(this,{join:{tableName:e,joinOnColumn:n,selectedColumns:r}})}},{key:"where",value:function(e){return new t(this,{constraints:this._constraints.concat(e)})}},{key:"order",value:function(e,n){return new t(this,{orderBy:this._orderBy.concat([[e,n]])})}},{key:"limit",value:function(e){return new t(this,{limit:e})}},{key:"offset",value:function(e){return new t(this,{offset:e})}},{key:"selectDistinct",value:function(t){return Array.isArray(t)&&(t=t.join(", ")),"SELECT DISTINCT ".concat(t," ").concat(this._buildSql())}},{key:"selectCount",value:function(t){return"SELECT COUNT(*) AS ".concat(t)+this._buildSql()}},{key:"select",value:function(){var t=this,e="SELECT ".concat(this._from,".*");return this._join&&this._join.selectedColumns.forEach((function(n){e+=", ".concat(t._join.tableName,".[").concat(n,'] as "').concat(t._join.tableName,".").concat(n,'"')})),e+this._buildSql()}},{key:"_buildSql",value:function(){var t=this,e=" FROM ".concat(this._from," AS ").concat(this._from);return this._join&&(e+=" JOIN ".concat(this._join.tableName," AS ").concat(this._join.tableName," USING (").concat(this._join.joinOnColumn,")")),this._constraints.length>0&&(e+=" WHERE "+this._constraints.map((function(e){return e.build(t._from)})).join(" AND ")),this._orderBy.length>0&&(e+=" ORDER BY "+this._orderBy.map((function(e){return"".concat(t._from,".[").concat(e[0],"] ").concat(e[1])})).join(", ")),(this._limit||this._offset)&&(e+=" LIMIT "+(this._limit||-1)),this._offset&&(e+=" OFFSET "+this._offset),e}}]),t}();e.SqlSelectBuilder=c;var o={equals:p("="),lessThan:p("<"),lessThanOrEquals:p("<="),greaterThan:p(">"),greaterThanOrEquals:p(">="),contains:function(t){var e="";return e+=t,e+=" LIKE '%' || ? || '%'",e+=" ESCAPE '"+a.LIKE_ESCAPE_CHAR+"'"}},s=function(){function t(e,n,r){(0,i.default)(this,t),this._column=e,this._operator=n,this._negate=!!r}return(0,u.default)(t,[{key:"build",value:function(t){var e=o[this._operator],n=this._column.indexOf(".")>-1?this._column:"".concat(t,".[").concat(this._column,"]");return(this._negate?"NOT ":"")+e(n)}}]),t}(),f=function(){function t(e,n){(0,i.default)(this,t),this._column=e,this._negate=!!n}return(0,u.default)(t,[{key:"build",value:function(t){return(this._column.indexOf(".")>-1?this._column:"".concat(t,".[").concat(this._column,"]"))+" IS "+(this._negate?"NOT ":"")+"NULL"}}]),t}(),l=function(){function t(e,n){(0,i.default)(this,t),this.group=e,this.constraints=n||[]}return(0,u.default)(t,[{key:"add",value:function(t){this.constraints.push(t)}},{key:"build",value:function(t){return"("+this.constraints.map((function(e){return e.build(t)})).join(" ".concat(this.group," "))+")"}}]),t}(),d={and:function(t){return new l("and",t)},or:function(t){return new l("or",t)},equals:function(t,e){return new s(t,"equals",e)},isNull:function(t,e){return new f(t,e)},lessThan:function(t,e){return new s(t,"lessThan",e)},lessThanOrEquals:function(t,e){return new s(t,"lessThanOrEquals",e)},greaterThan:function(t,e){return new s(t,"greaterThan",e)},greaterThanOrEquals:function(t,e){return new s(t,"greaterThanOrEquals",e)},contains:function(t,e){return new s(t,"contains",e)}};function p(t){return function(e){return e+" "+t+" ?"}}e.constraintBuilder=d},716:function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.SqlCreateBuilder=i;var r=n(706);function i(t,e){this._tableName=e&&e.tableName||t&&t._tableName||null,this._columns=e&&e.columns||t&&t._columns||[]}function u(t){var e=r.QUOTE_CHAR;return e+t+e}i.prototype.table=function(t){return new i(this,{tableName:t})},i.prototype.column=function(t,e){return new i(this,{columns:this._columns.concat({columnName:t,columnType:e,isPrimary:!1})})},i.prototype.primaryKeyColumn=function(t,e){return new i(this,{columns:this._columns.concat({columnName:t,columnType:e,isPrimary:!0})})},i.prototype.createIfNotExists=function(){var t="";return t+="CREATE TABLE IF NOT EXISTS "+u(this._tableName),t+=this._buildSql()},i.prototype._buildSql=function(){var t="";return this._columns.length>0&&(t+=" (",t+=this._columns.map((function(t){return[u(t.columnName),t.columnType,"text"===t.columnType?" COLLATE NOCASE ":"",t.isPrimary?"PRIMARY KEY ":""].join(" ").slice(0,-1)}),this).join(", "),t+=")"),t}},717:function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.TaskReader=void 0;var r=n(718),i=n(707),u=new r.ReaderT(i.Task);e.TaskReader=u,u.rejected=function(t){return new u((function(e){return i.Task.rejected(t)}))},u.parallel=function(t){return new u((function(e){return new i.Task((function(n,r){if(0!==t.length){var i=new Array(t.length),u=t.length,a=!1;t.forEach((function(t,c){t.run(e).fork((function(t){a||(a=!0,n(t))}),(function(t){i[c]=t,a||0!=--u||r(i)}))}))}else r([])}))}))},u.sequence=function(t){return t.reduce((function(t,e){return t.chain((function(t){return e.map((function(e){return t.concat([e])}))}))}),u.of([]))}},718:function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.ReaderT=function(t){function e(t){this.run=t}return e.prototype.chain=function(t){return new e(function(e){return this.run(e).chain((function(n){return t(n).run(e)}))}.bind(this))},e.prototype.ap=function(t){return new e(function(e){return this.run(e).ap(t.run(e))}.bind(this))},e.prototype.map=function(t){return this.chain((function(n){return e.of(t(n))}))},e.of=function(n){return new e((function(e){return t.of(n)}))},e.ask=function(){return new e(t.of)},e}},719:function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.runWriteTransaction=e.runReadTransaction=void 0;var r=n(707),i=a("readTransaction");e.runReadTransaction=i;var u=a("transaction");function a(t){return function(e,n){return new r.Task((function(r,i){var u,a=2;e[t]((function(t){n.run(t).fork(r,(function(t){u=t,0==--a&&i(u)}))}),r,(function(){0==--a&&i(u)}))}))}}e.runWriteTransaction=u},720:function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.promiseFromTask=function(t){return new Promise((function(e,n){t.fork(n,e)}))}},721:function(t,e,n){var r=n(15);Object.defineProperty(e,"__esModule",{value:!0}),e.Synchronizer=void 0;var i=r(n(127)),u=r(n(139)),a=r(n(89)),c=r(n(95)),o=r(n(96)),s=r(n(26)),f=r(n(27)),l=n(703),d=n(18),p=n(708),h=n(44),m=n(322),b=n(329),v=n(76),y=n(2),j=n(704),g=n(68),O=function(){function t(e,n,r,i){(0,s.default)(this,t),this._store=e,this._fileBackend=n,this._objectCache=r,this._syncConfig=i}var e,n,r,O,w,_;return(0,f.default)(t,[{key:"upload",value:(_=(0,o.default)(c.default.mark((function t(){return c.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this._upload();case 3:return t.abrupt("return",t.sent);case 6:if(t.prev=6,t.t0=t.catch(0),window.mx.logger.warn(t.t0),t.t0 instanceof m.DanglingError){t.next=13;break}throw new b.SynchronizationError;case 13:throw t.t0;case 14:case"end":return t.stop()}}),t,this,[[0,6]])}))),function(){return _.apply(this,arguments)})},{key:"download",value:(w=(0,o.default)(c.default.mark((function t(e,n){return c.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this._download(e,n);case 3:return t.abrupt("return",t.sent);case 6:throw t.prev=6,t.t0=t.catch(0),window.mx.logger.warn(t.t0),new b.SynchronizationError;case 10:case"end":return t.stop()}}),t,this,[[0,6]])}))),function(t,e){return w.apply(this,arguments)})},{key:"_upload",value:(O=(0,o.default)(c.default.mark((function t(){var e,n,r,i,u,s,f,b,v,g,O,w,_,T,k,E,x,S,R,D,C=this;return c.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return D=function(t){return window.mx.meta.getEntity(t.$objectType).isA("System.FileDocument")&&t.HasContents},R=function(t){var e=window.mx.meta.getEntity(t.$objectType);return(0,d.arrayFromObject)(t).filter((function(t){var n=(0,a.default)(t,2),r=n[0];return n[1],"guid"===r||!(0,l.isSpecialAttributeName)(r)&&e.isReference(r)}))},S=function(t){var e=t.map((function(t){return t.guid})),n=(0,d.unique)(t.flatMap((function(t){return R(t).map((function(t){var e=(0,a.default)(t,2);return e[0],e[1]}))}))).filter((function(t){return!(0,l.wasGuidSynced)(t)})).filter((function(t){return!e.includes(t)}));if(n.length>0){var r=(0,d.unique)(t.flatMap((function(t){return R(t).filter((function(t){var e=(0,a.default)(t,2),r=(e[0],e[1]);return n.includes(r)})).map((function(e){var n=(0,a.default)(e,2),r=n[0];return n[1],"object of type ".concat(t.$objectType," (reference ").concat(r,")")}))}))).join(", "),i="Sync has failed due to a modeling error. Your database contains objects that reference uncommitted objects:\n".concat(r,".");throw new m.DanglingError(i)}},t.next=5,this._store.fetchDirty();case 5:if(0!==(e=t.sent).length){t.next=8;break}return t.abrupt("return",{});case 8:return S(e),n=(0,y.partition)((function(t){return(0,l.wasGuidSynced)(t.guid)}),e),r=(0,a.default)(n,2),i=r[0],u=r[1],s=e.filter(D),t.next=13,Promise.all([Promise.all(s.map((function(t){return C._tempUploadFile(t)}))),(0,p.instantiateObjects)(u.map(l.objectToJson))]);case 13:return f=t.sent,b=(0,a.default)(f,2),v=b[0],g=(0,a.default)(b[1],2),O=g[0],w=g[1],_=(0,d.objectFromArray)(v.map((function(t){var e=t.tempGuid,n=t.fileObjGuid;return(0,l.wasGuidSynced)(n)?[e,n]:[e,w.map(n)]}))),T=i.map((function(t){return t.guid})).concat(O.map((function(t){return t.guid}))),k={},e.forEach((function(t){var e=(0,l.objectToJson)(t),n=(0,p.createChange)(e),r=window.mx.meta.getEntity(e.objectType),i=w.mapChange(n,r),u=w.map(e.guid);k[u]=i})),t.next=25,(0,h.synchronize)(T,_,k,O);case 25:return E=t.sent,t.next=28,this._store.makeClean(e);case 28:return t.next=30,Promise.all(s.map(function(){var t=(0,o.default)(c.default.mark((function t(e){var n,r,i,u,a;return c.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=w.map(e.guid),r=E.fileChangedDates[n],i=C._fileBackend.toAbsolutePath(l.DOCUMENT_DIR+"/"),u=i+(0,l.getFsFileName)(e.guid,e.changedDate),a=i+(0,l.getFsFileName)(n,r),t.next=7,C._fileBackend.moveFile(u,a);case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()));case 30:return j.syncedObjsRuntimeToOfflineMap.import(w.reverse()),x={},e.forEach((function(t){var e=t.$objectType,n=t.guid,r=x[e]||[];r.push(w.map(n)),x[e]=r})),t.abrupt("return",x);case 34:case"end":return t.stop()}}),t,this)}))),function(){return O.apply(this,arguments)})},{key:"_download",value:(r=(0,o.default)(c.default.mark((function t(e,n){var r,s,f,p,m,b,v,g,O,w,_,T,k,E,x,S,R,D,C,A,N,F,M,P,B,I,q,L=this;return c.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return q=function(t,e,n){return n.map((function(t){return e.objects.find((function(e){return e.guid===t}))})).map(l.jsonToObject).map((function(e){return Object.assign({},e,{$objectType:t})}))},I=function(){return(I=(0,o.default)(c.default.mark((function t(){var e,n;return c.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==(e=(0,d.flatten)(Object.values(m))).length){t.next=3;break}return t.abrupt("return",[]);case 3:return t.next=5,(0,h.retrieveByIds)(e,{});case 5:return n=t.sent,t.abrupt("return",Object.entries(m).flatMap((function(t){var e=(0,a.default)(t,2),r=e[0],i=e[1];return q(r,n,i.filter((function(t){return n.resultGuids.includes(t)})))})));case 7:case"end":return t.stop()}}),t)})))).apply(this,arguments)},B=function(){return I.apply(this,arguments)},P=function(){return(P=(0,o.default)(c.default.mark((function t(e,n){var r;return c.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,h.retrieveByXPath)(n);case 2:return r=t.sent,t.abrupt("return",q(e,r,r.resultGuids));case 4:case"end":return t.stop()}}),t)})))).apply(this,arguments)},M=function(t,e){return P.apply(this,arguments)},r=this._syncConfig,s=r.fetch,f=r.preserveData,p=r.schema,m=n?{}:Object.assign.apply(Object,[{}].concat((0,u.default)(Object.entries(e).filter((function(t){var e=(0,a.default)(t,1)[0];return f.includes(e)})).map((function(t){var e=(0,a.default)(t,2),n=e[0],r=e[1];return(0,i.default)({},n,r)}))))),t.t0=d.flatten,t.next=10,Promise.all([].concat((0,u.default)(s.map((function(t){var e=t.store,n=t.xpath;return M(e,n)}))),[B()]));case 10:return t.t1=t.sent,b=(0,t.t0)(t.t1),t.next=14,this._computeFilesToDownloadAndDelete(b,!1);case 14:return v=t.sent,g=(0,a.default)(v,2),O=g[0],w=g[1],t.next=20,this._computeFilesToDownloadAndDelete(b,!0);case 20:return _=t.sent,T=(0,a.default)(_,2),k=T[0],E=T[1],t.next=26,Promise.all(O.concat(k).map((function(t){var e=t.source,n=t.destination;return L._fileBackend.downloadFile(e,n)})));case 26:return x=Object.assign.apply(Object,[{}].concat((0,u.default)(Object.entries(m).map((function(t){var e=(0,a.default)(t,2),n=e[0],r=e[1];return(0,i.default)({},n,j.syncedObjsRuntimeToOfflineMap.map(r))}))))),t.next=29,this._store.rebuildDatabase(b,x,n?[]:f);case 29:return Promise.all(w.concat(E).map((function(t){return L._fileBackend.removeFile(t)}))).catch(window.mx.onError),S=b.map((function(t){return(0,l.jsonToObject)(j.syncedObjsRuntimeToOfflineMap.mapMxObjectJSON((0,l.objectToJson)(t)))})),R=this._objectCache.getAllObjects().filter((function(t){if(!t.isPersistable()||L._objectCache.isNew(t.getGuid()))return!1;if(n||!f.includes(t.getEntity()))return!0;var r=e[t.getEntity()]||[];return j.syncedObjsRuntimeToOfflineMap.map(r).includes(t.getGuid())})).map((function(t){return[S.find((function(e){return e.guid===t.getGuid()})),t]})),D=(0,y.partition)((function(t){return void 0!==(0,a.default)(t,1)[0]}),R),C=(0,a.default)(D,2),A=C[0],N=C[1],this._objectCache.setMxObjects(A.map((function(t){var e=(0,a.default)(t,1)[0];return(0,l.objectToJson)(e)}))),this._objectCache.onDelete(N.map((function(t){var e=(0,a.default)(t,2);return e[0],e[1].getGuid()}))),F=p.filter((function(t){return!(!n&&f.includes(t))||void 0!==m[t]&&!m[t].every((function(t){return void 0!==b.find((function(e){return e.guid===t}))}))})).map((function(t){return{entity:t}})),t.abrupt("return",[].concat((0,u.default)(F),(0,u.default)(A.map((function(t){return{guid:(0,a.default)(t,1)[0].guid}}))),(0,u.default)(N.map((function(t){var e=(0,a.default)(t,2);return e[0],{guid:e[1].getGuid()}})))));case 37:case"end":return t.stop()}}),t,this)}))),function(t,e){return r.apply(this,arguments)})},{key:"_tempUploadFile",value:(n=(0,o.default)(c.default.mark((function t(e){var n,r,i;return c.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=l.DOCUMENT_DIR+"/"+(0,l.getFsFileName)(e.guid,e.changedDate),t.next=3,this._fileBackend.readFile(this._fileBackend.toAbsolutePath(n));case 3:return r=t.sent,t.next=6,(0,g.uploadWithRetries)("__sync__","",r,2);case 6:return i=t.sent,t.abrupt("return",{tempGuid:i.commits[0],fileObjGuid:e.guid});case 8:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"_computeFilesToDownloadAndDelete",value:(e=(0,o.default)(c.default.mark((function t(e,n){var r,i,u,a,o;return c.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=this._fileBackend.toAbsolutePath(n?l.THUMBNAIL_DIR:l.DOCUMENT_DIR)+"/",i=e.filter((function(t){return window.mx.meta.getEntity(t.$objectType).isA(n?"System.Image":"System.FileDocument")})).filter((function(t){return t.HasContents})).map((function(t){return{source:(0,v.getRemoteDynamicResourceUrl)(t.guid,t.changedDate,n),destination:r+(0,l.getFsFileName)(t.guid,t.changedDate)}})),t.next=4,this._fileBackend.listDir(r);case 4:return u=t.sent.map((function(t){return r+t})),a=i.filter((function(t){return!u.includes(t.destination)})),o=u.filter((function(t){return!i.find((function(e){return e.destination===t}))})),t.abrupt("return",[a,o]);case 8:case"end":return t.stop()}}),t,this)}))),function(t,n){return e.apply(this,arguments)})}]),t}();e.Synchronizer=O},732:function(t,e,n){n.r(e),n.d(e,"OfflineData",(function(){return Q}));var r=n(0),i=n(2);function u(t,e){return a.inside((function(n,r,i){return n.executeSql(t,e,(function(t,e){return r(e.rows)}),(function(t,e){return i(e),!0}))})).chain((function(t){for(var e=[],n=0;n<t.length;++n)e.push(t.item(n));return e}))}var a=function(){function t(){this.work=[]}return t.prototype.chain=function(e){var n,i=new t;return(n=i.work).push.apply(n,Object(r.e)(this.work,[{action:!1,item:e}])),i},t.prototype.read=function(t){return Object(r.b)(this,void 0,void 0,(function(){return Object(r.d)(this,(function(e){return[2,this.execute((function(e,n){return t.readTransaction(e,n)}))]}))}))},t.prototype.write=function(t){return Object(r.b)(this,void 0,void 0,(function(){return Object(r.d)(this,(function(e){return[2,this.execute((function(e,n){return t.transaction(e,n)}))]}))}))},t.prototype.execute=function(e){return Object(r.b)(this,void 0,void 0,(function(){var n=this;return Object(r.d)(this,(function(r){return[2,new Promise((function(r,i){return e((function(e){var u=Array.from(n.work);!function n(a){a instanceof t&&(u.unshift.apply(u,a.work),a=void 0);var c=u.shift();if(!c)return void r(a);if(c.action)c.item(e,n,i);else try{var o=c.item(a);n(o)}catch(t){i(t)}}(e)}),i)}))]}))}))},t.inside=function(e){var n=new t;return n.work.push({action:!0,item:e}),n},t}(),c=n(195),o=n(703),s=n(10),f=n(22),l=n(56),d=n(85),p=n(50),h=n(44),m=n(705),b=n(708),v=n(255),y=n(709),j=n(710),g=n(701);function O(t){if(0===t.length)throw new s.AssertionError("No guids specified");var e=new Array(t.length).fill("?").join(", ");return['SELECT "'+g.b+'", "'+g.i+'" FROM "'+g.f+'" WHERE "'+g.b+'" IN ('+e+")",t]}var w=n(702);function _(t){return"push_to_client"===t.type}function T(t){return t.filter(_).flatMap((function(t){return t.args.guids}))}function k(t,e,n,c,o,f){var l;return Object(r.b)(this,void 0,void 0,(function(){var d,p;return Object(r.d)(this,(function(h){switch(h.label){case 0:return 0===(d=Object(i.unique)(T(null!==(l=e.instructions)&&void 0!==l?l:[]))).length?[2]:(p=function(t){var e=[];return function(n){return void 0!==n&&(!!t.schema.includes(n)||(e.includes(n)||(e.push(n),mx.logger.warn("Object of type "+n+" cannot be pushed to client, skipping it.")),!1))}}(f),[4,function(t,e,n,c){var o=new a;return t.forEach((function(t){var a,f,l,d=e.map(t),p=Object(i.ensure)(n.getObject(d)),h=(a=p.getEntity(),f=c,l=Object(r.e)([a],mx.meta.getEntity(a).getSuperEntities()),Object.assign.apply(Object,Object(r.e)([{}],f.map((function(t){var e,n=mx.meta.getEntity(t),r=n.getReferenceAttributes().filter((function(t){return l.includes(n.getSelectorEntity(t))}));return r.length>0?((e={})[n.getEntity()]=r,e):{}})))));Object.keys(h).forEach((function(e){h[e].forEach((function(n){var r,i=((r={})[n]=t,r),a=function(t,e,n,r){if(0===Object.keys(e).length)throw new s.AssertionError("No updates specified.");var i=[],u=[];Object.entries(e).forEach((function(e){var n=e[0],r=e[1];u.push('"'+Object(w.toSafeKey)(n)+'" = ?'),i.push(Object(w.runtimeToSql)(r,t.getAttributeType(n)))}));var a=Object(w.toSafeKey)(t.getEntity()),c="WHERE "+a+".["+Object(w.toSafeKey)(n)+"] = ?";return i.push(Object(w.attributeToSql)(r)),["UPDATE "+a+" SET "+u.join(", ")+" "+c,i]}(mx.meta.getEntity(e),i,n,d),c=a[0],f=a[1];o=o.chain((function(){return u(c,f)}))}))}))})),o}(d.filter((function(t){return c.has(t)})),c,n,f.schema).chain((function(){var t=d.map((function(t){return c.map(t)}));return u.apply(void 0,O(t))})).chain((function(t){return Object.assign.apply(Object,Object(r.e)([{}],t.map((function(t){var e;return(e={})[t[g.b]]=t[g.i],e}))))})).chain((function(t){var n={},r={},i=new a;return d.forEach((function(i){var u,a,o=null===(u=e.objects)||void 0===u?void 0:u.find((function(t){return t.guid===i})),s=c.map(i),f=null!==(a=null==o?void 0:o.objectType)&&void 0!==a?a:t[s];p(f)&&(void 0===r[f]&&(r[f]=[]),r[f].push(s)),p(null==o?void 0:o.objectType)&&(void 0===n[f]&&(n[f]=[]),n[f].push(o))})),Object.keys(r).forEach((function(t){var e=Object(y.createDeleteSqlQueries)(t,r[t]),n=e[0],a=e[1];i=i.chain((function(){return u.apply(void 0,n)})).chain((function(){return u.apply(void 0,a)}))})),Object.keys(n).forEach((function(t){n[t].forEach((function(t){var e=Object(j.createInsertSqlQueries)(t),n=e[0],r=e[1];i=i.chain((function(){return u.apply(void 0,n)})).chain((function(){return u.apply(void 0,r)}))}))})),i})).write(t)]);case 1:return h.sent(),d.filter((function(t){var n;return null===(n=e.objects)||void 0===n?void 0:n.every((function(e){return e.guid!==t}))})).forEach((function(t){var e=t;c.has(t)?e=c.map(t):o.has(t)&&(e=o.map(t));var r=n.getObject(e);null!==r&&r.markAsUnavailable()})),d.filter((function(t){return c.has(t)})).forEach((function(t){return o.add(t,c.map(t))})),d.forEach((function(t){return Object(v.unmarkAsDirty)(c.map(t))})),[2]}}))}))}var E=n(62),x=n(252);function S(t,e,n,a){var c,o;return Object(r.b)(this,void 0,void 0,(function(){var s,f,l,d,p,h,m,b,v;return Object(r.d)(this,(function(y){switch(y.label){case 0:return s=Object(x.a)(n,t),f=Object(i.unique)(null!==(o=null===(c=t.instructions)||void 0===c?void 0:c.filter(_).flatMap((function(t){return t.args.guids})))&&void 0!==o?o:[]),l=Object(i.partition)((function(e){return function(t,e){var n;return!0===(null===(n=e.objects)||void 0===n?void 0:n.some((function(e){return e.guid===t})))}(e,t)}),f),d=l[0],p=l[1],h=Object.assign.apply(Object,Object(r.e)([{}],d.map((function(e){var n;return(n={})[e]=function(t,e){return e.objects.find((function(e){return e.guid===t})).objectType}(e,t),n})))),p.length>0?[4,u.apply(void 0,O(p)).read(a)]:[3,2];case 1:y.sent().forEach((function(t){h[t[g.b]]=t[g.i]})),y.label=2;case 2:return m=Object(i.unique)(s.filter(R).map((function(t){return t.entity})).concat(Object.values(h))).filter((function(t){return C(t,e)})).map((function(t){return{entity:t}})),b=Object.entries(h).filter((function(t){t[0];return C(t[1],e)})).map((function(t){return t[0]})),v=Object(i.unique)(s.filter(D).map((function(t){return t.guid})).concat(b)).filter((function(t){return n.has(t)})).map((function(t){return{guid:t}})),[2,Object(r.e)(s.filter((function(t){return"attr"in t&&!b.includes(t.guid)})),v,m)]}}))}))}function R(t){return"entity"in t}function D(t){return"guid"in t}function C(t,e){return!mx.meta.getEntity(t).isPersistable()||e.includes(t)}function A(t,e,n,i){return Object(r.b)(this,void 0,void 0,(function(){var u;return Object(r.d)(this,(function(r){switch(r.label){case 0:return[4,S(e,n,t,i)];case 1:return u=r.sent(),[4,Object(E.handleState)(t,e)];case 2:return r.sent(),[2,u]}}))}))}var N=n(704);function F(t,e,n,u){return Object(r.b)(this,void 0,void 0,(function(){var a,v,y,j,g,O,w,_,E,x,S,R,D,C;return Object(r.d)(this,(function(F){switch(F.label){case 0:if((a=Object(d.b)(e)).some((function(t){return!n.has(t)})))throw new s.AssertionError("Microflow parameter is not available in the client state");if((v=Object(c.findReachableGuidsForRequest)(n.getAllObjects(),a)).filter(o.wasGuidSynced).map((function(t){return mx.meta.getEntity(n.getObject(t).getEntity())})).some((function(t){return!t.isPersistable()})))throw new l.DescribedError("Non-persistable objects created in a microflow can't be passed to another microflow");return y=N.syncedObjsRuntimeToOfflineMap.reverse(),j=v.filter((function(t){return!Object(o.wasGuidSynced)(t)&&!y.has(t)})).map((function(t){return n.getObject(t).jsonData})),[4,Object(b.instantiateObjects)(j)];case 1:return g=F.sent(),O=g[0],w=g[1],(_=new m.a).import(y),_.import(w),E=function(t,e,n){var r={};return t.forEach((function(t){var i=e.getObject(t).jsonData,u=mx.meta.getEntity(i.objectType),a=Object(b.createChange)(i),c=n.map(i.guid);r[c]=n.mapChange(a,u);var o=n.mapChange(e.getChanges(t),u);Object.keys(o).filter((function(t){return u.isSyncable(t)})).forEach((function(t){r[c][t]=o[t]}))})),r}(v,n,_),[4,Object(h.executeMicroflow)(t,M(e,_),[],E,O)];case 2:return x=F.sent(),S=function(t,e){var n=t.actionResult,u=t.objects,a=void 0===u?[]:u,c=t.changes,o=void 0===c?{}:c,s=t.commits,f=void 0===s?[]:s,l=t.resets,d=void 0===l?{}:l,p=t.deletes,h=void 0===p?[]:p,m=t.instructions,b=void 0===m?[]:m,v=T(b),y=P(Object(i.unique)(Object(r.e)(a.map((function(t){return t.guid})),Object.keys(o),Object.keys(d),h)),a,e),j=v.concat(y);return{actionResult:n,newpersistable:[],commits:B(f,j),committedObjectsOmitted:!1,deletes:B(h,j),changes:I(o,j),resets:I(d,j),instructions:q(b,a,e),objects:a.filter((function(t){return j.includes(t.guid)}))}}(function(t,e,n){var r=t.actionResult,i=t.objects,u=void 0===i?[]:i,a=t.changes,c=void 0===a?{}:a,o=t.commits,s=void 0===o?[]:o,f=t.committedObjectsOmitted,l=void 0!==f&&f,d=t.resets,p=void 0===d?{}:d,h=t.deletes,m=void 0===h?[]:h,b=t.newpersistable,v=void 0===b?[]:b,y=t.instructions,j=void 0===y?[]:y,g={commits:e.map(s),committedObjectsOmitted:l,deletes:e.map(m),newpersistable:e.map(v),instructions:U(j,e),objects:u.map((function(t){return e.mapMxObjectJSON(t)})),changes:L(c,u,n,e),resets:G(p,e)};r&&(g.actionResult=function(t,e){if(null===t.value)return t;switch(t.type){case"ObjectReference":case"ObjectReferenceSet":return{type:t.type,value:e.map(t.value)};default:return t}}(r,e));return g}(x,_.reverse(),n),n),R=Object(i.ensure)(mx.session.getOfflineConfig()),[4,k(u,x,n,w.reverse(),N.syncedObjsRuntimeToOfflineMap,R)];case 3:return F.sent(),[4,A(n,S,R.schema,u)];case 4:return(D=F.sent()).length>0?[4,p.publish.apply(void 0,D)]:[3,6];case 5:F.sent(),F.label=6;case 6:return[2,null==(C=S.actionResult)?void 0:Object(f.runtimeValueToExpressionVariable)(C.value,C.type,(function(t){return Object(i.ensure)(n.getObject(t))}))]}}))}))}function M(t,e){var n={};return Object.keys(t).forEach((function(r){var i=t[r];n[r]="guid"in i?{guid:e.map(i.guid)}:"guids"in i?{guids:e.map(i.guids)}:i})),n}function P(t,e,n){return t.filter((function(t){var r,i,u=null!==(r=e.find((function(e){return e.guid===t})))&&void 0!==r?r:null===(i=n.getObject(t))||void 0===i?void 0:i.jsonData;return u&&mx.meta.hasEntity(u.objectType)&&!mx.meta.getEntity(u.objectType).isPersistable()}))}function B(t,e){return t.filter((function(t){return e.includes(t)}))}function I(t,e){return Object.assign.apply(Object,Object(r.e)([{}],Object.keys(t).filter((function(t){return e.includes(t)})).map((function(e){var n;return(n={})[e]=t[e],n}))))}function q(t,e,n){return t.flatMap((function(t){switch(t.type){case"refresh_class":var i=t.args.classnames.filter((function(t){return mx.meta.hasEntity(t)&&!mx.meta.getEntity(t).isPersistable()}));return i.length>0?[Object(r.a)(Object(r.a)({},t),{args:{classnames:i}})]:[];case"refresh_object_list":var u=P(t.args.ObjectIds,e,n);return u.length>0?[Object(r.a)(Object(r.a)({},t),{args:{ObjectIds:u}})]:[];case"push_to_client":return t;default:return[]}}))}function L(t,e,n,u){return Object.assign.apply(Object,Object(r.e)([{}],Object.keys(t).map((function(r){var a,c,o,s=(null!==(o=e.find((function(t){return t.guid===r})))&&void 0!==o?o:Object(i.ensure)(n.getObject(u.map(r))).jsonData).objectType;return mx.meta.hasEntity(s)?((a={})[u.map(r)]=u.mapChange(t[r],mx.meta.getEntity(s)),a):((c={})[r]=t[r],c)}))))}function G(t,e){return Object.assign.apply(Object,Object(r.e)([{}],Object.keys(t).map((function(n){var r;return(r={})[e.map(n)]=t[n],r}))))}function U(t,e){return t.map((function(t){switch(t.type){case"refresh_object_list":return Object(r.a)(Object(r.a)({},t),{args:{ObjectIds:e.map(t.args.ObjectIds)}});case"push_to_client":return Object(r.a)(Object(r.a)({},t),{args:{guids:e.map(t.args.guids)}});default:return t}}))}var H={type:"int",expr:"1",params:[]},J={type:"int",expr:"0",params:[]};function W(t){return"null"===t.type?{type:"int",expr:"0",params:[]}:t}function K(t){return"string"===t.type?{type:"int",expr:"cast("+t.expr+" as integer)",params:t.params}:t}function $(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(t=[]).concat.apply(t,e.map((function(t){return t.params})))}var z=function(){function t(t){this.attrs=[],this.tableName=Object(w.toSafeKey)(t),this.fromClause="FROM "+this.tableName+" AS "+this.tableName}return t.prototype.filtered=function(t){var e=function t(e,n){switch(e.type){case"attribute":return{type:"Boolean"===e.attributeType||"DateTime"===e.attributeType?"int":"string",expr:n+".["+("id"!==e.attribute?Object(w.toSafeKey)(e.attribute):"guid")+"]",params:[]};case"value":var r=Object(w.attributeToSql)(e.value);return null===r?{type:"null",expr:"NULL",params:[]}:{type:"number"==typeof r?"int":"string",expr:"?",params:[r]};case"function":var i=e.parameters.map((function(e){return t(e,n)}));switch(e.name){case"true":return H;case"false":return J;case"not":return{type:"int",expr:"(not "+(c=W(i[0])).expr+")",params:c.params};case"or":case"and":var u=i.map(W);return{type:"int",expr:"("+u.map((function(t){return t.expr})).join(" "+e.name+" ")+")",params:$.apply(void 0,u)};case"=":case"!=":case">":case">=":case"<":case"<=":var a=i.some((function(t){return"int"===t.type}))?i.map(K):i,c=a[0],o=a[1],f="="===e.name?"is":"!="===e.name?"is not":e.name;return{type:"int",expr:"("+c.expr+" "+f+" "+o.expr+")",params:$(c,o)};case"contains":case"starts-with":case"ends-with":if("null"===i[1].type)return H;if("null"===i[0].type)return J;var l=Object(w.escapeLikeString)(i[1].expr,"~"),d="starts-with"===e.name?l+" || '"+g.c+"'":"ends-with"===e.name?"'"+g.c+"' || "+l:"'"+g.c+"' || "+l+" || '"+g.c+"'";return{type:"int",expr:"("+i[0].expr+" like "+d+" escape '~')",params:i[0].params.concat(i[1].params)};case"length":case"string-length":return"null"===i[0].type?J:{type:"int",expr:"length("+i[0].expr+")",params:i[0].params};default:throw new s.AssertionError("Operator "+e.name+" is not yet supported")}}}(t,this.tableName),n=e.type,r=e.expr,i=e.params;return"null"!==n&&(this.whereClause="WHERE "+r,this.bindParameters=i),this},t.prototype.sorted=function(t){var e=this,n=t.map((function(t){var n=t[0],r=t[1];return e.tableName+".["+Object(w.toSafeKey)(n)+"] "+r})).join(", ");return this.orderClause=n?"ORDER BY "+n:"",this},t.prototype.paged=function(t,e){return this.limitClause="LIMIT "+(void 0!==e?e:-1)+" OFFSET "+(null!=t?t:0),this},t.prototype.attributes=function(t){return this.attrs=t,this},t.prototype.buildSelectWithMeta=function(){var t,e=this;return[["SELECT",this.attrs.map((function(t){return e.tableName+".["+Object(w.toSafeKey)(t)+'] as "'+Object(w.toSafeKey)(t)+'"'})).concat(g.e.map((function(t){return g.f+".["+t+'] as "'+g.f+"."+t+'"'}))).join(", "),this.fromClause,"JOIN "+g.f+" AS "+g.f+" USING ("+g.b+")",this.whereClause,this.orderClause,this.limitClause].filter((function(t){return t})).join(" "),null!==(t=this.bindParameters)&&void 0!==t?t:[]]},t.prototype.buildCount=function(){var t;return[['SELECT COUNT("guid") AS count',this.fromClause,this.whereClause].filter((function(t){return t})).join(" "),null!==(t=this.bindParameters)&&void 0!==t?t:[]]},t}();var Q=function(){function t(t,e){this.objectCache=t,this.database=e}return t.prototype.retrieve=function(t,e,n){return Object(r.b)(this,void 0,void 0,(function(){var a,c,o,s,f,l,d,p,h=this;return Object(r.d)(this,(function(m){switch(m.label){case 0:return a=mx.meta.getEntity(t),c=new z(t).attributes(a.getAttributes()),void 0!==e&&c.filtered(e),void 0===n.offset&&void 0===n.amount||c.paged(n.offset,n.amount),void 0!==n.sort&&c.sorted(n.sort),o=c.buildSelectWithMeta(),s=c.buildCount(),[4,u.apply(void 0,o).chain((function(t){return u.apply(void 0,s).chain((function(e){return{rows:t,count:e[0].count}}))})).read(this.database)];case 1:return f=m.sent(),l=f.rows,d=f.count,p=l.map((function(t){return N.syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(function(t,e){var n={guid:e[g.f+"."+g.b],objectType:t.getEntity(),attributes:{}},i=JSON.parse(e[g.f+"."+g.h])||[];return Object.keys(e).filter((function(t){return!t.startsWith(g.f)})).forEach((function(u){var a=Object(w.fromSafeKey)(u),c=t.getAttributeType(a);n.attributes[a]=Object(r.a)({value:Object(w.sqlToRuntime)(e[u],c)},i.includes(a)?{readonly:!0}:{})})),n}(a,t))})),this.objectCache.setMxObjects(p),[2,{mxobjs:p.map((function(t){return Object(i.ensure)(h.objectCache.getObject(t.guid))})),count:d}]}}))}))},t.prototype.executeMicroflow=function(t,e){return Object(r.b)(this,void 0,void 0,(function(){return Object(r.d)(this,(function(n){return[2,F(t,e,this.objectCache,this.database)]}))}))},t}()}}]);