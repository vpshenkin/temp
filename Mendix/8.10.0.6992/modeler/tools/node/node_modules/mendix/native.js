import{NativeModules,YellowBox,Platform,View,Alert,NativeEventEmitter,StyleSheet,Dimensions,StatusBar,Text,BackHandler,ActivityIndicator,TopLevelView,AppRegistry,unstable_batchedUpdates}from"react-native";import{i as isComputed,c as computed,a as autorun,p as publish,s as subscribe,b as action,g as getSubscribedGuids,d as getTags,e as comparer,u as unavailable,f as available,h as getOrElseL,j as configure}from"./2252f97c.js";import{useState,useLayoutEffect,createElement,memo,isValidElement,Component}from"react";import{f as friendlyName,A as AssertionError,u as useIsFirstRender,t as toWidgetName,m as mapValues,i as isJson,e as ensure,a as unique,c as concat,b as uniqueBy,p as partition,d as isDefined,g as flatten$1}from"./e81b9882.js";import{i as isComputationResult,t as toValue,a as isComputation,b as toEvaluation}from"./0ad2390d.js";import{p as pageScope,u as unmarkAsDirty,m as markAsDirty,c as clearDirtyGuids}from"./0b2c9cb2.js";import{n as newId}from"./3cf8690e.js";import"./0e7164f2.js";import{u as useComponentStore,R as RootStoreProvider,c as createRootStore}from"./5e2d0c2a.js";import{Big}from"big.js";export{Big}from"big.js";import{t as translate,s as setSystemTexts,u as updateActiveLanguageIndex}from"./11de92d0.js";export{a as t}from"./11de92d0.js";import{D as DescribedServerError,a as DescribedError,M as MxObject,c as clone$1,b as curry,u as unique$1,g as groupBy,d as arrayFromObject,e as curryN,f as getUniqueId,r as runtimeValueToExpressionVariable,o as objectFromArray,m as mapObject,h as flatten}from"./e4677d80.js";import{openDatabase}from"react-native-sqlite-storage";import{O as ObjectValidation,w as wait,n as nanoflowEngine,a as never,b as withFinally}from"./c40e70cb.js";import{V as ValidationError,g as getGuidsFromMicroflowArguments,D as DanglingError}from"./dbc0cbf9.js";import{f as formatDate,a as formatNumber,p as parseDate,b as parseNumber,s as startupLocalization}from"./d1a3b52a.js";import"./275ae0e7.js";import"./449717b5.js";import"./61ebc708.js";import AsyncStorage from"@react-native-community/async-storage";import{NavigationActions,StackActions,NavigationEvents,createAppContainer}from"react-navigation";import{createDrawerNavigator,DrawerActions}from"react-navigation-drawer";import{createStackNavigator,HeaderStyleInterpolators,HeaderTitle,TransitionPresets}from"react-navigation-stack";import{getLocales}from"react-native-localize";import{_ as __rest}from"./d46da013.js";import Svg,{Path,Svg as Svg$1}from"react-native-svg";import{T as Touchable}from"./d063a6c8.js";import{createBottomTabNavigator}from"react-navigation-tabs";import"react-native-vector-icons";import{Icon}from"./components/native/Icon.js";import"react-native-fast-image";import"./components/native/Image.js";import codePush from"react-native-code-push";import DeviceInfo from"react-native-device-info";import"react-native-gesture-handler";var fails=function(exec){try{return!!exec()}catch(error){return!0}},toString={}.toString,classofRaw=function(it){return toString.call(it).slice(8,-1)},split="".split,indexedObject=fails((function(){return!Object("z").propertyIsEnumerable(0)}))?function(it){return"String"==classofRaw(it)?split.call(it,""):Object(it)}:Object,requireObjectCoercible=function(it){if(null==it)throw TypeError("Can't call method on "+it);return it},toIndexedObject=function(it){return indexedObject(requireObjectCoercible(it))},commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(fn,module){return fn(module={exports:{}},module.exports),module.exports}var activeXDocument,check=function(it){return it&&it.Math==Math&&it},global_1=check("object"==typeof globalThis&&globalThis)||check("object"==typeof window&&window)||check("object"==typeof self&&self)||check("object"==typeof commonjsGlobal&&commonjsGlobal)||Function("return this")(),descriptors=!fails((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),isObject=function(it){return"object"==typeof it?null!==it:"function"==typeof it},document$1=global_1.document,EXISTS=isObject(document$1)&&isObject(document$1.createElement),documentCreateElement=function(it){return EXISTS?document$1.createElement(it):{}},ie8DomDefine=!descriptors&&!fails((function(){return 7!=Object.defineProperty(documentCreateElement("div"),"a",{get:function(){return 7}}).a})),anObject=function(it){if(!isObject(it))throw TypeError(String(it)+" is not an object");return it},toPrimitive=function(input,PREFERRED_STRING){if(!isObject(input))return input;var fn,val;if(PREFERRED_STRING&&"function"==typeof(fn=input.toString)&&!isObject(val=fn.call(input)))return val;if("function"==typeof(fn=input.valueOf)&&!isObject(val=fn.call(input)))return val;if(!PREFERRED_STRING&&"function"==typeof(fn=input.toString)&&!isObject(val=fn.call(input)))return val;throw TypeError("Can't convert object to primitive value")},nativeDefineProperty=Object.defineProperty,objectDefineProperty={f:descriptors?nativeDefineProperty:function(O,P,Attributes){if(anObject(O),P=toPrimitive(P,!0),anObject(Attributes),ie8DomDefine)try{return nativeDefineProperty(O,P,Attributes)}catch(error){}if("get"in Attributes||"set"in Attributes)throw TypeError("Accessors not supported");return"value"in Attributes&&(O[P]=Attributes.value),O}},createPropertyDescriptor=function(bitmap,value){return{enumerable:!(1&bitmap),configurable:!(2&bitmap),writable:!(4&bitmap),value:value}},createNonEnumerableProperty=descriptors?function(object,key,value){return objectDefineProperty.f(object,key,createPropertyDescriptor(1,value))}:function(object,key,value){return object[key]=value,object},setGlobal=function(key,value){try{createNonEnumerableProperty(global_1,key,value)}catch(error){global_1[key]=value}return value},sharedStore=global_1["__core-js_shared__"]||setGlobal("__core-js_shared__",{}),shared=createCommonjsModule((function(module){(module.exports=function(key,value){return sharedStore[key]||(sharedStore[key]=void 0!==value?value:{})})("versions",[]).push({version:"3.6.5",mode:"global",copyright:"Â© 2020 Denis Pushkarev (zloirock.ru)"})})),hasOwnProperty={}.hasOwnProperty,has=function(it,key){return hasOwnProperty.call(it,key)},id=0,postfix=Math.random(),uid=function(key){return"Symbol("+String(void 0===key?"":key)+")_"+(++id+postfix).toString(36)},nativeSymbol=!!Object.getOwnPropertySymbols&&!fails((function(){return!String(Symbol())})),useSymbolAsUid=nativeSymbol&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,WellKnownSymbolsStore=shared("wks"),Symbol$1=global_1.Symbol,createWellKnownSymbol=useSymbolAsUid?Symbol$1:Symbol$1&&Symbol$1.withoutSetter||uid,wellKnownSymbol=function(name){return has(WellKnownSymbolsStore,name)||(nativeSymbol&&has(Symbol$1,name)?WellKnownSymbolsStore[name]=Symbol$1[name]:WellKnownSymbolsStore[name]=createWellKnownSymbol("Symbol."+name)),WellKnownSymbolsStore[name]},ceil=Math.ceil,floor=Math.floor,toInteger=function(argument){return isNaN(argument=+argument)?0:(argument>0?floor:ceil)(argument)},min=Math.min,toLength=function(argument){return argument>0?min(toInteger(argument),9007199254740991):0},max=Math.max,min$1=Math.min,createMethod=function(IS_INCLUDES){return function($this,el,fromIndex){var value,O=toIndexedObject($this),length=toLength(O.length),index=function(index,length){var integer=toInteger(index);return integer<0?max(integer+length,0):min$1(integer,length)}(fromIndex,length);if(IS_INCLUDES&&el!=el){for(;length>index;)if((value=O[index++])!=value)return!0}else for(;length>index;index++)if((IS_INCLUDES||index in O)&&O[index]===el)return IS_INCLUDES||index||0;return!IS_INCLUDES&&-1}},arrayIncludes={includes:createMethod(!0),indexOf:createMethod(!1)},hiddenKeys={},indexOf=arrayIncludes.indexOf,objectKeysInternal=function(object,names){var key,O=toIndexedObject(object),i=0,result=[];for(key in O)!has(hiddenKeys,key)&&has(O,key)&&result.push(key);for(;names.length>i;)has(O,key=names[i++])&&(~indexOf(result,key)||result.push(key));return result},enumBugKeys=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],objectKeys=Object.keys||function(O){return objectKeysInternal(O,enumBugKeys)},objectDefineProperties=descriptors?Object.defineProperties:function(O,Properties){anObject(O);for(var key,keys=objectKeys(Properties),length=keys.length,index=0;length>index;)objectDefineProperty.f(O,key=keys[index++],Properties[key]);return O},path=global_1,aFunction=function(variable){return"function"==typeof variable?variable:void 0},getBuiltIn=function(namespace,method){return arguments.length<2?aFunction(path[namespace])||aFunction(global_1[namespace]):path[namespace]&&path[namespace][method]||global_1[namespace]&&global_1[namespace][method]},html=getBuiltIn("document","documentElement"),keys=shared("keys"),sharedKey=function(key){return keys[key]||(keys[key]=uid(key))},IE_PROTO=sharedKey("IE_PROTO"),EmptyConstructor=function(){},scriptTag=function(content){return"<script>"+content+"<\/script>"},NullProtoObject=function(){try{activeXDocument=document.domain&&new ActiveXObject("htmlfile")}catch(error){}var iframeDocument,iframe;NullProtoObject=activeXDocument?function(activeXDocument){activeXDocument.write(scriptTag("")),activeXDocument.close();var temp=activeXDocument.parentWindow.Object;return activeXDocument=null,temp}(activeXDocument):((iframe=documentCreateElement("iframe")).style.display="none",html.appendChild(iframe),iframe.src=String("javascript:"),(iframeDocument=iframe.contentWindow.document).open(),iframeDocument.write(scriptTag("document.F=Object")),iframeDocument.close(),iframeDocument.F);for(var length=enumBugKeys.length;length--;)delete NullProtoObject.prototype[enumBugKeys[length]];return NullProtoObject()};hiddenKeys[IE_PROTO]=!0;var objectCreate=Object.create||function(O,Properties){var result;return null!==O?(EmptyConstructor.prototype=anObject(O),result=new EmptyConstructor,EmptyConstructor.prototype=null,result[IE_PROTO]=O):result=NullProtoObject(),void 0===Properties?result:objectDefineProperties(result,Properties)},UNSCOPABLES=wellKnownSymbol("unscopables"),ArrayPrototype=Array.prototype;null==ArrayPrototype[UNSCOPABLES]&&objectDefineProperty.f(ArrayPrototype,UNSCOPABLES,{configurable:!0,value:objectCreate(null)});var addToUnscopables=function(key){ArrayPrototype[UNSCOPABLES][key]=!0},iterators={},functionToString=Function.toString;"function"!=typeof sharedStore.inspectSource&&(sharedStore.inspectSource=function(it){return functionToString.call(it)});var set,get,has$1,inspectSource=sharedStore.inspectSource,WeakMap=global_1.WeakMap,nativeWeakMap="function"==typeof WeakMap&&/native code/.test(inspectSource(WeakMap)),WeakMap$1=global_1.WeakMap;if(nativeWeakMap){var store$1=new WeakMap$1,wmget=store$1.get,wmhas=store$1.has,wmset=store$1.set;set=function(it,metadata){return wmset.call(store$1,it,metadata),metadata},get=function(it){return wmget.call(store$1,it)||{}},has$1=function(it){return wmhas.call(store$1,it)}}else{var STATE=sharedKey("state");hiddenKeys[STATE]=!0,set=function(it,metadata){return createNonEnumerableProperty(it,STATE,metadata),metadata},get=function(it){return has(it,STATE)?it[STATE]:{}},has$1=function(it){return has(it,STATE)}}var IteratorPrototype,PrototypeOfArrayIteratorPrototype,arrayIterator,internalState={set:set,get:get,has:has$1,enforce:function(it){return has$1(it)?get(it):set(it,{})},getterFor:function(TYPE){return function(it){var state;if(!isObject(it)||(state=get(it)).type!==TYPE)throw TypeError("Incompatible receiver, "+TYPE+" required");return state}}},nativePropertyIsEnumerable={}.propertyIsEnumerable,getOwnPropertyDescriptor=Object.getOwnPropertyDescriptor,objectPropertyIsEnumerable={f:getOwnPropertyDescriptor&&!nativePropertyIsEnumerable.call({1:2},1)?function(V){var descriptor=getOwnPropertyDescriptor(this,V);return!!descriptor&&descriptor.enumerable}:nativePropertyIsEnumerable},nativeGetOwnPropertyDescriptor=Object.getOwnPropertyDescriptor,objectGetOwnPropertyDescriptor={f:descriptors?nativeGetOwnPropertyDescriptor:function(O,P){if(O=toIndexedObject(O),P=toPrimitive(P,!0),ie8DomDefine)try{return nativeGetOwnPropertyDescriptor(O,P)}catch(error){}if(has(O,P))return createPropertyDescriptor(!objectPropertyIsEnumerable.f.call(O,P),O[P])}},redefine=createCommonjsModule((function(module){var getInternalState=internalState.get,enforceInternalState=internalState.enforce,TEMPLATE=String(String).split("String");(module.exports=function(O,key,value,options){var unsafe=!!options&&!!options.unsafe,simple=!!options&&!!options.enumerable,noTargetGet=!!options&&!!options.noTargetGet;"function"==typeof value&&("string"!=typeof key||has(value,"name")||createNonEnumerableProperty(value,"name",key),enforceInternalState(value).source=TEMPLATE.join("string"==typeof key?key:"")),O!==global_1?(unsafe?!noTargetGet&&O[key]&&(simple=!0):delete O[key],simple?O[key]=value:createNonEnumerableProperty(O,key,value)):simple?O[key]=value:setGlobal(key,value)})(Function.prototype,"toString",(function(){return"function"==typeof this&&getInternalState(this).source||inspectSource(this)}))})),hiddenKeys$1=enumBugKeys.concat("length","prototype"),objectGetOwnPropertyNames={f:Object.getOwnPropertyNames||function(O){return objectKeysInternal(O,hiddenKeys$1)}},objectGetOwnPropertySymbols={f:Object.getOwnPropertySymbols},ownKeys=getBuiltIn("Reflect","ownKeys")||function(it){var keys=objectGetOwnPropertyNames.f(anObject(it)),getOwnPropertySymbols=objectGetOwnPropertySymbols.f;return getOwnPropertySymbols?keys.concat(getOwnPropertySymbols(it)):keys},copyConstructorProperties=function(target,source){for(var keys=ownKeys(source),defineProperty=objectDefineProperty.f,getOwnPropertyDescriptor=objectGetOwnPropertyDescriptor.f,i=0;i<keys.length;i++){var key=keys[i];has(target,key)||defineProperty(target,key,getOwnPropertyDescriptor(source,key))}},replacement=/#|\.prototype\./,isForced=function(feature,detection){var value=data[normalize(feature)];return value==POLYFILL||value!=NATIVE&&("function"==typeof detection?fails(detection):!!detection)},normalize=isForced.normalize=function(string){return String(string).replace(replacement,".").toLowerCase()},data=isForced.data={},NATIVE=isForced.NATIVE="N",POLYFILL=isForced.POLYFILL="P",isForced_1=isForced,getOwnPropertyDescriptor$1=objectGetOwnPropertyDescriptor.f,_export=function(options,source){var target,key,targetProperty,sourceProperty,descriptor,TARGET=options.target,GLOBAL=options.global,STATIC=options.stat;if(target=GLOBAL?global_1:STATIC?global_1[TARGET]||setGlobal(TARGET,{}):(global_1[TARGET]||{}).prototype)for(key in source){if(sourceProperty=source[key],targetProperty=options.noTargetGet?(descriptor=getOwnPropertyDescriptor$1(target,key))&&descriptor.value:target[key],!isForced_1(GLOBAL?key:TARGET+(STATIC?".":"#")+key,options.forced)&&void 0!==targetProperty){if(typeof sourceProperty==typeof targetProperty)continue;copyConstructorProperties(sourceProperty,targetProperty)}(options.sham||targetProperty&&targetProperty.sham)&&createNonEnumerableProperty(sourceProperty,"sham",!0),redefine(target,key,sourceProperty,options)}},correctPrototypeGetter=!fails((function(){function F(){}return F.prototype.constructor=null,Object.getPrototypeOf(new F)!==F.prototype})),IE_PROTO$1=sharedKey("IE_PROTO"),ObjectPrototype=Object.prototype,objectGetPrototypeOf=correctPrototypeGetter?Object.getPrototypeOf:function(O){return O=Object(requireObjectCoercible(O)),has(O,IE_PROTO$1)?O[IE_PROTO$1]:"function"==typeof O.constructor&&O instanceof O.constructor?O.constructor.prototype:O instanceof Object?ObjectPrototype:null},ITERATOR=wellKnownSymbol("iterator"),BUGGY_SAFARI_ITERATORS=!1;[].keys&&("next"in(arrayIterator=[].keys())?(PrototypeOfArrayIteratorPrototype=objectGetPrototypeOf(objectGetPrototypeOf(arrayIterator)))!==Object.prototype&&(IteratorPrototype=PrototypeOfArrayIteratorPrototype):BUGGY_SAFARI_ITERATORS=!0),null==IteratorPrototype&&(IteratorPrototype={}),has(IteratorPrototype,ITERATOR)||createNonEnumerableProperty(IteratorPrototype,ITERATOR,(function(){return this}));var iteratorsCore={IteratorPrototype:IteratorPrototype,BUGGY_SAFARI_ITERATORS:BUGGY_SAFARI_ITERATORS},defineProperty=objectDefineProperty.f,TO_STRING_TAG=wellKnownSymbol("toStringTag"),setToStringTag=function(it,TAG,STATIC){it&&!has(it=STATIC?it:it.prototype,TO_STRING_TAG)&&defineProperty(it,TO_STRING_TAG,{configurable:!0,value:TAG})},IteratorPrototype$1=iteratorsCore.IteratorPrototype,returnThis$1=function(){return this},objectSetPrototypeOf=Object.setPrototypeOf||("__proto__"in{}?function(){var setter,CORRECT_SETTER=!1,test={};try{(setter=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(test,[]),CORRECT_SETTER=test instanceof Array}catch(error){}return function(O,proto){return anObject(O),function(it){if(!isObject(it)&&null!==it)throw TypeError("Can't set "+String(it)+" as a prototype")}(proto),CORRECT_SETTER?setter.call(O,proto):O.__proto__=proto,O}}():void 0),IteratorPrototype$2=iteratorsCore.IteratorPrototype,BUGGY_SAFARI_ITERATORS$1=iteratorsCore.BUGGY_SAFARI_ITERATORS,ITERATOR$1=wellKnownSymbol("iterator"),returnThis$2=function(){return this},setInternalState=internalState.set,getInternalState=internalState.getterFor("Array Iterator");!function(Iterable,NAME,IteratorConstructor,next,DEFAULT,IS_SET,FORCED){!function(IteratorConstructor,NAME,next){var TO_STRING_TAG=NAME+" Iterator";IteratorConstructor.prototype=objectCreate(IteratorPrototype$1,{next:createPropertyDescriptor(1,next)}),setToStringTag(IteratorConstructor,TO_STRING_TAG,!1),iterators[TO_STRING_TAG]=returnThis$1}(IteratorConstructor,NAME,next);var CurrentIteratorPrototype,methods,KEY,getIterationMethod=function(KIND){if(KIND===DEFAULT&&defaultIterator)return defaultIterator;if(!BUGGY_SAFARI_ITERATORS$1&&KIND in IterablePrototype)return IterablePrototype[KIND];switch(KIND){case"keys":case"values":case"entries":return function(){return new IteratorConstructor(this,KIND)}}return function(){return new IteratorConstructor(this)}},TO_STRING_TAG=NAME+" Iterator",INCORRECT_VALUES_NAME=!1,IterablePrototype=Iterable.prototype,nativeIterator=IterablePrototype[ITERATOR$1]||IterablePrototype["@@iterator"]||DEFAULT&&IterablePrototype[DEFAULT],defaultIterator=!BUGGY_SAFARI_ITERATORS$1&&nativeIterator||getIterationMethod(DEFAULT),anyNativeIterator="Array"==NAME&&IterablePrototype.entries||nativeIterator;if(anyNativeIterator&&(CurrentIteratorPrototype=objectGetPrototypeOf(anyNativeIterator.call(new Iterable)),IteratorPrototype$2!==Object.prototype&&CurrentIteratorPrototype.next&&(objectGetPrototypeOf(CurrentIteratorPrototype)!==IteratorPrototype$2&&(objectSetPrototypeOf?objectSetPrototypeOf(CurrentIteratorPrototype,IteratorPrototype$2):"function"!=typeof CurrentIteratorPrototype[ITERATOR$1]&&createNonEnumerableProperty(CurrentIteratorPrototype,ITERATOR$1,returnThis$2)),setToStringTag(CurrentIteratorPrototype,TO_STRING_TAG,!0))),"values"==DEFAULT&&nativeIterator&&"values"!==nativeIterator.name&&(INCORRECT_VALUES_NAME=!0,defaultIterator=function(){return nativeIterator.call(this)}),IterablePrototype[ITERATOR$1]!==defaultIterator&&createNonEnumerableProperty(IterablePrototype,ITERATOR$1,defaultIterator),iterators[NAME]=defaultIterator,DEFAULT)if(methods={values:getIterationMethod("values"),keys:IS_SET?defaultIterator:getIterationMethod("keys"),entries:getIterationMethod("entries")},FORCED)for(KEY in methods)(BUGGY_SAFARI_ITERATORS$1||INCORRECT_VALUES_NAME||!(KEY in IterablePrototype))&&redefine(IterablePrototype,KEY,methods[KEY]);else _export({target:NAME,proto:!0,forced:BUGGY_SAFARI_ITERATORS$1||INCORRECT_VALUES_NAME},methods)}(Array,"Array",(function(iterated,kind){setInternalState(this,{type:"Array Iterator",target:toIndexedObject(iterated),index:0,kind:kind})}),(function(){var state=getInternalState(this),target=state.target,kind=state.kind,index=state.index++;return!target||index>=target.length?(state.target=void 0,{value:void 0,done:!0}):"keys"==kind?{value:index,done:!1}:"values"==kind?{value:target[index],done:!1}:{value:[index,target[index]],done:!1}}),"values");iterators.Arguments=iterators.Array,addToUnscopables("keys"),addToUnscopables("values"),addToUnscopables("entries");var ITERATOR$2=wellKnownSymbol("iterator"),ArrayPrototype$1=Array.prototype,functionBindContext=function(fn,that,length){if(function(it){if("function"!=typeof it)throw TypeError(String(it)+" is not a function")}(fn),void 0===that)return fn;switch(length){case 0:return function(){return fn.call(that)};case 1:return function(a){return fn.call(that,a)};case 2:return function(a,b){return fn.call(that,a,b)};case 3:return function(a,b,c){return fn.call(that,a,b,c)}}return function(){return fn.apply(that,arguments)}},test={};test[wellKnownSymbol("toStringTag")]="z";var toStringTagSupport="[object z]"===String(test),TO_STRING_TAG$2=wellKnownSymbol("toStringTag"),CORRECT_ARGUMENTS="Arguments"==classofRaw(function(){return arguments}()),classof=toStringTagSupport?classofRaw:function(it){var O,tag,result;return void 0===it?"Undefined":null===it?"Null":"string"==typeof(tag=function(it,key){try{return it[key]}catch(error){}}(O=Object(it),TO_STRING_TAG$2))?tag:CORRECT_ARGUMENTS?classofRaw(O):"Object"==(result=classofRaw(O))&&"function"==typeof O.callee?"Arguments":result},ITERATOR$3=wellKnownSymbol("iterator"),callWithSafeIterationClosing=function(iterator,fn,value,ENTRIES){try{return ENTRIES?fn(anObject(value)[0],value[1]):fn(value)}catch(error){var returnMethod=iterator.return;throw void 0!==returnMethod&&anObject(returnMethod.call(iterator)),error}},iterate_1=createCommonjsModule((function(module){var Result=function(stopped,result){this.stopped=stopped,this.result=result};(module.exports=function(iterable,fn,that,AS_ENTRIES,IS_ITERATOR){var iterator,iterFn,index,length,result,next,step,it,boundFunction=functionBindContext(fn,that,AS_ENTRIES?2:1);if(IS_ITERATOR)iterator=iterable;else{if("function"!=typeof(iterFn=function(it){if(null!=it)return it[ITERATOR$3]||it["@@iterator"]||iterators[classof(it)]}(iterable)))throw TypeError("Target is not iterable");if(void 0!==(it=iterFn)&&(iterators.Array===it||ArrayPrototype$1[ITERATOR$2]===it)){for(index=0,length=toLength(iterable.length);length>index;index++)if((result=AS_ENTRIES?boundFunction(anObject(step=iterable[index])[0],step[1]):boundFunction(iterable[index]))&&result instanceof Result)return result;return new Result(!1)}iterator=iterFn.call(iterable)}for(next=iterator.next;!(step=next.call(iterator)).done;)if("object"==typeof(result=callWithSafeIterationClosing(iterator,boundFunction,step.value,AS_ENTRIES))&&result&&result instanceof Result)return result;return new Result(!1)}).stop=function(result){return new Result(!0,result)}}));_export({target:"Object",stat:!0},{fromEntries:function(iterable){var obj={};return iterate_1(iterable,(function(k,v){var object,value,propertyKey;object=obj,value=v,(propertyKey=toPrimitive(k))in object?objectDefineProperty.f(object,propertyKey,createPropertyDescriptor(0,value)):object[propertyKey]=value}),void 0,!0),obj}});path.Object.fromEntries;const typeCache=new Map;function asPluginWidgets(componentMap){const result={};return Object.keys(componentMap).forEach(key=>{result["$"+key]=asPluginWidget(componentMap[key])}),result}function asPluginWidget(WrappedComponent){const cachedResult=typeCache.get(WrappedComponent);if(void 0!==cachedResult)return cachedResult;const componentName=friendlyName(WrappedComponent),uncachedComponent=function(WrappedComponent,componentName){const MemoisedComponent=memo(function(component,componentName){var _a;if(null===(_a=component.prototype)||void 0===_a?void 0:_a.isReactComponent){const FunctionalWrapper=props=>createElement(component,props);return FunctionalWrapper.displayName=componentName,FunctionalWrapper}return component.displayName=componentName,component}(WrappedComponent,componentName));return wrapperProps=>{const[correctWidgetId]=useState(()=>wrapperProps.$widgetId);if(wrapperProps.$widgetId!==correctWidgetId)throw new AssertionError(`Parent of component ${componentName} did not correctly assign keys.`);const store=useComponentStore();let computedProps;const[onAfterUpdates]=useState([]);let disposer;if(useIsFirstRender()){const propsComputation=mapWrapperProps(wrapperProps,store,wrapperProps.$widgetId,"",onAfterUpdates);if(isMobxComputed(propsComputation)){const[formSuspended$]=store.useSlot(pageScope,"formSuspended"),joinedComputation=computed(()=>({props:propsComputation.get(),suspended:formSuspended$.dependOn()}),{name:"Props of "+wrapperProps.$widgetId}),[,setComputedProps]=useState(()=>{let firstRun=!0;return disposer=autorun(()=>{const{props:props,suspended:suspended}=joinedComputation.get();firstRun?computedProps=props:suspended||setComputedProps(props)},{name:"Flush props of "+wrapperProps.$widgetId}),firstRun=!1,computedProps})}else computedProps=useState(propsComputation)[0]}else computedProps=useState({})[0];return useLayoutEffect(()=>disposer,[]),onAfterUpdates.length&&useLayoutEffect(()=>onAfterUpdates.forEach(l=>l()),[computedProps]),createElement(MemoisedComponent,computedProps)}}(WrappedComponent,componentName);return uncachedComponent.displayName=`pluginWidget(${componentName})`,typeCache.set(WrappedComponent,uncachedComponent),uncachedComponent}function mapWrapperProps(value,store,widgetId,propPath,collectedOnAfterUpdate){const plainResult={},computedResult={};for(const k of Object.keys(value)){if("$widgetId"===k){plainResult.name=toWidgetName(widgetId);continue}const mappedItem=mapWrapperProp(value[k],store,widgetId,`${propPath}/${k}`,collectedOnAfterUpdate);isMobxComputed(mappedItem)?computedResult[k]=mappedItem:plainResult[k]=mappedItem}return Object.keys(computedResult).length?computed(()=>Object.assign(Object.assign({},plainResult),mapValues(computedResult,v=>v.get()))):plainResult}function mapWrapperProp(value,store,widgetId,propPath,collectedOnAfterUpdate){if(isComputationResult(value))return toValue(value);if(isComputation(value)){const[evaluation,onAfterUpdate]=toEvaluation(value,store,widgetId,propPath);return onAfterUpdate&&collectedOnAfterUpdate.push(onAfterUpdate),computed(evaluation,{name:`Prop ${propPath} of ${widgetId}`})}if(Array.isArray(value)){const mappedItems=[];let hasComputed=!1;for(let i=0;i<value.length;++i){const mappedItem=mapWrapperProp(value[i],store,widgetId,`${propPath}/${i}`,collectedOnAfterUpdate);mappedItems[i]=mappedItem,hasComputed=hasComputed||isMobxComputed(mappedItem)}return hasComputed?computed(()=>mappedItems.map(item=>isMobxComputed(item)?item.get():item)):mappedItems}return!isValidElement(value)&&isJson(value)?mapWrapperProps(value,store,widgetId,propPath,collectedOnAfterUpdate):value}function isMobxComputed(x){return isComputed(x)}class NotImplementedError extends Error{constructor(what=""){super("Not implemented"+(""!==what?": "+what:"")),Object.setPrototypeOf(this,NotImplementedError.prototype)}}function parse(stackString){return stackString.split("\n").reduce((function(stack,line){var parseResult=function(line){var parts=chromeRe.exec(line);if(!parts)return null;var isNative=parts[2]&&0===parts[2].indexOf("native"),isEval=parts[2]&&0===parts[2].indexOf("eval"),submatch=chromeEvalRe.exec(parts[2]);isEval&&null!=submatch&&(parts[2]=submatch[1],parts[3]=submatch[2],parts[4]=submatch[3]);return{file:isNative?null:parts[2],methodName:parts[1]||"<unknown>",arguments:isNative?[parts[2]]:[],lineNumber:parts[3]?+parts[3]:null,column:parts[4]?+parts[4]:null}}(line)||function(line){var parts=winjsRe.exec(line);if(!parts)return null;return{file:parts[2],methodName:parts[1]||"<unknown>",arguments:[],lineNumber:+parts[3],column:parts[4]?+parts[4]:null}}(line)||function(line){var parts=geckoRe.exec(line);if(!parts)return null;var isEval=parts[3]&&parts[3].indexOf(" > eval")>-1,submatch=geckoEvalRe.exec(parts[3]);isEval&&null!=submatch&&(parts[3]=submatch[1],parts[4]=submatch[2],parts[5]=null);return{file:parts[3],methodName:parts[1]||"<unknown>",arguments:parts[2]?parts[2].split(","):[],lineNumber:parts[4]?+parts[4]:null,column:parts[5]?+parts[5]:null}}(line)||function(line){var parts=nodeRe.exec(line);if(!parts)return null;return{file:parts[2],methodName:parts[1]||"<unknown>",arguments:[],lineNumber:+parts[3],column:parts[4]?+parts[4]:null}}(line)||function(line){var parts=javaScriptCoreRe.exec(line);if(!parts)return null;return{file:parts[3],methodName:parts[1]||"<unknown>",arguments:[],lineNumber:+parts[4],column:parts[5]?+parts[5]:null}}(line);return parseResult&&stack.push(parseResult),stack}),[])}var chromeRe=/^\s*at (.*?) ?\(((?:file|https?|blob|chrome-extension|native|eval|webpack|<anonymous>|\/|[a-z]:\\|\\\\).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,chromeEvalRe=/\((\S*)(?::(\d+))(?::(\d+))\)/;var winjsRe=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i;var geckoRe=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|webpack|resource|\[native).*?|[^@]*bundle)(?::(\d+))?(?::(\d+))?\s*$/i,geckoEvalRe=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i;var javaScriptCoreRe=/^\s*(?:([^@]*)(?:\((.*?)\))?@)?(\S.*?):(\d+)(?::(\d+))?\s*$/i;var nodeRe=/^\s*at (?:((?:\[object object\])?[^\\/]+(?: \[as \S+\])?) )?\(?(.*?):(\d+)(?::(\d+))?\)?\s*$/i;class ConnectionError extends Error{constructor(message){super(message),Object.setPrototypeOf(this,ConnectionError.prototype)}}class ServerError extends Error{constructor(status,message){super(message),this.status=status,Object.setPrototypeOf(this,ServerError.prototype)}}class SynchronizationError extends Error{constructor(message="Could temporarily not synchronize data. Please try again later."){super(message),Object.setPrototypeOf(this,SynchronizationError.prototype)}}function errorHandler(e){if(void 0===mx)return void NativeModules.NativeErrorHandler.handle(e.message,void 0!==e.stack?parse(e.stack):[]);mx.logger.error(e.message,e.stack);const{type:type,content:content}=function(e){switch(!0){case e instanceof DescribedError:case e instanceof DescribedServerError:return{type:"error",content:e.message};case e instanceof ConnectionError:return{type:"error",content:translate("mxui.sys.UI","connection_error")};case e instanceof SynchronizationError:return{type:"info",content:translate("mxui.sys.UI","sync_error")};case e instanceof ServerError:return{type:"error",content:402===e.status?translate("mendix.signin","http402"):translate("mxui.sys.UI","internal_error")};default:return{type:"error",content:translate("mxui.sys.UI","internal_error")}}}(e);mx.ui.showMessage(type,content,!0)}class LabeledGraph{constructor(){this.__labels=[],this.__labelMap={},this.__graph=[]}addEdge(fromLabel,toLabel){const fromIdx=this._getOrCreateLabelIndex(fromLabel),toIdx=this._getOrCreateLabelIndex(toLabel),destinationIndices=this.__graph[fromIdx];destinationIndices.includes(toIdx)||destinationIndices.push(toIdx)}neighborsOf(label){const idx=this._getOrCreateLabelIndex(label);return this.__graph[idx].map(this._indexToLabel,this)}reachableLabels(sourceLabels){const sourceIndices=sourceLabels.map(this._getOrCreateLabelIndex,this);var graph,start,visited;return(graph=this.__graph,start=sourceIndices,visited=new Array(graph.length),function visitEdges(edges){for(var i=0;i<edges.length;++i){var idx=edges[i];if(idx<0||idx>=visited.length)throw new Error("graph: index "+idx+" out of bounds in graph of size "+graph.length);visited[idx]||(visited[idx]=!0,visitEdges(graph[idx]))}}(start),function(){for(var result=[],i=0;i<visited.length;++i)visited[i]&&result.push(i);return result}()).map(this._indexToLabel,this)}_indexToLabel(idx){return this.__labels[idx]}_getOrCreateLabelIndex(label){let idx=label in this.__labelMap?this.__labelMap[label]:-1;return-1===idx&&(this.__labels.push(label),this.__graph.push([]),idx=this.__labels.length-1,this.__labelMap[label]=idx),idx}}function findReachableGuidsToRetain(mxobjs,rootGuids){return function(mxobjs,rootGuids){const objectMap=getObjectMap(mxobjs=mxobjs.filter(mxobj=>!mxobj.isPersistable()||mxobj.hasChanges()||mxobj.isNew()));return createGraph(getAllAssociations(mxobjs).filter(({from:from,to:to})=>isRetained(from)&&isRetained(to)));function isRetained(guid){return rootGuids.includes(guid)||guid in objectMap}}(mxobjs,rootGuids).reachableLabels(rootGuids)}function findReachableGuidsForRequest(mxobjs,rootGuids,associationsToFollow){const objectMap=getObjectMap(mxobjs);return createGraph(null!=associationsToFollow?function(mxobjs,associationsToFollow){const associations=[];return mxobjs.forEach(mxobj=>{associationsToFollow.forEach(asf=>{if(!mxobj.has(asf.association))return;const associationOwner=window.mx.meta.getAttributeOwner(mxobj.getEntity(),asf.association),selectorEntity=mxobj.getSelectorEntity(asf.association);asf.fromEntity===associationOwner&&getAllReferences(mxobj,asf.association).forEach(refGuid=>associations.push({from:mxobj.getGuid(),to:refGuid})),asf.fromEntity===selectorEntity&&getAllReferences(mxobj,asf.association).forEach(refGuid=>associations.push({from:refGuid,to:mxobj.getGuid()}))})}),associations}(mxobjs,associationsToFollow):getAllAssociations(mxobjs)).reachableLabels(rootGuids).filter(l=>objectMap[l])}function getAllAssociations(mxobjs){const associations=[];return mxobjs.forEach(mxobj=>{mxobj.getReferenceAttributes().filter(association=>{return!("System.owner"===(attr=association)||"System.changedBy"===attr);var attr}).forEach(association=>{getAllReferences(mxobj,association).forEach(refGuid=>associations.push({from:refGuid,to:mxobj.getGuid()},{from:mxobj.getGuid(),to:refGuid}))})}),associations}function getAllReferences(mxobj,attr){return mxobj.getReferences(attr).concat(mxobj.getOriginalReferences(attr))}function createGraph(associations){const labeledGraph=new LabeledGraph;return associations.forEach(({from:from,to:to})=>labeledGraph.addEdge(from,to)),labeledGraph}function getObjectMap(mxobjs){const objectMap={};return mxobjs.forEach(mxobj=>{objectMap[mxobj.getGuid()]=mxobj}),objectMap}let idCounter=0;class MxContext{constructor(kwArgs){this.id=this.ident=++idCounter,this.trackId="",this.trackEntity="",this.trackObject=null,this.localParams={},this.constraintby=[],this._entityToGuid={},this._mxidToObject={},kwArgs&&(kwArgs.mxcontext&&this.dupFrom(kwArgs.mxcontext),kwArgs.classname&&kwArgs.mendixguid?this.setContext(kwArgs.classname,kwArgs.mendixguid):kwArgs.entity&&kwArgs.guid&&this.setContext(kwArgs.entity,kwArgs.guid))}hasTrackEntity(){return""!==this.trackEntity}hasTrackId(){return!!this.trackId}hasTrackObject(){return!!this.trackObject}getTrackEntity(){return this.trackEntity}getTrackId(){return this.trackId}getTrackObject(){return this.trackObject}setTrackObject(obj){obj&&this.setContext(obj.getEntity(),obj.getGuid()),this.trackObject=obj}getObject(){return this.trackObject}setConstraints(constraints){null!=constraints&&""!==constraints&&0!==constraints.length&&(this.constraintby="string"==typeof constraints?constraints.split(","):constraints)}getConstraints(){for(var t=[],i=0;i<this.constraintby.length;i++)t.push(this.constraintby[i]);return t}hasBacktrack(){return 0!==this.constraintby.length}getEntities(){return Object.keys(this._entityToGuid).filter(e=>void 0!==e&&""!==this._entityToGuid[e])}setContext(entity,guid){if(1===arguments.length&&arguments[0]instanceof MxObject){var mxobj=arguments[0];entity=mxobj.getEntity(),guid=mxobj.getGuid()}this.trackEntity=null==entity?"":entity,this.trackId=null==guid?"":guid,this.trackObject=null,this._entityToGuid[this.trackEntity]=this.trackId}unsetContext(entity){if("string"!=typeof entity)throw new Error("mendix/lib/MxContext.unsetContext: parameter entity is not of type String");delete this._entityToGuid[entity]}getContext(entity){if("string"!=typeof entity)throw new Error("mendix/lib/MxContext.getContext: parameter entity is not of type String");if(entity in this._entityToGuid)return this._entityToGuid[entity];var meta=window.mx.meta.getEntity(entity),result=null;return meta.getSubEntities().some(subEntity=>subEntity in this._entityToGuid&&(result=this._entityToGuid[subEntity],!0)),result}hasContext(entity){if("string"!=typeof entity)throw new Error("mendix/lib/MxContext.hasContext: parameter entity is not of type String");return null!=this.getContext(entity)}reset(){this._entityToGuid={},this._mxidToObject={},this.trackId=null,this.trackEntity="",this.trackObject=null}dupFrom(context){this.reset(),this.mixin(context)}mixin(context){if(context)context.getEntities().forEach(e=>this.setContext(e,context.getContext(e))),context.getWidgetIds().forEach(mxid=>this.setWidgetObject(mxid,context.getWidgetObject(mxid))),this.setParams(context.getParams()),this.setConstraints(context.getConstraints()),this.setContext(context.getTrackEntity(),context.getTrackId()),this.setTrackObject(context.getTrackObject());else{const entity=this.getTrackEntity();entity&&this.unsetContext(entity),this.setContext(null,null)}}hasParam(key){return key in this.localParams}getParam(key){return this.hasParam(key)?this.localParams[key]:null}getParams(){return this.localParams}setParam(key,value){if(null==key)throw new Error("mendix/lib/MxContext["+this.ident+"].setParam key is null");this.localParams[key]=value}setParams(obj){if("object"!=typeof obj)throw new Error("mendix/lib/MxContext["+this.ident+"].setParams requires an Object.");for(var i in obj)this.localParams[i]=obj[i]}unsetParam(key){delete this.localParams[key]}resetParams(){this.localParams={}}isEmpty(){for(var j in this._entityToGuid)return!0;return!1}getGuids(){for(var contexts=this.getEntities(),trackId=this.getTrackId(),contextIds=trackId?[trackId]:[],i=0,l=contexts.length;i<l;i++){var c=contexts[i];if("System.owner"!==c&&"System.changedBy"!==c){var guid=this.getContext(c);guid!==trackId&&contextIds.push(guid)}}return contextIds}getWidgetIds(){return Object.keys(this._mxidToObject)}getWidgetObject(widgetId){return this._mxidToObject[widgetId]}setWidgetObject(widgetId,object){this.setTrackObject(object),this._mxidToObject[widgetId]=object}getWidgetObjectMap(){return clone$1(this._mxidToObject)}freeze(){this.setTrackObject=this.setConstraints=this.setContext=this.unsetContext=this.reset=this.dupFrom=this.setParam=this.setParams=this.unsetParam=this.setWidgetObject=this.resetParams=function(){return window.mx.logger.error("mendix/lib/MxContext["+this.ident+"].freeze: context is readonly"),!1}}}function StringSet(values){for(var m in this.__values={},values)this.__values[m+""]=!0}async function executeNoImpactInstructions(instructions){for(const instruction of null!=instructions?instructions:[])switch(instruction.type){case"logout":mx.logout();break;case"show_login":mx.ui.showLogin();break;case"download_file":const obj=await getByGuid(instruction.args.FileDocumentGuid);mx.ui.downloadFile({mxobject:ensure(obj),target:instruction.args.Target});break;case"text_message":mx.ui.showMessage(instruction.args.MessageType,instruction.args.MessageContent,instruction.args.MessageBlock)}}async function getByGuid(guid){return new Promise((resolve,reject)=>mx.data.get({guid:guid,callback:resolve,error:reject}))}function gatherUpdates(objectCache,json){var _a,_b,_c,_d,_e,_f;const changedAttrs=Object.entries(null!==(_a=json.changes)&&void 0!==_a?_a:{}).map(([guid,objChanges])=>Object.keys(objChanges).map(attr=>({guid:guid,attr:attr}))),resetAttrs=Object.entries(null!==(_b=json.resets)&&void 0!==_b?_b:{}).map(([guid,attributes])=>attributes.map(attr=>({guid:guid,attr:attr}))),attrsChangedByObjects=(null!==(_c=json.objects)&&void 0!==_c?_c:[]).map(objectJson=>{const obj=objectCache.getObject(objectJson.guid);return null!==obj?function(cachedObj,incomingJson){const meta=mx.meta.getEntity(incomingJson.objectType),incomingObj=MxObject.fromJson(incomingJson);return meta.getAttributes().filter(attr=>!function(lhsObj,rhsObj,attr){if(lhsObj.isReadonlyAttr(attr)!==rhsObj.isReadonlyAttr(attr))return!1;if(lhsObj.isReference(attr)){if("System.changedBy"===attr||"System.owner"===attr)return!0;const lhsRefStr=lhsObj.getOriginalReferences(attr).sort((a,b)=>a.localeCompare(b)).join(","),rhsRefStr=rhsObj.getOriginalReferences(attr).sort((a,b)=>a.localeCompare(b)).join(",");return lhsRefStr===rhsRefStr}const lhsValue=lhsObj.getOriginalValue(attr),rhsValue=rhsObj.getOriginalValue(attr);return lhsValue===rhsValue||null!==lhsValue&&null!==rhsValue&&lhsValue.valueOf&&rhsValue.valueOf&&lhsValue.valueOf()===rhsValue.valueOf()}(cachedObj,incomingObj,attr))}(obj,objectJson).map(attr=>({guid:objectJson.guid,attr:attr})):[]}),refreshedGuids=unique(concat((null!==(_d=json.instructions)&&void 0!==_d?_d:[]).map(getRefreshGuids)).concat(null!==(_e=json.deletes)&&void 0!==_e?_e:[]));return[...uniqueBy(concat([...changedAttrs,...resetAttrs,...attrsChangedByObjects]),x=>`${x.guid}:${x.attr}`).map(({guid:guid,attr:attr})=>({guid:guid,attr:attr})).filter(({guid:guid})=>!refreshedGuids.includes(guid)&&objectCache.has(guid)),...refreshedGuids.filter(guid=>objectCache.has(guid)).map(guid=>({guid:guid})),...unique(concat((null!==(_f=json.instructions)&&void 0!==_f?_f:[]).map(i=>"refresh_class"===i.type?i.args.classnames:[]))).map(entity=>({entity:entity}))]}function getRefreshGuids(i){return"refresh_object_list"===i.type?i.args.ObjectIds:[]}StringSet.of=StringSet.prototype.of=function(x){return StringSet.fromArray([x])},StringSet.fromArray=function(values){for(var result={},i=0;i<values.length;++i)result[values[i]]=!0;return new StringSet(result)},StringSet.empty=StringSet.prototype.empty=function(){return StringSet.fromArray([])},StringSet.prototype.contains=function(test){return this.__values[test]||!1},StringSet.prototype.union=StringSet.prototype.concat=function(other){var result={};for(var m in this.__values)result[m]=!0;for(var n in other.__values)result[n]=!0;return new StringSet(result)},StringSet.prototype.intersection=function(other){var result={};for(var m in this.__values)other.contains(m)&&(result[m]=!0);return new StringSet(result)},StringSet.prototype.difference=function(other){var result={};for(var m in this.__values)other.contains(m)||(result[m]=!0);return new StringSet(result)},StringSet.prototype.length=function(){return this.values().length},StringSet.prototype.reduce=function(fn,acc){return this.values().reduce(fn,acc)},StringSet.prototype.chain=function(fn){return this.reduce((function(acc,x){return acc.concat(fn(x))}),this.empty())},StringSet.prototype.map=function(fn){return this.chain(function(x){return this.of(fn(x))}.bind(this))},StringSet.prototype.values=function(){return Object.keys(this.__values)},StringSet.prototype.toString=function(){return"StringSet("+this.values()+")"};var getOwnPropertySymbols=Object.getOwnPropertySymbols,hasOwnProperty$1=Object.prototype.hasOwnProperty,propIsEnumerable=Object.prototype.propertyIsEnumerable;
/*
object-assign
(c) Sindre Sorhus
@license MIT
*/function toObject$1(val){if(null==val)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(val)}var objectAssign=function(){try{if(!Object.assign)return!1;var test1=new String("abc");if(test1[5]="de","5"===Object.getOwnPropertyNames(test1)[0])return!1;for(var test2={},i=0;i<10;i++)test2["_"+String.fromCharCode(i)]=i;if("0123456789"!==Object.getOwnPropertyNames(test2).map((function(n){return test2[n]})).join(""))return!1;var test3={};return"abcdefghijklmnopqrst".split("").forEach((function(letter){test3[letter]=letter})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},test3)).join("")}catch(err){return!1}}()?Object.assign:function(target,source){for(var from,symbols,to=toObject$1(target),s=1;s<arguments.length;s++){for(var key in from=Object(arguments[s]))hasOwnProperty$1.call(from,key)&&(to[key]=from[key]);if(getOwnPropertySymbols){symbols=getOwnPropertySymbols(from);for(var i=0;i<symbols.length;i++)propIsEnumerable.call(from,symbols[i])&&(to[symbols[i]]=from[symbols[i]])}}return to};function encode(value,opts){return opts.encode?opts.strict?encodeURIComponent(value).replace(/[!'()*]/g,(function(c){return"%"+c.charCodeAt(0).toString(16).toUpperCase()})):encodeURIComponent(value):value}var stringify=function(obj,opts){!1===(opts=objectAssign({encode:!0,strict:!0,arrayFormat:"none"},opts)).sort&&(opts.sort=function(){});var formatter=function(opts){switch(opts.arrayFormat){case"index":return function(key,value,index){return null===value?[encode(key,opts),"[",index,"]"].join(""):[encode(key,opts),"[",encode(index,opts),"]=",encode(value,opts)].join("")};case"bracket":return function(key,value){return null===value?encode(key,opts):[encode(key,opts),"[]=",encode(value,opts)].join("")};default:return function(key,value){return null===value?encode(key,opts):[encode(key,opts),"=",encode(value,opts)].join("")}}}(opts);return obj?Object.keys(obj).sort(opts.sort).map((function(key){var val=obj[key];if(void 0===val)return"";if(null===val)return encode(key,opts);if(Array.isArray(val)){var result=[];return val.slice().forEach((function(val2){void 0!==val2&&result.push(formatter(key,val2,result.length))})),result.join("&")}return encode(key,opts)+"="+encode(val,opts)})).filter((function(x){return x.length>0})).join("&"):""};const middlewares=[];function registerMiddleware(middleware){middlewares.push(middleware)}async function applyMiddleware(request,actual){return async function doProcess(index,req){if(index===middlewares.length)return actual(req);return middlewares[index](req,r=>doProcess(index+1,r))}(0,request)}class UnauthorizedError extends ServerError{constructor(status){super(status),Object.setPrototypeOf(this,UnauthorizedError.prototype)}}async function post(url,data){const request={url:url,body:data,init:{method:"post",headers:new Headers(Object.assign({Accept:"application/json"},isJson(data)?{"Content-Type":"application/json"}:{})),redirect:"error",credentials:"include"}};return(await applyMiddleware(request,doFetch)).json()}async function doFetch(request){if(request.init.body)throw new AssertionError;let response;request.init.body=isJson(request.body)?JSON.stringify(request.body):request.body;try{response=await window.fetch(request.url,request.init)}catch(e){throw new ConnectionError(e.message)}switch(response.status){case 200:return response;case 400:case 401:case 402:case 403:case 460:throw new UnauthorizedError(response.status);case 502:case 504:throw new ServerError(response.status,response.statusText);case 551:throw new ValidationError(await response.json());case 560:const description=await getXasErrorDescription(response);throw description?new DescribedServerError(description):new ServerError(response.status);case 12029:throw new ConnectionError("No connection");default:throw new ServerError(response.status,await getXasErrorDescription(response))}}async function getXasErrorDescription(response){const json=await response.json();return json&&"description"in json?json.description:void 0}async function retrieveByIds(guids,schema){return post(xasUrl(),{action:"retrieve_by_ids",params:{ids:guids,schema:schema}})}async function getSessionData(params){return post(xasUrl(),{action:"get_session_data",params:params})}async function upload(guid,name,params,blob,changes,objects){const url=mx.remoteUrl+"file?"+stringify(Object.assign(Object.assign({},params),{guid:guid})),formData=new FormData;return formData.append("data",JSON.stringify({changes:changes,objects:objects})),name?formData.append("blob",blob,name):formData.append("blob",blob),post(url,formData)}function xasUrl(){return mx.remoteUrl+"xas/"}var DayOfWeek;async function handleRuntimeSuccess(objectCache,json,targetForm){const updates=gatherUpdates(objectCache,json);await handleState(objectCache,json),function(instructions,targetForm){if((null!=instructions?instructions:[]).some(i=>"close"===i.type)){const form=ensure(targetForm);form.setSuspend(!0),form.close(()=>{form.setSuspend(!1)},e=>{form.setSuspend(!1),mx.onError(e)})}}(json.instructions,targetForm),await publish(...updates),await async function(instructions,targetForm){const openFormPromises=[];for(const instruction of null!=instructions?instructions:[])"open_form"===instruction.type&&openFormPromises.push(mx.ui.openForm2(instruction.args.FormPath,instruction.args.FormGuid,instruction.args.FormTitle,targetForm,{location:instruction.args.FormTarget,width:instruction.args.FormWidth,height:instruction.args.FormHeight,resizable:instruction.args.FormResizable}));await Promise.all(openFormPromises)}(json.instructions,targetForm),await executeNoImpactInstructions(json.instructions),handleValidations(json.datavalidation)}async function handleState(objectCache,{objects:objects=[],changes:changes={},newpersistable:newpersistable=[],commits:commits=[],deletes:deletes=[],resets:resets={},committedObjectsOmitted:committedObjectsOmitted=!1}){objectCache.removeChanges(resets),objectCache.addChanges(changes);const creates=objects.filter(objJson=>{return jsonObj=objJson,!objectCache.has(jsonObj.guid);var jsonObj}).filter(objJson=>{return jsonObj=objJson,mx.meta.getEntity(jsonObj.objectType).isPersistable()?newpersistable.includes(objJson.guid):!commits.includes(objJson.guid);var jsonObj}).map(obj=>obj.guid);if(objectCache.onCreate(creates),objectCache.onDelete(deletes),objectCache.onCommit(commits),objectCache.setMxObjects(objects),committedObjectsOmitted){const committedGuidsInStaleCache=commits.filter(guid=>objectCache.has(guid)&&!objects.some(obj=>obj.guid===guid));if(committedGuidsInStaleCache.length>0){const json=await retrieveByIds(committedGuidsInStaleCache,{});await handleRuntimeSuccess(objectCache,json)}}}function handleValidations(datavalidations,onValidation){const validations=ObjectValidation.fromResponse(null!=datavalidations?datavalidations:[]);mx.data.sendValidationUpdates(validations),validations.length>0&&onValidation&&onValidation(validations)}function handleUncachedObjects(objectCache,mxObjs,json){const{commits:commits=[],rollbacks:rollbacks=[],deletes:deletes=[]}=json;mxObjs.forEach(mxObj=>{const guid=mxObj.getGuid();if(commits.includes(guid)||rollbacks.indexOf(guid)>=0){const cachedMxObj=objectCache.getObject(guid);if(!cachedMxObj)throw new Error("inconsistent response: committed or rolled back object is missing from response and cache");mxObj.resetFromJSON(cachedMxObj.jsonData)}else deletes.includes(guid)&&mxObj.markAsUnavailable()})}!function(DayOfWeek){DayOfWeek[DayOfWeek.Sunday=0]="Sunday",DayOfWeek[DayOfWeek.Monday=1]="Monday",DayOfWeek[DayOfWeek.Tuesday=2]="Tuesday",DayOfWeek[DayOfWeek.Wednesday=3]="Wednesday",DayOfWeek[DayOfWeek.Thursday=4]="Thursday",DayOfWeek[DayOfWeek.Friday=5]="Friday",DayOfWeek[DayOfWeek.Saturday=6]="Saturday"}(DayOfWeek||(DayOfWeek={}));(new Date).getTime();function Data(config,objectCache){config=config||{};var self=this;const valSubscriptions=[];let currentBackend,gcInterval;const runCallback1=curryN(3,runCallback),createErrorHandler=curry(runErrorHandler);function normalizeArguments(args){if("object"!=typeof args)throw new AssertionError("args is not an object");if("function"!=typeof args.callback)throw new AssertionError("callback is not a function");if(args.mxobj&&!(args.mxobj instanceof MxObject))throw new AssertionError("mxobj is not a MxObject");if(args.mxobjs&&!(args.mxobjs instanceof Array))throw new AssertionError("mxobjs is not an Array");if(!args.mxobj&&!args.mxobjs||args.mxobj&&args.mxobjs)throw new AssertionError("one of mxobj or mxobjs should be passed");return args.mxobj?[args.mxobj]:args.mxobjs}function collectGarbage(){const cachedObjects=objectCache.getAllObjects(),cachedGuidSet=StringSet.fromArray(cachedObjects.map(mxobj=>mxobj.getGuid())),collectableGuids=cachedGuidSet.difference(StringSet.fromArray(function(){const userId=window.mx.session.getUserId(),sessionId=window.mx.session.getSessionObjectId(),rootGuids=unique$1(getSubscribedGuids().concat(valSubscriptions.map(vs=>vs.guid)).concat([userId,sessionId]));return findReachableGuidsToRetain(cachedObjects,rootGuids)}())).values();config.logCleanupStatistics&&window.mx.logger.debug(function(){const entityToGuids=groupBy(collectableGuids,guid=>objectCache.getObject(guid).getEntity()),objectsStr=arrayFromObject(entityToGuids).map(([entity,guids])=>entity+": "+guids.join(", ")).join("\n");return`Garbage collecting ${collectableGuids.length} of ${cachedGuidSet.length()}\n${objectsStr}`}()),objectCache.removeObjects(collectableGuids)}function runCallback0(callback,scope){return function(){runCallback(callback,scope)}}function runCallback(callback,scope,...args){try{callback&&callback.apply(scope,args)}catch(e){window.mx.onError(e)}}function runErrorHandler(error,scope,e){error?error.call(scope,e):window.mx.onError(e)}function isCached(mxobj){return objectCache.has(mxobj.getGuid())}function getGuid(mxobj){return mxobj.getGuid()}function getEntity(mxobj){return mxobj.getEntity()}this.getBacktrack=function(guid,paths,callback,error,scope){if("function"!=typeof error&&(scope=error,error=null),paths&&0!==paths.length){var mxobj=null,constraints=[],pathIndex=0,allMatched=!0,fetchConstraints=function(){var path=paths[pathIndex++];path?function(mxobj,path,callback,error){var split=path.split("/"),fetchDeepRefs=function(objs){var constraints,entity=split.shift(),ref=split.shift();if(null!=objs&&null!=objs.length&&0!==objs.length){for(var carr=[],i=0;i<objs.length;i++)null!=objs[i]&&carr.push("id='"+objs[i].getGuid()+"'");if(carr.length)constraints="["+ref+"/"+entity+"["+carr.join(" or ")+"]]",1===split.length?callback(constraints):(entity=split.shift(),ref=split.shift(),callback("["+ref+"/"+entity+constraints+"]"));else callback(null)}else callback(null)};!function(){var entity=split.shift(),ref=split.shift();if(1===split.length){var constraint="["+ref+"='"+mxobj.getGuid()+"']";return void callback(constraint)}const meta=window.mx.meta.getEntity(entity);null!=meta?mxobj.isA(entity)?meta.isReference(ref)?""!==mxobj.get(ref)?self.get({guids:mxobj.getReferences(ref),callback:fetchDeepRefs,error:error}):callback(null):runErrorHandler(error,null,new Error(`Reference ${ref} not found in entity ${entity}`)):runErrorHandler(error,null,new AssertionError(`Entity ${mxobj.getEntity()} is not a ${entity} or one of its subclasses`)):runErrorHandler(error,null,new Error(`Entity ${entity} does not exist`))}()}(mxobj,path,(function(constraint){constraint?constraints.push(constraint):allMatched=!1,fetchConstraints()}),createErrorHandler(error,scope)):callback.call(scope,constraints.join(""),allMatched)};guid?self.get({guid:guid,callback:function(obj){obj?(mxobj=obj,fetchConstraints()):callback.call(scope,"",!1)},error:createErrorHandler(error,scope)}):callback.call(scope,"",!1)}else callback.call(scope,"",!0)},this.toString=function(){return"mendix.sys.Data"},this.startup=function(backend){currentBackend=backend;const gcPeriod=null!=config.garbageCollectionInterval?Number(config.garbageCollectionInterval):1e4;0!==gcPeriod&&(gcInterval=window.setInterval(collectGarbage,gcPeriod))},this.subscribe=function(args,scope){if(!args.val)return subscribe(Object.assign({},args,{callback(){if(args.callback){if(args.entity)return args.callback.apply(scope,[args.entity]);if(args.attr){const object=objectCache.getObject(args.guid),val=null!=object?object.get(args.attr):null;return args.callback.apply(scope,[args.guid,args.attr,null!=val?val:""])}return args.callback.apply(scope,[args.guid])}}}));const subscription=Object.assign({},args,{callback(...callbackArgs){args.callback&&args.callback.apply(scope,callbackArgs)}});return valSubscriptions.push(subscription),{unsubscribe:()=>{const index=valSubscriptions.indexOf(subscription);-1!==index&&valSubscriptions.splice(index,1)}}},this.unsubscribe=function(handle){if(!("unsubscribe"in handle))throw new AssertionError("Trying to unsubscribe using an invalid subscription handle");handle.unsubscribe()},this.sendValidationUpdates=action((function(validations){const lostValidations=[];if(validations.forEach(validation=>{const unhandledAttrVal=validation.clone(),valAttrs=validation.getAttributes().map(a=>a.name);valSubscriptions.filter(({val:val,guid:guid,attr:attr})=>val&&null!=attr&&guid===validation.getGuid()&&valAttrs.includes(attr)).forEach(({attr:attr,callback:callback})=>{callback(validation.getErrorReason(attr)),unhandledAttrVal.removeAttribute(attr)}),valSubscriptions.filter(({val:val,guid:guid,attr:attr})=>val&&null==attr&&guid===validation.getGuid()).forEach(({callback:callback})=>{const trackValidation=validation.clone();callback([trackValidation]);const leftAttrs=trackValidation.getAttributes().map(a=>a.name);unhandledAttrVal.getAttributes().forEach(({name:attr})=>{leftAttrs.includes(attr)||unhandledAttrVal.removeAttribute(attr)})}),unhandledAttrVal.getAttributes().length>0&&lostValidations.push(unhandledAttrVal)}),lostValidations.length){const validationsText=ObjectValidation.describe(lostValidations);window.mx.ui.showMessage("error",validationsText,!1)}})),this.updateInCache=function(json){return objectCache.removeAllChanges([json.guid]),objectCache.setMxObjects([json]),objectCache.getObject(json.guid)},this.removeChanges=function(guid){objectCache.removeAllChanges([guid])},this.action=function(kwArgs){currentBackend.action(kwArgs.params,kwArgs.context||new MxContext,kwArgs.origin,!!kwArgs.async,kwArgs.onValidation).then(kwArgs.callback,createErrorHandler(kwArgs.error,null))},this.callNanoflow=function({nanoflow:nanoflow,context:context,origin:origin,callback:callback,error:error}){(async function(){const nanoflowId=nanoflow.nanoflow,paramsSpec=nanoflow.paramsSpec,paramNameToGuids=Object.keys(paramsSpec).map(paramName=>{const guid=context.getContext(paramsSpec[paramName]);return{name:paramName,guid:null!==guid?guid:void 0}}),allGuids=paramNameToGuids.filter(x=>Boolean(x.guid)).map(x=>x.guid),allObjects=await(guids=allGuids,new Promise((resolve,reject)=>{window.mx.data.get({guids:guids,callback:resolve,error:reject})})),args=paramNameToGuids.map(({name:paramName,guid:guid})=>({name:paramName,value:allObjects.find(o=>o.getGuid()===guid)}));var guids;try{return await nanoflowEngine.execute(nanoflowId,args,origin)}catch(e){throw await async function(objectCache,e,onValidation){if(e instanceof ValidationError){const json=e.original,updates=gatherUpdates(objectCache,json).filter(u=>!("attr"in u));await publish(...updates),await executeNoImpactInstructions(json.instructions),handleValidations(json.datavalidation,onValidation)}}(objectCache,e),e}})().then(runCallback1(callback,null),createErrorHandler(error,null))},this.get=function(args,scope){var xpath=args.xpath,path=args.path,id=args.guid,ids=!("guids"in args)&&id?[id]:""===args.guids?[]:args.guids,entity=args.entity,direction=args.direction||"reverse",callback=args.callback,error=args.error,needCount=!!args.count,kwfilter=args.filter,context=args.context||new MxContext,microflow=args.microflow;if("guid"in args&&null==id)runCallback(callback,scope,null);else{if(!(xpath||ids||microflow||entity))throw new AssertionError("xpath, guid|guids and microflow arguments are undefined");if(path&&1!==ids.length)throw new AssertionError("path can only be used with a single guid");if("function"!=typeof callback)throw new AssertionError("callback is not a function");if(error&&"function"!=typeof error)throw new AssertionError("error is not a function");kwfilter&&kwfilter.limit&&(kwfilter.amount=kwfilter.limit,delete kwfilter.limit);var filter=function(target,source,map){if(!source)return target;for(var i in map)i in source&&null!=source[i]&&(target[i]=source[i]);return target}({},kwfilter,id?{id:null}:{id:null,attributes:null,offset:null,sort:null,amount:null,distinct:null,references:null}),errback=createErrorHandler(error,scope);if(filter.id&&ids&&!id&&delete filter.id,filter.id&&(delete filter.attributes,delete filter.distinct),microflow){var applyto=ids?"selection":xpath?"set":"none",params={actionname:microflow,applyto:applyto};"selection"===applyto?params.guids=ids:"set"===applyto&&(params.xpath=xpath,filter.sort&&(params.sort=filter.sort)),self.action({params:params,context:context,callback:runCallback1(callback,scope),error:errback})}else if(path&&ids)currentBackend.getByPath(ids[0],path,entity,direction).then(({mxobjs:mxobjs,count:count})=>{runCallback(callback,scope,mxobjs,{count:count})},createErrorHandler(error,scope));else if(ids){if(0===ids.length)return void runCallback(callback,scope,id?null:[],{count:0});(ids.every(guid=>objectCache.has(guid))?Promise.resolve(function(guids,filter){filter=filter||{};let objs=guids.map(guid=>objectCache.getObject(guid)).filter(mxobj=>null!=mxobj);filter.sort&&filter.sort.forEach(sort=>{var attr=sort[0],dir=sort[1];objs=objs.sort((a,b)=>(a=a.get(attr))<(b=b.get(attr))?"asc"===dir?-1:1:a>b?"asc"===dir?1:-1:0)});const offset=filter.offset;if(offset){const limit=filter.amount;objs=limit?objs.slice(offset,offset+limit):objs.slice(offset)}return{mxobjs:objs,count:objs.length}}(ids,filter)):currentBackend.getByGuid(ids,filter)).then(({mxobjs:mxobjs,count:count})=>{var result;result=id?filter.id?mxobjs.find(mxobj=>mxobj.getGuid()===id)||null:mxobjs[0]||null:mxobjs,runCallback(callback,scope,result,{count:count})},errback)}else if(entity)if(window.mx.isOffline()){const{amount:limit,offset:offset,sort:sort}=filter;currentBackend.getSlice(entity,[],{limit:limit,offset:offset,sort:sort},!1).then(({mxobjs:mxobjs,count:count})=>{runCallback(callback,scope,mxobjs,{count:count})})}else{const{amount:amount,offset:offset,sort:sort}=filter;currentBackend.getByXPath("//"+entity,{amount:amount,offset:offset,sort:sort},needCount).then(({mxobjs:mxobjs,count:count})=>{runCallback(callback,scope,mxobjs,{count:count})},errback)}else currentBackend.getByXPath(xpath,filter,needCount).then(({mxobjs:mxobjs,count:count,aggregates:aggregates})=>{runCallback(callback,scope,mxobjs,{count:count,aggregates:aggregates})},errback)}},this.getOffline=function(entity,constraints,filter,callback,error){return this.getSlice(entity,constraints,filter,!1,callback,error)},this.getSlice=function(entity,constraints,filter,useCache,callback,error){currentBackend.getSlice(entity,constraints,filter,useCache).then(({mxobjs:mxobjs,count:count})=>{runCallback(callback,null,mxobjs,count)}).catch(createErrorHandler(error,null))},this.create=function(params,thisObject){if("function"!=typeof params.callback)throw new AssertionError("callback is not a function");if(params.error&&"function"!=typeof params.error)throw new AssertionError("error is not a function");if("string"!=typeof params.entity)throw new AssertionError("entity is not a string");currentBackend.create(params.entity).then((function(mxobj){params.context&&self.setObjectToContext(mxobj,params.context);runCallback(params.callback,thisObject,mxobj)}),createErrorHandler(params.error,thisObject))},this.remove=function(kwArgs){const guids="guid"in kwArgs?[kwArgs.guid]:""===kwArgs.guids?[]:kwArgs.guids;if("guids"in kwArgs&&!(kwArgs.guids instanceof Array))throw new AssertionError("parameter guids set but not of type Array");if(kwArgs.error&&"function"!=typeof kwArgs.error)throw new AssertionError("parameter error set but not of type Function");if(kwArgs.callback&&"function"!=typeof kwArgs.callback)throw new AssertionError("parameter callback set but not of type Function");currentBackend.remove(guids).then(runCallback0(kwArgs.callback),createErrorHandler(kwArgs.error,null))},this.validate=function(mxobjs,callback,error){0!==mxobjs.length?currentBackend.validate(mxobjs.map(getGuid)).then(runCallback0(callback),createErrorHandler(error,null)):runCallback(callback)},this.commit=function(kwArgs,thisObject){const successHandler=runCallback0(kwArgs.callback,thisObject),errorHandler=createErrorHandler(kwArgs.error,thisObject),mxobjs=normalizeArguments(kwArgs);if(0===mxobjs.length&&kwArgs.callback)return void successHandler();const guids=mxobjs.map(mxobj=>mxobj.getGuid());currentBackend.commit(guids,kwArgs.context||new MxContext,kwArgs.store,kwArgs.onValidation).then((function(json){handleUncachedObjects(objectCache,mxobjs,json);const entityUpdates=unique$1(mxobjs.filter(isCached).map(getEntity)).map(entity=>({entity:entity})),objectUpdates=unique$1(mxobjs.map(getGuid)).map(guid=>({guid:guid})),updates=entityUpdates.concat(objectUpdates);publish(...updates).then(successHandler,errorHandler)}),errorHandler)},this.rollback=function(kwArgs,thisObject){const errorHandler=createErrorHandler(kwArgs.error,thisObject),callingMxObjs=normalizeArguments(kwArgs);if(0===callingMxObjs.length)return void runCallback(kwArgs.callback,thisObject);const entityUpdates=unique$1(callingMxObjs.map(getEntity)).map(entity=>({entity:entity})),guids=callingMxObjs.map(mxobj=>mxobj.getGuid());currentBackend.rollback(guids).then((function(json){handleUncachedObjects(objectCache,callingMxObjs,json);const objectUpdates=unique$1(callingMxObjs.filter(isCached).map(getGuid)).map(guid=>({guid:guid})),updates=entityUpdates.concat(objectUpdates);publish(...updates).then(runCallback1(kwArgs.callback,thisObject),errorHandler)}),errorHandler)},this.uploadOffline=function(){return currentBackend.upload()},this.downloadOffline=async function(uploadedObjsEntityToGuidsMap={},fullReset=!1){await currentBackend.download(uploadedObjsEntityToGuidsMap,fullReset)},this.synchronizeOffline=function(_args,callback,error){this.uploadOffline().then(uploadedObjsEntityToGuidsMap=>this.downloadOffline(uploadedObjsEntityToGuidsMap)).then(runCallback0(callback),createErrorHandler(error,null))},this.saveDocument=function(guid,fileName,params,blob,callback,error){const errorHandler=createErrorHandler(error,null);currentBackend.saveDocument(guid,fileName,params,blob).then((function(){publish({guid:guid}).then(callback,errorHandler)}),errorHandler)},this.generateReport=function(reportId,offset,limit,params,callback,error){currentBackend.generateReport(reportId,offset,limit,params).then(callback,createErrorHandler(error,null))},this.generateExcelReport=function(reportId,params,callback,error){currentBackend.generateExcelReport(reportId,params).then(callback,createErrorHandler(error,null))},this.getReportParameters=function(reportId,callback,error){currentBackend.getReportParameters(reportId).then(callback,createErrorHandler(error,null))},this.setObjectToContext=function(mxObj,context){if("object"!=typeof mxObj)throw new AssertionError("parameter mxObj is not of type Object");if("object"!=typeof context)throw new AssertionError("parameter context is not of type Object");for(var eAttrs=mxObj.getAttributes(),e=0;e<eAttrs.length;e++)if(mxObj.isReference(eAttrs[e])){var _className=mxObj.getSelectorEntity(eAttrs[e]);if("System.owner"===eAttrs[e]||"System.changedBy"===eAttrs[e])continue;context.hasContext(_className)&&mxObj.addReference(eAttrs[e],context.getContext(_className));var meta=window.mx.meta.getEntity(_className);if(meta&&meta.hasSubEntities())for(var subtypees=meta.getSubEntities(),i=0;i<subtypees.length;i++)context.hasContext(subtypees[i])&&mxObj.addReference(eAttrs[e],context.getContext(subtypees[i]))}},this.getObjectFromContext=function(context,callback){var trackObj=context.getObject(),trackId=context.getTrackId();trackObj?callback(trackObj):trackId?window.mx.data.get({guid:trackId,callback:function(obj){obj||window.mx.onError("Error while fetching object with guid "+trackId),callback(obj)},error:function(e){window.mx.onError(e),callback(null)}},this):callback(null)},this.isNew=function(guid){return objectCache.isNew(guid)},this.makeChange=function(guid,attr,rawValue){objectCache.makeChange(guid,attr,rawValue)},this.getChanges=function(guid){return objectCache.getChanges(guid)},this.getCachedObject=function(guid){return objectCache.getObject(guid)},this.dehydrateCache=function(){return objectCache.dehydrate()},this.hydrateCache=function(state){return objectCache.hydrate(state)},this.getDocumentUrl=function(guid,changedDate,isThumb){return currentBackend.getDocumentUrl(guid,changedDate,isThumb)},this.getImageUrl=function(url,callback,error){currentBackend.getImageUrl(url).then(callback,error)},this.clear=function(callback){objectCache.clear(),currentBackend.cleanup().then(callback)},this.uninitialize=function(){gcInterval&&window.clearInterval(gcInterval)},this.getObjectsStatistics=function(){return objectCache.getAllObjects().map(obj=>({object:obj,changes:objectCache.getChanges(obj.getGuid()),uncommitted:objectCache.isNew(obj.getGuid()),subscriptions:getTags(obj.getGuid()).concat(valSubscriptions.filter(v=>v.guid===obj.getGuid()).map(v=>v.tag))}))}}function MxMetaObject(kwArgs){var jsonData=kwArgs.json;if(!(jsonData&&jsonData.attributes&&jsonData.objectType&&jsonData.properties))throw new Error("MxMetaObject: invalid initialization");this.has=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.has: parameter attr is not of type String.");return Object.prototype.hasOwnProperty.call(jsonData.attributes,attr)},this.isEnum=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isEnum : parameter attr is not of type String.");return/^(Enum|EnumSet)$/.test(this.getAttributeType(attr))},this.isNumeric=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isNumeric : parameter attr is not of type String.");return/^(Integer|Long|Decimal)$/.test(this.getAttributeType(attr))},this.isPassword=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isDate : parameter attr is not of type String.");return"HashString"===this.getAttributeType(attr)},this.isDate=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isDate : parameter attr is not of type String.");return/^(Date|DateTime)$/.test(this.getAttributeType(attr))},this.isLocalizedDate=function(attr){return this.isDate(attr)?/true/.test(jsonData.attributes[attr].localize):null},this.isBoolean=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isBoolean : parameter attr is not of type String.");return"Boolean"===this.getAttributeType(attr)},this.isReference=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isReference : parameter attr is not of type String.");return/^(ObjectReference|ObjectReferenceSet)$/.test(this.getAttributeType(attr))},this.isObjectReference=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isObjectReference : parameter attr is not of type String.");return"ObjectReference"===this.getAttributeType(attr)},this.isObjectReferenceSet=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isObjectReferenceSet : parameter attr is not of type String.");return"ObjectReferenceSet"===this.getAttributeType(attr)},this.isBidirectionalReference=function(attr){return this.isReference(attr)&&Boolean(jsonData.attributes[attr].both)},this.getOptions=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.getOptions : parameter attr is not of type String.");if(!this.isEnum(attr))throw new Error("mendix/lib/MxMetaObject.getOptions : attribute '"+attr+"' is not an Enumeration.");try{var opts=[];if(this.has(attr)){var arr=jsonData.attributes[attr].options;if(arr&&arr.length){opts=[];for(var i=0;i<arr.length;i++)for(var j in arr[i])opts.push(arr[i][j])}}return opts}catch(e){return[]}},this.getEnumMap=function(attr){if(!this.isEnum(attr))return null;for(var map=[],arr=jsonData.attributes[attr].options,i=0;i<arr.length;i++)for(var j in arr[i]){map.push({key:j,caption:arr[i][j]});break}return map},this.getEnumKVPairs=function(attr){if(!this.isEnum(attr))return null;for(var map={},arr=jsonData.attributes[attr].options,i=0;i<arr.length;i++)for(var j in arr[i])map[j]=arr[i][j];return map},this.getEnumCaption=function(attr,value){if(!this.isEnum(attr))return null;for(var arr=jsonData.attributes[attr].options,i=0;i<arr.length;i++){var item=arr[i];for(var key in item)if(key===value)return item[key]}return value},this.getReferenceAttributes=function(){var refs=[];for(var i in jsonData.attributes)this.isReference(i)&&refs.push(i);return refs},this.getAttributes=function(){var attrs=[];for(var i in jsonData.attributes)attrs.push(i);return attrs},this.getAttributesWithoutReferences=function(){var attrs=[];for(var i in jsonData.attributes)this.isReference(i)||attrs.push(i);return attrs},this.getAttributeType=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.getAttributeType : parameter attr is not of type String.");return!!this.has(attr)&&jsonData.attributes[attr].type},this.isAttributeReadonly=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isAttributeReadonly : parameter attr is not of type String.");if(!this.has(attr))throw new Error(`mendix/lib/MxMetaObject.isAttributeReadonly : attribute "${attr}" is not available`);return!0===jsonData.attributes[attr].readonly},this.getSelectorEntity=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.getSelectorEntity : parameter attr is not of type String.");return!!this.has(attr)&&jsonData.attributes[attr].klass},this.getEntity=function(){return jsonData.objectType},this.isPersistable=function(){return jsonData.persistable},this.needsReachableState=function(action){return!(action in jsonData.needsReachableState)||jsonData.needsReachableState[action]},this.isA=function(entity){return this.getEntity()===entity||this.inheritsFrom(entity)},this.hasSuperEntities=function(){return 0!==jsonData.properties.superclasses.length},this.getSuperEntities=function(){var supers=jsonData.properties.superclasses;return"string"==typeof supers?[supers]:supers},this.hasSubEntities=function(){return 0!==jsonData.properties.subclasses.length},this.getSubEntities=function(){var subs=jsonData.properties.subclasses;return"string"==typeof subs?[subs]:subs},this.inheritsFrom=function(ancestor){return(this.getSuperEntities()||[]).includes(ancestor)},this.isSyncable=function(attr){if("string"!=typeof attr)throw new Error("mendix/lib/MxMetaObject.isObjectReferenceSet : parameter attr is not of type String.");return!!this.has(attr)&&(void 0===jsonData.attributes[attr].sync||jsonData.attributes[attr].sync)}}function Meta(){const metaObjects={},cachedAttributeOwner={};this.startup=function(){window.mx.session.getConfig("metadata").forEach((function(metaJson){const metaObject=new MxMetaObject({json:metaJson});metaObjects[metaObject.getEntity()]=metaObject}))},this.getMap=function(){return metaObjects},this.getEntity=function(entity){const meta=metaObjects[entity];return meta||window.mx.logger.error("No permission to read or write entity "+entity+", check security!"),meta},this.hasEntity=function(entity){return void 0!==metaObjects[entity]},this.getAttributeOwner=function(entity,attr){const cacheKey=entity+"."+attr,cachedResult=cachedAttributeOwner[cacheKey];if(null!=cachedResult)return cachedResult;const meta=this.getEntity(entity);if(!meta||!meta.has(attr))return null;const[superMostEntity]=[entity].concat(meta.getSuperEntities()).filter(superEntity=>this.getEntity(superEntity).has(attr)).slice(-1);return cachedAttributeOwner[cacheKey]=superMostEntity,superMostEntity}}class RuntimeSocketConnection{constructor(url){this.url=url,this.reloadHandlers=[],this.connectHandlers=[]}isConnected(){return void 0!==this.socket&&this.socket.readyState===WebSocket.OPEN}onConnect(handler){this.isConnected()?handler():this.connectHandlers.push(handler)}onReloadMessage(handler){this.reloadHandlers.push(handler)}sendLog(level,message){if(this.isConnected()){const maxSendLength=6e4;for(let offset=0;offset<message.length;offset+=maxSendLength){const messagePart=message.substr(offset,maxSendLength);ensure(this.socket).send(`log:${level}:${messagePart}`)}}}connect(){try{this.socket=new WebSocket(this.url),this.socket.onopen=()=>{this.connectHandlers.forEach(handler=>handler()),this.connectHandlers.splice(0)},this.socket.onmessage=message=>{if("MENDIX_RELOAD"===message.data)this.reloadHandlers.forEach(handler=>handler(!0));else{if(0!==message.data.indexOf("SESSIONID:"))throw new AssertionError("Unexpected command received from the runtime: "+message.data);{const newSessionId=message.data.split(":")[1];void 0!==this.sessionId&&newSessionId!==this.sessionId&&this.reloadHandlers.forEach(handler=>handler(!1)),this.sessionId=newSessionId}}},this.socket.onclose=()=>this.reconnect()}catch(e){this.reconnect()}}reconnect(){this.socket=void 0,setTimeout(()=>this.connect(),1e3)}}class DevTools{constructor(remoteUrl){this.connection=new RuntimeSocketConnection(remoteUrl.replace(/^http/,"ws")+"reload/")}connect(){this.connection.connect()}addOnReload(handler){this.connection.onReloadMessage(handler)}log(level,...args){const messages=args.map(convertArgument);this.connection.onConnect(()=>this.connection.sendLog(level,messages.join("\n")))}}function convertArgument(arg){if("string"==typeof arg)return arg;if(arg instanceof Error)return`${arg.message} ${arg.stack}`;if(null==arg?void 0:arg.outerHTML)return arg.outerHTML;try{return JSON.stringify(arg)}catch(e){return"[Unserializable data. See browser console for the details]"}}function MxObjectCache(){this._objectCache={},this._newGuids={},this._changes={}}MxObjectCache.prototype.getAllObjects=function(){return Object.values(this._objectCache)},MxObjectCache.prototype.dehydrate=function(){return clone$1({data:this.getAllObjects(),newGuids:this._newGuids,changes:this._changes})},MxObjectCache.prototype.hydrate=function({data:data,newGuids:newGuids,changes:changes}){this._objectCache={},data.map(rawObj=>MxObject.fromJson(rawObj)).forEach(mxobj=>{this._objectCache[mxobj.getGuid()]=mxobj}),this._newGuids=clone$1(newGuids),this._changes=clone$1(changes)},MxObjectCache.prototype.getObject=function(guid){return this._objectCache[guid]||null},MxObjectCache.prototype.removeObjectKeepChanges=function(guid){delete this._objectCache[guid],delete this._newGuids[guid]},MxObjectCache.prototype.setMxObjects=function(rawObjs){rawObjs.forEach((function(rawObj){var guid=rawObj.guid,cacheObj=this._objectCache[guid];cacheObj?cacheObj.resetFromJSON(rawObj):this._objectCache[guid]=new MxObject({json:rawObj,meta:window.mx.meta.getEntity(rawObj.objectType)})}),this)},MxObjectCache.prototype.has=function(guid){return!!this.getObject(guid)},MxObjectCache.prototype.isNew=function(guid){return this.has(guid)&&Boolean(this._newGuids[guid])},MxObjectCache.prototype.clear=function(){this._objectCache={},this._newGuids={},this._changes={}},MxObjectCache.prototype.hasChanges=function(guid){return guid in this._changes},MxObjectCache.prototype.getChanges=function(guid){return clone$1(this._changes[guid]||{})},MxObjectCache.prototype.makeChange=function(guid,attr,value){this._changes[guid]=this._changes[guid]||{},this._changes[guid][attr]={value:value}},MxObjectCache.prototype.removeAllChanges=function(guids){guids.forEach((function(guid){delete this._changes[guid]}),this)},MxObjectCache.prototype.removeChanges=function(resets){Object.keys(resets).forEach(guid=>{const changes=this._changes[guid];changes&&(resets[guid].forEach(attr=>delete changes[attr]),0===Object.keys(changes).length&&delete this._changes[guid])})},MxObjectCache.prototype.onCreate=function(guids){guids.forEach(guid=>{this._newGuids[guid]=!0})},MxObjectCache.prototype.onCommit=function(guids){guids.forEach(guid=>delete this._newGuids[guid])},MxObjectCache.prototype.onDelete=function(guids){for(const guid of guids)guid in this._objectCache&&this._objectCache[guid].markAsUnavailable();this.removeObjects(guids)},MxObjectCache.prototype.addChanges=function(changes){for(const guid in changes){const objChanges=changes[guid];null==this._changes[guid]&&(this._changes[guid]={});const existingObjChanges=this._changes[guid];for(const attr in objChanges)existingObjChanges[attr]=objChanges[attr]}},MxObjectCache.prototype.removeObjects=function(guids){guids.forEach(guid=>{delete this._objectCache[guid],delete this._newGuids[guid],delete this._changes[guid]})};const IgnoredWarnings=["RCTBridge","Attempted to invoke"];var WarningsFilter;function getWarningsFilterLevel(){return NativeModules.MxConfiguration.WARNINGS_FILTER_LEVEL}!function(WarningsFilter){WarningsFilter.All="all",WarningsFilter.Partial="partial",WarningsFilter.None="none"}(WarningsFilter||(WarningsFilter={}));class NativeLogger extends class{constructor({handleErrors:handleErrors=!0,isQuiet:isQuiet=!1}={}){this.logHandlers=[],isQuiet||this.addHandler(this.createConsoleLogHandler()),handleErrors&&"function"==typeof window.addEventListener&&(window.addEventListener("error",event=>this.error(event.error)),window.addEventListener("unhandledrejection",event=>this.error(event.reason)))}addHandler(handler){this.logHandlers.push(handler)}trace(...args){this.log("trace",...args)}debug(...args){this.log("debug",...args)}info(...args){this.log("info",...args)}warn(...args){this.log("warning",...args)}error(...args){this.log("error",...args)}critical(...args){this.log("critical",...args)}log(level,...args){this.logHandlers.forEach(handler=>handler(level,...args))}createConsoleLogHandler(){const originalLog={};return["debug","info","log","warn","error"].forEach(clientLevel=>{originalLog[clientLevel]=console[clientLevel];const runtimeLevel=function(clientLevel){switch(clientLevel){case"warn":return"warning";case"log":return"debug";default:return clientLevel}}(clientLevel);console[clientLevel]=(...args)=>this.log(runtimeLevel,...args)}),(runtimeLevel,...args)=>{const clientLevel=function(runtimeLevel){switch(runtimeLevel){case"trace":return;case"critical":return"error";case"warning":return"warn";default:return runtimeLevel}}(runtimeLevel);void 0!==clientLevel&&originalLog[clientLevel].call(console,...args)}}}{constructor(){super(...arguments),this.enableFilter="all"!==getWarningsFilterLevel()}log(level,...args){this.enableFilter&&args.some(arg=>"string"==typeof arg&&IgnoredWarnings.some(warning=>arg.includes(warning)))||super.log(level,...args)}}const clone=objectToClone=>{if(null===objectToClone||"object"!=typeof objectToClone)return objectToClone;const objectClone=Array.isArray(objectToClone)?[]:{};return Object.keys(objectToClone).forEach(prop=>objectClone[prop]=clone(objectToClone[prop])),objectClone};function createRetryOnUnauthorizedMiddleware(recover){const ignoredActions=["get_session_data","login","logout"];let recoverPromise,sessionCounter=0;return async(request,next)=>{const currentSessionNumber=sessionCounter;try{return await next(request)}catch(e){const action=isJson(request.body)?request.body.action:void 0;if(!(e instanceof UnauthorizedError)||void 0!==action&&ignoredActions.includes(action))throw e;if(currentSessionNumber!==sessionCounter)return await next(request);if(recoverPromise)return await recoverPromise,await next(request);recoverPromise=recover();try{await recoverPromise}finally{recoverPromise=void 0}return++sessionCounter,await next(request)}}}class Session{constructor(sessionStore,tokenStore,bundleVersion,mxVersion,shouldGenerateToken,onUnauthorized){this.sessionStore=sessionStore,this.tokenStore=tokenStore,this.bundleVersion=bundleVersion,this.mxVersion=mxVersion,this.shouldGenerateToken=shouldGenerateToken,this.onUnauthorized=onUnauthorized}isValid(){return void 0!==this.sessionData}getConfig(path){if(void 0===this.sessionData)throw new Error("Session is not available");if(!path)return clone(this.sessionData);const steps=path.split(".");let result=this.sessionData;for(let i=0;i<steps.length&&result;i++)result=result[steps[i]];return clone(result)}getUserObject(){return this.userObject||(this.userObject=MxObject.fromJson(this.getConfig("user"))),this.userObject}isGuest(){return this.getConfig("user.attributes.IsAnonymous.value")}isOffline(){return!!this.getConfig("sync_config")}getOfflineConfig(){var _a;return null!==(_a=this.getConfig("sync_config"))&&void 0!==_a?_a:void 0}getSessionObjectId(){return this.getConfig("sessionObjectId")}getUserId(){return this.getUserObject().getGuid()}getUserRoleNames(){return this.getConfig("roles")}hasSomeRole(roles){if(void 0===roles)return!0;const userRoleNames=this.getUserRoleNames();return roles.some(role=>userRoleNames.includes(role))}getConstants(){return this.getConfig("constants")}async login(args){const data=await async function(username,password,shouldGenerateToken){return post(xasUrl(),{action:"login",params:{username:username,password:password,shouldgeneratetoken:shouldGenerateToken}})}(args.username,args.password,this.shouldGenerateToken);await this.sessionStore.remove(),data.authtoken&&await this.tokenStore.set(data.authtoken)}destroySession(callback){callback()}async logout(){try{const token=await this.tokenStore.get();await async function(authToken){return post(xasUrl(),{action:"logout",params:authToken?{authtoken:authToken}:{}})}(token)}catch(e){if(!(e instanceof ConnectionError))throw e}finally{await this.tokenStore.remove(),await this.sessionStore.remove()}}async startup(params){const authToken=await this.tokenStore.get();this.sessionParams=authToken?Object.assign({authtoken:authToken},params):params;const{sessionData:sessionData,shouldSync:shouldSync,shouldPersist:shouldPersist}=await this.loadSessionData();var handler,getCsrfToken;return shouldPersist&&await this.sessionStore.set(JSON.stringify(Object.assign(Object.assign({},sessionData),{mxVersion:this.mxVersion,bundleVersion:this.bundleVersion}))),this.sessionData=sessionData,(authToken||this.isGuest())&&this.isOffline()?registerMiddleware(createRetryOnUnauthorizedMiddleware(this.restoreSessionOnUnauthorized.bind(this))):registerMiddleware(authToken?createRetryOnUnauthorizedMiddleware(async()=>mx.reload()):(handler=this.failOnUnauthorized.bind(this),async(request,next)=>{try{return await next(request)}catch(err){const action=isJson(request.body)&&request.body.action;if(err instanceof UnauthorizedError&&"login"!==action)return await handler(err);throw err}})),!this.isOffline()&&sessionData.keepalive&&setInterval(()=>{(async function(){return post(xasUrl(),{action:"keepalive",params:{}})})().catch(()=>{})},sessionData.keepalive),registerMiddleware((getCsrfToken=()=>ensure(this.sessionData).csrftoken,(request,next)=>{const requestWithToken={url:request.url,init:Object.assign(Object.assign({},request.init),{headers:new Headers(request.init.headers)}),body:request.body};return requestWithToken.init.headers.append("X-Csrf-Token",getCsrfToken()),next(requestWithToken)})),shouldSync}async loadSessionData(){const oldSessionDataStr=await this.sessionStore.get(),oldSessionData=void 0!==oldSessionDataStr?JSON.parse(oldSessionDataStr):void 0;if(oldSessionData&&oldSessionData.bundleVersion===this.bundleVersion&&!oldSessionData.isDevModeEnabled)return{sessionData:oldSessionData,shouldSync:!1,shouldPersist:!1};try{const newSessionData=await getSessionData(ensure(this.sessionParams));return{sessionData:newSessionData,shouldSync:this.shouldSync(oldSessionData,newSessionData),shouldPersist:!!newSessionData.sync_config}}catch(e){if(401===e.status)throw await this.sessionStore.remove(),await this.tokenStore.remove(),e;if(460!==e.status&&oldSessionData)return{sessionData:oldSessionData,shouldSync:!1,shouldPersist:!1};throw e}}async restoreSessionOnUnauthorized(){try{const{csrftoken:csrftoken}=await getSessionData(ensure(this.sessionParams));ensure(this.sessionData).csrftoken=csrftoken,await this.sessionStore.set(JSON.stringify(this.sessionData))}catch(e){if(!(e instanceof UnauthorizedError))throw e;await this.failOnUnauthorized(e)}}async failOnUnauthorized(error){return await this.sessionStore.remove(),await this.tokenStore.remove(),this.onUnauthorized(error.status,this.isOffline()&&this.shouldGenerateToken),never()}shouldSync(oldSessionData,newSessionData){const newSyncConfig=newSessionData.sync_config;if(!newSyncConfig)return!1;if(!oldSessionData)return!0;if(oldSessionData.mxVersion!==this.mxVersion)return!0;const isEqual=comparer.structural,oldSyncConfig=oldSessionData.sync_config;return!isEqual(oldSyncConfig,newSyncConfig)||!newSyncConfig.schema.map(entity=>({oldAttrs:oldSessionData.metadata.find(e=>e.objectType===entity).attributes,newAttrs:newSessionData.metadata.find(e=>e.objectType===entity).attributes})).every(({oldAttrs:oldAttrs,newAttrs:newAttrs})=>isEqual(oldAttrs,newAttrs))}}function executeSql(sql,parameters){return Transaction.inside((tx,resolve,reject)=>tx.executeSql(sql,parameters,(_,r)=>resolve(r.rows),(_,e)=>(reject(e),!0))).chain(rows=>{const result=[];for(let i=0;i<rows.length;++i)result.push(rows.item(i));return result})}class Transaction{constructor(){this.work=[]}chain(onfulfilled){const result=new Transaction;return result.work.push(...this.work,{action:!1,item:onfulfilled}),result}async read(database){return this.execute((cb,err)=>database.readTransaction(cb,err))}async write(database){return this.execute((cb,err)=>database.transaction(cb,err))}async execute(createTx){return new Promise((resolve,reject)=>createTx(tx=>{const works=Array.from(this.work);!function process(previousResult){previousResult instanceof Transaction&&(works.unshift(...previousResult.work),previousResult=void 0);const work=works.shift();if(!work)return void resolve(previousResult);if(work.action)work.item(tx,process,reject);else try{const newResult=work.item(previousResult);process(newResult)}catch(e){reject(e)}}(tx)},reject))}static inside(action){const result=new Transaction;return result.work.push({action:!0,item:action}),result}}function getFsFileName(guid,changeDate){return guid.replace(/:/g,"_")+"@"+(null!=changeDate&&""!==changeDate?changeDate.toString():"local")}const GUID_REGEXP=new RegExp("^GUID:");function wasGuidSynced(internalGuid){return!GUID_REGEXP.test(internalGuid)}function isSpecialAttributeName(attrName){return"guid"===attrName||"$"===attrName[0]}function objectToJson(obj){const attributes=Object.keys(obj).filter(attrName=>!isSpecialAttributeName(attrName)).reduce((acc,key)=>(acc[key]={value:obj[key]},function(obj,attr){return obj.$readonlyAttrs.includes(attr)}(obj,key)&&(acc[key].readonly=!0),acc),{});return{guid:obj.guid,objectType:obj.$objectType,attributes:attributes}}function jsonToObject(jsonData){const dbObj={guid:jsonData.guid,$objectType:jsonData.objectType,$readonlyAttrs:[]};for(const key in jsonData.attributes)dbObj[key]=jsonData.attributes[key].value,jsonData.attributes[key].readonly&&dbObj.$readonlyAttrs.push(key);return dbObj}class GuidMapping{constructor(){this.guidMap={}}add(from,to){this.guidMap[from]=to}has(from){return from in this.guidMap}map(guidOrGuids){return Array.isArray(guidOrGuids)?guidOrGuids.map(this.mapGuid.bind(this)):this.mapGuid(guidOrGuids)}mapChange(change,meta){const mappedChange={};return Object.keys(change).forEach(attr=>{const entry=change[attr],value=meta.isObjectReference(attr)&&null!=entry.value?this.map(entry.value):entry.value;mappedChange[attr]=Object.assign(Object.assign({},entry),{value:value})}),mappedChange}mapMxObjectJSON(obj){const meta=mx.meta.getEntity(obj.objectType),attributes={};return Object.keys(obj.attributes).forEach(attr=>{const value=obj.attributes[attr];meta.isReference(attr)?attributes[attr]=Object.assign(Object.assign({},value),{value:this.map(value.value)}):attributes[attr]=value}),Object.assign(Object.assign({},obj),{guid:this.map(obj.guid),attributes:attributes})}reverse(){const reversed=new GuidMapping;return Object.keys(this.guidMap).forEach(from=>reversed.add(this.map(from),from)),reversed}import(other){Object.keys(other.guidMap).forEach(key=>this.add(key,other.guidMap[key]))}mapGuid(guid){return guid in this.guidMap?this.guidMap[guid]:guid}}async function instantiateObjects(offlineObjs){const instantiatedObjs=[],mapping=new GuidMapping;return await Promise.all(offlineObjs.map(async obj=>{const result=await async function(entity,changes,objects){return post(xasUrl(),{action:"instantiate",params:{objecttype:entity},changes:changes,objects:objects})}(obj.objectType,{},[]),remote=ensure(result.objects.find(object=>object.guid===result.actionResult));instantiatedObjs.push(remote),mapping.add(obj.guid,remote.guid)})),[instantiatedObjs,mapping]}function createChange(json){const meta=mx.meta.getEntity(json.objectType),changeEntries=Object.keys(json.attributes).filter(attr=>meta.isSyncable(attr)&&!json.attributes[attr].readonly).map(attr=>({[attr]:{value:json.attributes[attr].value}}));return Object.assign({},...changeEntries)}const METADATA_COLUMNS=["guid","tableName","readonlyAttrs","dirty"];function toSafeKey(key){return key.replace(".","$")}function attributeToSql(value){if(void 0===value)return null;if(value instanceof Big)return bigToSql(value);if(value instanceof Date)return Number(value);if("boolean"==typeof value)return booleanToSql(value);if(Array.isArray(value))throw new AssertionError;return value}function sqlToRuntime(value,type){if(null===value)return null;switch(type){case"DateTime":return value;case"Boolean":return Boolean(value);case"Decimal":case"Integer":case"Long":return function(x){const sign=x.startsWith("-")?"-":"",meaningfulDigits=x.replace(/^-?0*/,"");return sign+(""!==meaningfulDigits?meaningfulDigits:"0")}(value);case"ObjectReferenceSet":return""===value?null:value.split(",");default:return String(value)}}function runtimeToSql(value,type){switch(type){case"AutoNumber":case"Binary":case"HashString":case"Enum":case"ObjectReference":case"ObjectReferenceSet":case"String":return null!=value?String(value):null;case"DateTime":return null!=value?Number(value):null;case"Boolean":return Number(value);case"Decimal":case"Integer":case"Long":return function(x){if(null==x)return null;return bigToSql(new Big(x))}(value);default:throw new AssertionError}}function bigToSql(x){const nrOfZeroes=20-Math.max(0,x.e)-1;return(x.s<0?"-":"")+new Array(nrOfZeroes+1).join("0")+x.abs().toFixed()}function booleanToSql(x){return x?1:0}function createDeleteSqlQueries(entity,guids){if(0===guids.length)throw new AssertionError("No guids specified");const placeholders=new Array(guids.length).fill("?").join(", ");return[[`DELETE FROM "${toSafeKey(entity)}" WHERE guid IN (${placeholders})`,guids],[`DELETE FROM "_guidToTable" WHERE tableName = "${entity}" AND guid IN (${placeholders})`,guids]]}function createInsertSqlQueries(objectJson,dirty=!1){return[createEntitySql(objectJson,mx.meta.getEntity(objectJson.objectType)),createMetaSql(objectJson,dirty)]}function createEntitySql(objectJson,metadata){const columns=['"guid"'],params=[objectJson.guid];return Object.entries(objectJson.attributes).filter(([key])=>metadata.getAttributes().includes(key)).forEach(([key,{value:value}])=>{columns.push(`"${toSafeKey(key)}"`),params.push(runtimeToSql(value,metadata.getAttributeType(key)))}),[`INSERT OR REPLACE INTO "${toSafeKey(objectJson.objectType)}" (${columns.join(", ")}) VALUES (${new Array(params.length).fill("?").join(", ")})`,params]}function createMetaSql(objectJson,dirty){const readonlyAttrs=Object.keys(objectJson.attributes).filter(attr=>objectJson.attributes[attr].readonly);return['INSERT OR REPLACE INTO "_guidToTable" ("guid", "tableName", "dirty", "readonlyAttrs") VALUES (?, ?, ?, ?)',[objectJson.guid,objectJson.objectType,booleanToSql(dirty),JSON.stringify(readonlyAttrs)]]}function createGetEntitiesSql(guids){if(0===guids.length)throw new AssertionError("No guids specified");return[`SELECT "guid", "tableName" FROM "_guidToTable" WHERE "guid" IN (${new Array(guids.length).fill("?").join(", ")})`,guids]}function isPushToClientInstruction(inst){return"push_to_client"===inst.type}function getGuidsPushedToClient(instructions){return instructions.filter(isPushToClientInstruction).flatMap(instruction=>instruction.args.guids)}async function executePushToClientInstruction(database,runtimeResponse,objectCache,tempObjsRuntimeToOfflineMap,syncedObjsRuntimeToOfflineMap,offlineConfig){var _a;const runtimeGuidsToPush=unique(getGuidsPushedToClient(null!==(_a=runtimeResponse.instructions)&&void 0!==_a?_a:[]));if(0===runtimeGuidsToPush.length)return;const isOfflineEntity=function(offlineConfig){const alreadyLoggedEntityWarnings=[];return entity=>void 0!==entity&&(!!offlineConfig.schema.includes(entity)||(alreadyLoggedEntityWarnings.includes(entity)||(alreadyLoggedEntityWarnings.push(entity),mx.logger.warn(`Object of type ${entity} cannot be pushed to client, skipping it.`)),!1))}(offlineConfig),tx=function(pushedGuidsToUpdate,tempObjsRuntimeToOfflineMap,objectCache,offlineEntities){let tx=new Transaction;return pushedGuidsToUpdate.forEach(pushedGuid=>{const offlineGuid=tempObjsRuntimeToOfflineMap.map(pushedGuid),entityAssociationsPairs=function(targetEntity,entities){const targetEntityWithSupers=[targetEntity,...mx.meta.getEntity(targetEntity).getSuperEntities()];return Object.assign({},...entities.map(entity=>{const meta=mx.meta.getEntity(entity),associationsReferencingObjectType=meta.getReferenceAttributes().filter(refAttribute=>targetEntityWithSupers.includes(meta.getSelectorEntity(refAttribute)));return associationsReferencingObjectType.length>0?{[meta.getEntity()]:associationsReferencingObjectType}:{}}))}(ensure(objectCache.getObject(offlineGuid)).getEntity(),offlineEntities);Object.keys(entityAssociationsPairs).forEach(entity=>{entityAssociationsPairs[entity].forEach(association=>{const updates={[association]:pushedGuid},[sqlQuery,params]=function(metadata,updates,whereAttributeName,whereAttributeValue){if(0===Object.keys(updates).length)throw new AssertionError("No updates specified.");const params=[],updateStrings=[];Object.entries(updates).forEach(([attribute,value])=>{updateStrings.push(`"${toSafeKey(attribute)}" = ?`),params.push(runtimeToSql(value,metadata.getAttributeType(attribute)))});const tableName=toSafeKey(metadata.getEntity()),whereExpr=`WHERE ${tableName}.[${toSafeKey(whereAttributeName)}] = ?`;return params.push(attributeToSql(whereAttributeValue)),[`UPDATE ${tableName} SET ${updateStrings.join(", ")} ${whereExpr}`,params]}(mx.meta.getEntity(entity),updates,association,offlineGuid);tx=tx.chain(()=>executeSql(sqlQuery,params))})})}),tx}(runtimeGuidsToPush.filter(runtimeGuid=>tempObjsRuntimeToOfflineMap.has(runtimeGuid)),tempObjsRuntimeToOfflineMap,objectCache,offlineConfig.schema).chain(()=>executeSql(...createGetEntitiesSql(runtimeGuidsToPush.map(runtimeGuid=>tempObjsRuntimeToOfflineMap.map(runtimeGuid))))).chain(rows=>Object.assign({},...rows.map(row=>({[row.guid]:row.tableName})))).chain(guidToEntityMap=>{const toInsert={},toDelete={};let innerTx=new Transaction;return runtimeGuidsToPush.forEach(runtimeGuid=>{var _a,_b;const objectToPush=null===(_a=runtimeResponse.objects)||void 0===_a?void 0:_a.find(obj=>obj.guid===runtimeGuid),maybeOfflineGuid=tempObjsRuntimeToOfflineMap.map(runtimeGuid),entity=null!==(_b=null==objectToPush?void 0:objectToPush.objectType)&&void 0!==_b?_b:guidToEntityMap[maybeOfflineGuid];isOfflineEntity(entity)&&(void 0===toDelete[entity]&&(toDelete[entity]=[]),toDelete[entity].push(maybeOfflineGuid)),isOfflineEntity(null==objectToPush?void 0:objectToPush.objectType)&&(void 0===toInsert[entity]&&(toInsert[entity]=[]),toInsert[entity].push(objectToPush))}),Object.keys(toDelete).forEach(entity=>{const[deleteObjectsSql,deleteMetadataSql]=createDeleteSqlQueries(entity,toDelete[entity]);innerTx=innerTx.chain(()=>executeSql(...deleteObjectsSql)).chain(()=>executeSql(...deleteMetadataSql))}),Object.keys(toInsert).forEach(entity=>{toInsert[entity].forEach(objectToPush=>{const[insertObjectSql,insertMetadataSql]=createInsertSqlQueries(objectToPush);innerTx=innerTx.chain(()=>executeSql(...insertObjectSql)).chain(()=>executeSql(...insertMetadataSql))})}),innerTx});await tx.write(database),runtimeGuidsToPush.filter(runtimeGuid=>{var _a;return null===(_a=runtimeResponse.objects)||void 0===_a?void 0:_a.every(obj=>obj.guid!==runtimeGuid)}).forEach(runtimeGuid=>{let cachedGuid=runtimeGuid;tempObjsRuntimeToOfflineMap.has(runtimeGuid)?cachedGuid=tempObjsRuntimeToOfflineMap.map(runtimeGuid):syncedObjsRuntimeToOfflineMap.has(runtimeGuid)&&(cachedGuid=syncedObjsRuntimeToOfflineMap.map(runtimeGuid));const cachedObj=objectCache.getObject(cachedGuid);null!==cachedObj&&cachedObj.markAsUnavailable()}),runtimeGuidsToPush.filter(runtimeGuid=>tempObjsRuntimeToOfflineMap.has(runtimeGuid)).forEach(runtimeGuid=>syncedObjsRuntimeToOfflineMap.add(runtimeGuid,tempObjsRuntimeToOfflineMap.map(runtimeGuid))),runtimeGuidsToPush.forEach(runtimeGuid=>unmarkAsDirty(tempObjsRuntimeToOfflineMap.map(runtimeGuid)))}function isEntityUpdate(update){return"entity"in update}function isObjectUpdate(update){return"guid"in update}function shouldGenerateUpdateFor(entity,offlineEntities){return!mx.meta.getEntity(entity).isPersistable()||offlineEntities.includes(entity)}function findObjectType(guid,offlineResponse){return offlineResponse.objects.find(objJson=>objJson.guid===guid).objectType}async function handleOfflineSuccess(objectCache,offlineResponse,offlineEntities,database){const updates=await async function(offlineResponse,offlineEntities,objectCache,database){var _a,_b;const updates=gatherUpdates(objectCache,offlineResponse),guidsToPush=unique(null!==(_b=null===(_a=offlineResponse.instructions)||void 0===_a?void 0:_a.filter(isPushToClientInstruction).flatMap(instruction=>instruction.args.guids))&&void 0!==_b?_b:[]),[availableGuids,unavailableGuids]=partition(guid=>function(guid,offlineResponse){var _a;return!0===(null===(_a=offlineResponse.objects)||void 0===_a?void 0:_a.some(obj=>obj.guid===guid))}(guid,offlineResponse),guidsToPush),guidToEntityMap=Object.assign({},...availableGuids.map(guid=>({[guid]:findObjectType(guid,offlineResponse)})));if(unavailableGuids.length>0){(await executeSql(...createGetEntitiesSql(unavailableGuids)).read(database)).forEach(row=>{guidToEntityMap[row.guid]=row.tableName})}const entityUpdates=unique(updates.filter(isEntityUpdate).map(entityUpdate=>entityUpdate.entity).concat(Object.values(guidToEntityMap))).filter(entity=>shouldGenerateUpdateFor(entity,offlineEntities)).map(entity=>({entity:entity})),guidsToObjectUpdate=Object.entries(guidToEntityMap).filter(([_,entity])=>shouldGenerateUpdateFor(entity,offlineEntities)).map(([guid])=>guid),objectUpdates=unique(updates.filter(isObjectUpdate).map(update=>update.guid).concat(guidsToObjectUpdate)).filter(guid=>objectCache.has(guid)).map(guid=>({guid:guid}));return[...updates.filter(u=>"attr"in u&&!guidsToObjectUpdate.includes(u.guid)),...objectUpdates,...entityUpdates]}(offlineResponse,offlineEntities,objectCache,database);return await handleState(objectCache,offlineResponse),updates}const syncedObjsRuntimeToOfflineMap=new GuidMapping;function getRuntimeGuid(offlineGuid){return syncedObjsRuntimeToOfflineMap.reverse().map(offlineGuid)}async function executeOfflineMicroflow(name,mgArgs,objectCache,database){const microflowParameterGuids=getGuidsFromMicroflowArguments(mgArgs);if(microflowParameterGuids.some(guid=>!objectCache.has(guid)))throw new AssertionError("Microflow parameter is not available in the client state");const reachableGuidsForRequest=findReachableGuidsForRequest(objectCache.getAllObjects(),microflowParameterGuids);if(reachableGuidsForRequest.filter(wasGuidSynced).map(guid=>mx.meta.getEntity(objectCache.getObject(guid).getEntity())).some(meta=>!meta.isPersistable()))throw new DescribedError("Non-persistable objects created in a microflow can't be passed to another microflow");const syncedObjsOfflineToRuntimeMap=syncedObjsRuntimeToOfflineMap.reverse(),unsyncedOfflineParameterObjs=reachableGuidsForRequest.filter(guid=>!wasGuidSynced(guid)&&!syncedObjsOfflineToRuntimeMap.has(guid)).map(guid=>objectCache.getObject(guid).jsonData),[instantiatedObjs,unsyncedParameterObjsOfflineToRuntimeMap]=await instantiateObjects(unsyncedOfflineParameterObjs),allOfflineToRuntimeMap=new GuidMapping;allOfflineToRuntimeMap.import(syncedObjsOfflineToRuntimeMap),allOfflineToRuntimeMap.import(unsyncedParameterObjsOfflineToRuntimeMap);const changes=function(guids,objectCache,allOfflineToRuntimeMap){const changes={};return guids.forEach(guid=>{const objJson=objectCache.getObject(guid).jsonData,meta=mx.meta.getEntity(objJson.objectType),originalValuesAsChanges=createChange(objJson),runtimeGuid=allOfflineToRuntimeMap.map(objJson.guid);changes[runtimeGuid]=allOfflineToRuntimeMap.mapChange(originalValuesAsChanges,meta);const mappedRealChange=allOfflineToRuntimeMap.mapChange(objectCache.getChanges(guid),meta);Object.keys(mappedRealChange).filter(attr=>meta.isSyncable(attr)).forEach(attr=>{changes[runtimeGuid][attr]=mappedRealChange[attr]})}),changes}(reachableGuidsForRequest,objectCache,allOfflineToRuntimeMap),runtimeResponse=await async function(name,args,validationGuids,changes,objects,asyncId){return post(xasUrl(),{action:"executemicroflow",params:{name:name,params:args,validationGuids:validationGuids,asyncid:asyncId},changes:changes,objects:objects})}(name,function(parameters,mapping){const result={};return Object.keys(parameters).forEach(name=>{const value=parameters[name];result[name]="guid"in value?{guid:mapping.map(value.guid)}:"guids"in value?{guids:mapping.map(value.guids)}:value}),result}(mgArgs,allOfflineToRuntimeMap),[],changes,instantiatedObjs),offlineResponse=function({actionResult:actionResult,objects:objects=[],changes:changes={},commits:commits=[],resets:resets={},deletes:deletes=[],instructions:instructions=[]},objectCache){const guidsPushedToClient=getGuidsPushedToClient(instructions),nonPersistableGuids=filterNonPersistableGuids(unique([...objects.map(obj=>obj.guid),...Object.keys(changes),...Object.keys(resets),...deletes]),objects,objectCache),offlineMicroflowResponseGuids=guidsPushedToClient.concat(nonPersistableGuids);return{actionResult:actionResult,newpersistable:[],commits:filterGuids(commits,offlineMicroflowResponseGuids),committedObjectsOmitted:!1,deletes:filterGuids(deletes,offlineMicroflowResponseGuids),changes:filterKeys(changes,offlineMicroflowResponseGuids),resets:filterKeys(resets,offlineMicroflowResponseGuids),instructions:filterInstructions(instructions,objects,objectCache),objects:objects.filter(obj=>offlineMicroflowResponseGuids.includes(obj.guid))}}(function({actionResult:actionResult,objects:objects=[],changes:changes={},commits:commits=[],committedObjectsOmitted:committedObjectsOmitted=!1,resets:resets={},deletes:deletes=[],newpersistable:newpersistable=[],instructions:instructions=[]},runtimeToOfflineMapping,objectCache){const mappedResponse={commits:runtimeToOfflineMapping.map(commits),committedObjectsOmitted:committedObjectsOmitted,deletes:runtimeToOfflineMapping.map(deletes),newpersistable:runtimeToOfflineMapping.map(newpersistable),instructions:remapInstructions(instructions,runtimeToOfflineMapping),objects:objects.map(objJson=>runtimeToOfflineMapping.mapMxObjectJSON(objJson)),changes:remapResponseChanges(changes,objects,objectCache,runtimeToOfflineMapping),resets:remapResets(resets,runtimeToOfflineMapping)};actionResult&&(mappedResponse.actionResult=function(result,runtimeToOfflineMapping){if(null===result.value)return result;switch(result.type){case"ObjectReference":case"ObjectReferenceSet":return{type:result.type,value:runtimeToOfflineMapping.map(result.value)};default:return result}}(actionResult,runtimeToOfflineMapping));return mappedResponse}(runtimeResponse,allOfflineToRuntimeMap.reverse(),objectCache),objectCache),offlineConfig=ensure(mx.session.getOfflineConfig());await executePushToClientInstruction(database,runtimeResponse,objectCache,unsyncedParameterObjsOfflineToRuntimeMap.reverse(),syncedObjsRuntimeToOfflineMap,offlineConfig);const updates=await handleOfflineSuccess(objectCache,offlineResponse,offlineConfig.schema,database);updates.length>0&&await publish(...updates);const result=offlineResponse.actionResult;return null==result?void 0:runtimeValueToExpressionVariable(result.value,result.type,guid=>ensure(objectCache.getObject(guid)))}function filterNonPersistableGuids(guids,objects,objectCache){return guids.filter(guid=>{var _a,_b;const object=null!==(_a=objects.find(o=>o.guid===guid))&&void 0!==_a?_a:null===(_b=objectCache.getObject(guid))||void 0===_b?void 0:_b.jsonData;return object&&mx.meta.hasEntity(object.objectType)&&!mx.meta.getEntity(object.objectType).isPersistable()})}function filterGuids(guids,filterList){return guids.filter(guid=>filterList.includes(guid))}function filterKeys(responsePart,filterList){return Object.assign({},...Object.keys(responsePart).filter(guid=>filterList.includes(guid)).map(guid=>({[guid]:responsePart[guid]})))}function filterInstructions(instructions,objects,objectCache){return instructions.flatMap(instruction=>{switch(instruction.type){case"refresh_class":const classnames=instruction.args.classnames.filter(entity=>mx.meta.hasEntity(entity)&&!mx.meta.getEntity(entity).isPersistable());return classnames.length>0?[Object.assign(Object.assign({},instruction),{args:{classnames:classnames}})]:[];case"refresh_object_list":const nonPersistableGuids=filterNonPersistableGuids(instruction.args.ObjectIds,objects,objectCache);return nonPersistableGuids.length>0?[Object.assign(Object.assign({},instruction),{args:{ObjectIds:nonPersistableGuids}})]:[];case"push_to_client":return instruction;default:return[]}})}function remapResponseChanges(responseChanges,responseObjects,cache,runtimeToOfflineMapping){return Object.assign({},...Object.keys(responseChanges).map(guid=>{var _a;const entity=(null!==(_a=responseObjects.find(o=>o.guid===guid))&&void 0!==_a?_a:ensure(cache.getObject(runtimeToOfflineMapping.map(guid))).jsonData).objectType;return mx.meta.hasEntity(entity)?{[runtimeToOfflineMapping.map(guid)]:runtimeToOfflineMapping.mapChange(responseChanges[guid],mx.meta.getEntity(entity))}:{[guid]:responseChanges[guid]}}))}function remapResets(resetsToRemap,runtimeToOfflineMapping){return Object.assign({},...Object.keys(resetsToRemap).map(guid=>({[runtimeToOfflineMapping.map(guid)]:resetsToRemap[guid]})))}function remapInstructions(responseInstructions,runtimeToOfflineMapping){return responseInstructions.map(instruction=>{switch(instruction.type){case"refresh_object_list":return Object.assign(Object.assign({},instruction),{args:{ObjectIds:runtimeToOfflineMapping.map(instruction.args.ObjectIds)}});case"push_to_client":return Object.assign(Object.assign({},instruction),{args:{guids:runtimeToOfflineMapping.map(instruction.args.guids)}});default:return instruction}})}const ONE={type:"int",expr:"1",params:[]},ZERO={type:"int",expr:"0",params:[]};function toIntOrStringResult(result){return"null"===result.type?{type:"int",expr:"0",params:[]}:result}function castAsInt(result){return"string"===result.type?{type:"int",expr:`cast(${result.expr} as integer)`,params:result.params}:result}function combineParams(...args){return[].concat(...args.map(a=>a.params))}class SelectQueryBuilder{constructor(entity){this.attrs=[],this.tableName=toSafeKey(entity),this.fromClause=`FROM ${this.tableName} AS ${this.tableName}`}filtered(filter){const{type:type,expr:expr,params:params}=function toSqlFilter(filter,tableName){switch(filter.type){case"attribute":return{type:"Boolean"===filter.attributeType||"DateTime"===filter.attributeType?"int":"string",expr:`${tableName}.[${"id"!==filter.attribute?toSafeKey(filter.attribute):"guid"}]`,params:[]};case"value":const value=attributeToSql(filter.value);return null===value?{type:"null",expr:"NULL",params:[]}:{type:"number"==typeof value?"int":"string",expr:"?",params:[value]};case"function":const args=filter.parameters.map(p=>toSqlFilter(p,tableName));switch(filter.name){case"true":return ONE;case"false":return ZERO;case"not":{const arg1=toIntOrStringResult(args[0]);return{type:"int",expr:`(not ${arg1.expr})`,params:arg1.params}}case"or":case"and":{const fixedArgs=args.map(toIntOrStringResult);return{type:"int",expr:"("+fixedArgs.map(a=>a.expr).join(` ${filter.name} `)+")",params:combineParams(...fixedArgs)}}case"=":case"!=":case">":case">=":case"<":case"<=":{const[arg1,arg2]=args.some(a=>"int"===a.type)?args.map(castAsInt):args,operation="="===filter.name?"is":"!="===filter.name?"is not":filter.name;return{type:"int",expr:`(${arg1.expr} ${operation} ${arg2.expr})`,params:combineParams(arg1,arg2)}}case"contains":case"starts-with":case"ends-with":{if("null"===args[1].type)return ONE;if("null"===args[0].type)return ZERO;const expected=`replace(replace(replace(${args[1].expr}, "${escapeChar="~"}", "${escapeChar+escapeChar}"), "%", "${escapeChar+"%"}"), "_", "${escapeChar+"_"}")`,like="starts-with"===filter.name?expected+" || '%'":"ends-with"===filter.name?"'%' || "+expected:`'%' || ${expected} || '%'`;return{type:"int",expr:`(${args[0].expr} like ${like} escape '~')`,params:args[0].params.concat(args[1].params)}}case"length":case"string-length":return"null"===args[0].type?ZERO:{type:"int",expr:`length(${args[0].expr})`,params:args[0].params};default:throw new AssertionError(`Operator ${filter.name} is not yet supported`)}}var escapeChar}(filter,this.tableName);return"null"!==type&&(this.whereClause="WHERE "+expr,this.bindParameters=params),this}sorted(sort){const sortStr=sort.map(([attr,order])=>`${this.tableName}.[${toSafeKey(attr)}] ${order}`).join(", ");return this.orderClause=sortStr?"ORDER BY "+sortStr:"",this}paged(offset,amount){return this.limitClause=`LIMIT ${void 0!==amount?amount:-1} OFFSET ${null!=offset?offset:0}`,this}attributes(attributes){return this.attrs=attributes,this}buildSelectWithMeta(){var _a;return[["SELECT",this.attrs.map(col=>`${this.tableName}.[${toSafeKey(col)}] as "${toSafeKey(col)}"`).concat(METADATA_COLUMNS.map(col=>`_guidToTable.[${col}] as "_guidToTable.${col}"`)).join(", "),this.fromClause,"JOIN _guidToTable AS _guidToTable USING (guid)",this.whereClause,this.orderClause,this.limitClause].filter(s=>s).join(" "),null!==(_a=this.bindParameters)&&void 0!==_a?_a:[]]}buildCount(){var _a;return[['SELECT COUNT("guid") AS count',this.fromClause,this.whereClause].filter(s=>s).join(" "),null!==(_a=this.bindParameters)&&void 0!==_a?_a:[]]}}class OfflineData{constructor(objectCache,database){this.objectCache=objectCache,this.database=database}async retrieve(entity,filter,options){const meta=mx.meta.getEntity(entity),queryBuilder=new SelectQueryBuilder(entity).attributes(meta.getAttributes());void 0!==filter&&queryBuilder.filtered(filter),void 0===options.offset&&void 0===options.amount||queryBuilder.paged(options.offset,options.amount),void 0!==options.sort&&queryBuilder.sorted(options.sort);const selectQuery=queryBuilder.buildSelectWithMeta(),countQuery=queryBuilder.buildCount(),{rows:rows,count:count}=await executeSql(...selectQuery).chain(rowsResult=>executeSql(...countQuery).chain(countRows=>({rows:rowsResult,count:countRows[0].count}))).read(this.database),objJsons=rows.map(r=>syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(function(meta,row){const result={guid:row["_guidToTable.guid"],objectType:meta.getEntity(),attributes:{}},readonlyAttributes=JSON.parse(row["_guidToTable.readonlyAttrs"])||[];return Object.keys(row).filter(attrKey=>!attrKey.startsWith("_guidToTable")).forEach(attrKey=>{const attr=attrKey.replace("$",".");const attrType=meta.getAttributeType(attr);result.attributes[attr]=Object.assign({value:sqlToRuntime(row[attrKey],attrType)},readonlyAttributes.includes(attr)?{readonly:!0}:{})}),result}(meta,r)));return this.objectCache.setMxObjects(objJsons),{mxobjs:objJsons.map(json=>ensure(this.objectCache.getObject(json.guid))),count:count}}async executeMicroflow(name,args){return executeOfflineMicroflow(name,args,this.objectCache,this.database)}}const memoized={};const DEFAULT_ATTRIBUTE_VALUES={String:null,Integer:"0",Long:"0",Decimal:"0",Enum:null,HashString:null,ObjectReference:null,DateTime:null,Boolean:!1,AutoNumber:"0",Binary:null};class OfflineDataBackend extends class{getByGuid(guids,filter){return Promise.reject(new NotImplementedError("getByGuid"))}getByPath(guid,path,entity,direction){return Promise.reject(new NotImplementedError("getByPath"))}getByXPath(xpath,filter,wantCount){return Promise.reject(new NotImplementedError("getByXPath"))}getSlice(entity,constraints,filter,useCache){return Promise.reject(new NotImplementedError("getSlice"))}action(params,context,targetForm,async,onValidation){return Promise.reject(new NotImplementedError("action"))}create(entity){return Promise.reject(new NotImplementedError("create"))}commit(guids,context,targetForm,onValidation){return Promise.reject(new NotImplementedError("commit"))}rollback(guids){return Promise.reject(new NotImplementedError("rollback"))}remove(guids){return Promise.reject(new NotImplementedError("remove"))}validate(guids){return Promise.reject(new NotImplementedError("validate"))}saveDocument(guid,name,params,blob){return Promise.reject(new NotImplementedError("saveDocument"))}generateReport(reportId,offset,limit,params){return Promise.reject(new NotImplementedError("generateReport"))}generateExcelReport(reportId,params){return Promise.reject(new NotImplementedError("generateExcelReport"))}getReportParameters(reportId){return Promise.reject(new NotImplementedError("getReportParameters"))}getDocumentUrl(guid,changedDate,isThumb){throw new NotImplementedError("getDocumentUrl")}getImageUrl(url){return Promise.reject(new NotImplementedError("getImageUrl"))}upload(){return Promise.reject(new NotImplementedError("upload"))}download(fetchConfig){return Promise.reject(new NotImplementedError("download"))}cleanupDirtyObjects(){return Promise.reject(new NotImplementedError("cleanupDirtyObjects"))}cleanup(){return Promise.reject(new NotImplementedError("cleanup"))}}{constructor(objectCache,store,fileBackend,synchronizer,getDocumentUrlFn){super(),this._store=store,this._getDocumentUrl=getDocumentUrlFn||getDefaultDocumentUrl,this._objectCache=objectCache,this._fileBackend=fileBackend,this._synchronizer=synchronizer}async initialize(){const dirtyObjs=await this._store.fetchDirty();markAsDirty(dirtyObjs.map(obj=>obj.guid))}async getByGuid(externalGuids,filter){const mxobjs=(await Promise.all(externalGuids.map(guid=>this._getByGuid(guid)))).filter(obj=>null!=obj).map(obj=>objectToJson(obj));return this._objectCache.setMxObjects(mxobjs),{mxobjs:mxobjs.map(({guid:guid})=>this._objectCache.getObject(guid)),count:mxobjs.length}}async getByPath(guid,path,entity,direction){const steps=path.split("/"),association=1===steps.length?path:steps[0];if("reverse"===direction){const cachedMxObjectsReferencingRoot=this._objectCache.getAllObjects().filter(mxobj=>mxobj.getReferences(association).includes(guid)),uncachedMxObjectsReferencingRoot=(window.mx.meta.getEntity(entity).isPersistable()?(await this.getSlice(entity,[{attribute:association,operator:"equals",value:guid}])).mxobjs:[]).filter(storedMxObject=>storedMxObject.getReferences(association).includes(guid)).filter(storedMxObject=>!cachedMxObjectsReferencingRoot.some(cachedObj=>cachedObj.getGuid()===storedMxObject.getGuid()));this._objectCache.setMxObjects(uncachedMxObjectsReferencingRoot.map(mxobj=>mxobj.jsonData));const resultMxobjs=cachedMxObjectsReferencingRoot.concat(uncachedMxObjectsReferencingRoot);return{mxobjs:resultMxobjs,count:resultMxobjs.length}}{let rootMxObj=this._objectCache.getObject(guid);if(!rootMxObj){const{mxobjs:[storedRootObj]}=await this.getByGuid([guid]);storedRootObj&&(rootMxObj=storedRootObj)}if(!rootMxObj)return{mxobjs:[],count:0};const refGuids=rootMxObj.getReferences(association),cachedRefMxobjs=refGuids.map(refGuid=>this._objectCache.getObject(refGuid)).filter(mxobj=>null!==mxobj),uncachedRefGuids=refGuids.filter(refGuid=>!this._objectCache.has(refGuid)),{mxobjs:storedRefMxobjs}=await this.getByGuid(uncachedRefGuids),refMxobjs=storedRefMxobjs.concat(cachedRefMxobjs);return this._objectCache.setMxObjects(storedRefMxobjs.map(mxobj=>mxobj.jsonData)),{mxobjs:refMxobjs,count:refMxobjs.length}}}async getSlice(entity,constraints,filter,useCache){const meta=window.mx.meta.getEntity(entity),[resultObjects,count]=await this._store.getSlice(entity,(constraints||[]).map(ct=>function mapConstraint(c){if(c.attribute&&meta.isReference(c.attribute))return Object.assign({},c,{value:getRuntimeGuid(c.value)});if(Array.isArray(c.constraints))return Object.assign({},c,{constraints:c.constraints.map(ct=>mapConstraint(ct))});return c}(ct)),filter),objects=resultObjects.map(objectToJson).map(json=>syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(json));let mxobjs=[];return useCache?(this._objectCache.setMxObjects(objects),mxobjs=objects.map(jsonObj=>this._objectCache.getObject(jsonObj.guid))):mxobjs=objects.map(MxObject.fromJson),{mxobjs:mxobjs,count:count}}create(entity){const externalGuid="GUID:"+getUniqueId();return this._objectCache.onCreate([externalGuid]),this._objectCache.setMxObjects([createNewJson(externalGuid,entity)]),Promise.resolve(this._objectCache.getObject(externalGuid))}async commit(commitGuids,context){const commitChanges=objectFromArray(commitGuids.map(guid=>[guid,this._objectCache.getChanges(guid)])),[cachedCommitGuids,uncachedCommitGuids]=partition(guid=>this._objectCache.has(guid),commitGuids),cachedCommitObjs=cachedCommitGuids.map(guid=>this._objectCache.getObject(guid)),[peObjsFromCache,npeObjsFromCache]=partition(obj=>obj.isPersistable(),cachedCommitObjs),originalCachedCommitObjs=peObjsFromCache.map(mxObjectToObj),persistableCommitObjs=(await Promise.all(uncachedCommitGuids.map(guid=>this._getByGuid(guid)))).concat(originalCachedCommitObjs).map(applyChanges);persistableCommitObjs.length>0&&(await this._store.insertOrReplace(persistableCommitObjs.map(obj=>jsonToObject(syncedObjsRuntimeToOfflineMap.reverse().mapMxObjectJSON(objectToJson(obj))))),markAsDirty(persistableCommitObjs.map(obj=>obj.guid)),this._objectCache.setMxObjects(persistableCommitObjs.map(obj=>objectToJson(obj))));const nonPersistableCommitObjs=npeObjsFromCache.map(mxObjectToObj).map(applyChanges);return this._objectCache.setMxObjects(nonPersistableCommitObjs.map(obj=>objectToJson(obj))),this._objectCache.onCommit(commitGuids),this._objectCache.removeChanges(function(changes){const resets={};return Object.keys(changes).forEach(guid=>{resets[guid]=Object.keys(changes[guid])}),resets}(commitChanges)),{};function applyChanges(obj){return Object.assign({},obj,mapObject(commitChanges[obj.guid],change=>change.value))}}rollback(rollbackGuids){this._objectCache.removeAllChanges(rollbackGuids);const newRollbackGuids=rollbackGuids.filter(guid=>this._objectCache.isNew(guid));return this._objectCache.removeObjects(newRollbackGuids),Promise.resolve({})}validate(validateGuids){return Promise.resolve({})}async saveDocument(documentGuid,name,params,blob){if(blob.size/1048576>params.maxFileSize)throw new DescribedError("File too large");const obj=await this._getByGuid(documentGuid),fileName=getFsFileName(getRuntimeGuid(documentGuid),obj?obj.changedDate:void 0);await this._fileBackend.storeFile(blob,this._fileBackend.toAbsolutePath("documents/"+fileName)),this._objectCache.makeChange(documentGuid,"HasContents",!0),await this.commit([documentGuid],null)}getDocumentUrl(offlineGuid,changedDate,isThumb){return this._getDocumentUrl(getFsFileName(getRuntimeGuid(offlineGuid),changedDate),changedDate,isThumb)}getImageUrl(url){return Promise.resolve(url)}upload(){return this._synchronizer.upload()}async download(uploadedObjsEntityToGuidsMap,fullReset){const updates=await this._synchronizer.download(uploadedObjsEntityToGuidsMap,fullReset);clearDirtyGuids(),await publish(...updates)}cleanupDirtyObjects(){return this._store.cleanupDirtyObjects()}async cleanup(){await this._store.cleanDatabase(),await this._fileBackend.removeDir(this._fileBackend.toAbsolutePath("documents")),await this._fileBackend.removeDir(this._fileBackend.toAbsolutePath("thumbnails")),clearDirtyGuids()}_getByGuid(offlineGuid){return async function(key,computation){const keyStr=JSON.stringify(key);return keyStr in memoized?memoized[keyStr]:memoized[keyStr]=withFinally(computation(key),()=>{delete memoized[keyStr]})}(offlineGuid,()=>this._store.getByGuid(getRuntimeGuid(offlineGuid)).then(obj=>null===obj?null:jsonToObject(syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(objectToJson(obj)))))}}function mxObjectToObj(mxobj){return jsonToObject(mxobj.jsonData)}function createNewJson(guid,entity){const json={guid:guid,objectType:entity,attributes:{}},meta=window.mx.meta.getEntity(entity);return meta.getAttributes().forEach(attr=>{json.attributes[attr]={value:DEFAULT_ATTRIBUTE_VALUES[meta.getAttributeType(attr)],readonly:meta.isAttributeReadonly(attr)}}),json}function getDefaultDocumentUrl(fileName,changedDate,isThumb){var dir="files/"+(isThumb?"thumbnails":"documents");return`filesystem:${window.mx.appUrl}temporary/${dir}/${fileName}?${Date.now()}`}class SqlSelectBuilder{constructor(other,params){this._select=params&&params.select||other&&other._select||null,this._from=params&&params.from||other&&other._from||null,this._join=params&&params.join||other&&other._join||null,this._constraints=params&&params.constraints||other&&other._constraints||[],this._orderBy=params&&params.orderBy||other&&other._orderBy||[],this._limit=params&&params.limit||other&&other._limit||null,this._offset=params&&params.offset||other&&other._offset||null}from(tableName){return new SqlSelectBuilder(this,{from:tableName})}join(tableName,joinOnColumn,selectedColumns){return new SqlSelectBuilder(this,{join:{tableName:tableName,joinOnColumn:joinOnColumn,selectedColumns:selectedColumns}})}where(constraints){return new SqlSelectBuilder(this,{constraints:this._constraints.concat(constraints)})}order(column,direction){return new SqlSelectBuilder(this,{orderBy:this._orderBy.concat([[column,direction]])})}limit(n){return new SqlSelectBuilder(this,{limit:n})}offset(n){return new SqlSelectBuilder(this,{offset:n})}selectDistinct(what){return Array.isArray(what)&&(what=what.join(", ")),`SELECT DISTINCT ${what} ${this._buildSql()}`}selectCount(alias){return"SELECT COUNT(*) AS "+alias+this._buildSql()}select(){let select=`SELECT ${this._from}.*`;return this._join&&this._join.selectedColumns.forEach(col=>{select+=`, ${this._join.tableName}.[${col}] as "${this._join.tableName}.${col}"`}),select+this._buildSql()}_buildSql(){let sql=` FROM ${this._from} AS ${this._from}`;return this._join&&(sql+=` JOIN ${this._join.tableName} AS ${this._join.tableName} USING (${this._join.joinOnColumn})`),this._constraints.length>0&&(sql+=" WHERE "+this._constraints.map(constraint=>constraint.build(this._from)).join(" AND ")),this._orderBy.length>0&&(sql+=" ORDER BY "+this._orderBy.map(sortItem=>`${this._from}.[${sortItem[0]}] ${sortItem[1]}`).join(", ")),(this._limit||this._offset)&&(sql+=" LIMIT "+(this._limit||-1)),this._offset&&(sql+=" OFFSET "+this._offset),sql}}const OPERATOR_FN_MAP={equals:columnSimpleCompare("="),lessThan:columnSimpleCompare("<"),lessThanOrEquals:columnSimpleCompare("<="),greaterThan:columnSimpleCompare(">"),greaterThanOrEquals:columnSimpleCompare(">="),contains:function(column){let constraint="";return constraint+=column,constraint+=" LIKE '%' || ? || '%'",constraint+=" ESCAPE '~'",constraint}};class OperatorConstraint{constructor(column,operator,negate){this._column=column,this._operator=operator,this._negate=!!negate}build(from){const constraintFn=OPERATOR_FN_MAP[this._operator],column=this._column.indexOf(".")>-1?this._column:`${from}.[${this._column}]`;return(this._negate?"NOT ":"")+constraintFn(column)}}class NullConstraint{constructor(column,negate){this._column=column,this._negate=!!negate}build(from){return(this._column.indexOf(".")>-1?this._column:`${from}.[${this._column}]`)+" IS "+(this._negate?"NOT ":"")+"NULL"}}class GroupConstraint{constructor(group,constraints){this.group=group,this.constraints=constraints||[]}add(constraint){this.constraints.push(constraint)}build(from){return"("+this.constraints.map(c=>c.build(from)).join(` ${this.group} `)+")"}}const constraintBuilder={and:constraints=>new GroupConstraint("and",constraints),or:constraints=>new GroupConstraint("or",constraints),equals:(column,negate)=>new OperatorConstraint(column,"equals",negate),isNull:(column,negate)=>new NullConstraint(column,negate),lessThan:(column,negate)=>new OperatorConstraint(column,"lessThan",negate),lessThanOrEquals:(column,negate)=>new OperatorConstraint(column,"lessThanOrEquals",negate),greaterThan:(column,negate)=>new OperatorConstraint(column,"greaterThan",negate),greaterThanOrEquals:(column,negate)=>new OperatorConstraint(column,"greaterThanOrEquals",negate),contains:(column,negate)=>new OperatorConstraint(column,"contains",negate)};function columnSimpleCompare(operator){return function(column){return column+" "+operator+" ?"}}function SqlCreateBuilder(other,params){this._tableName=params&&params.tableName||other&&other._tableName||null,this._columns=params&&params.columns||other&&other._columns||[]}function quoteIdentifier(identifier){return'"'+identifier+'"'}function Task(f){this.fork=f}SqlCreateBuilder.prototype.table=function(tableName){return new SqlCreateBuilder(this,{tableName:tableName})},SqlCreateBuilder.prototype.column=function(columnName,columnType){return new SqlCreateBuilder(this,{columns:this._columns.concat({columnName:columnName,columnType:columnType,isPrimary:!1})})},SqlCreateBuilder.prototype.primaryKeyColumn=function(primaryKeyName,primaryKeyType){return new SqlCreateBuilder(this,{columns:this._columns.concat({columnName:primaryKeyName,columnType:primaryKeyType,isPrimary:!0})})},SqlCreateBuilder.prototype.createIfNotExists=function(){var sqlStr="";return sqlStr+="CREATE TABLE IF NOT EXISTS "+quoteIdentifier(this._tableName),sqlStr+=this._buildSql()},SqlCreateBuilder.prototype._buildSql=function(){var sqlStr="";return this._columns.length>0&&(sqlStr+=" (",sqlStr+=this._columns.map((function(columnDescription){return[quoteIdentifier(columnDescription.columnName),columnDescription.columnType,"text"===columnDescription.columnType?" COLLATE NOCASE ":"",columnDescription.isPrimary?"PRIMARY KEY ":""].join(" ").slice(0,-1)}),this).join(", "),sqlStr+=")"),sqlStr},Task.of=function(x){return new Task((function(reject,resolve){resolve(x)}))},Task.prototype.chain=function(f){var self=this;return new Task((function(reject,resolve){self.fork(reject,(function(x){f(x).fork(reject,resolve)}))}))},Task.prototype.orElse=function(f){var self=this;return new Task((function(reject,resolve){self.fork((function(e){f(e).fork(reject,resolve)}),resolve)}))},Task.prototype.ap=function(a){var func,value,error,self=this,counter=2;return new Task((function(reject,resolve){function resolveSuccess(){0==--counter&&resolve(func(value))}function resolveError(e){void 0===error&&reject(error=e)}self.fork(resolveError,(function(f){func=f,resolveSuccess()})),a.fork(resolveError,(function(x){value=x,resolveSuccess()}))}))},Task.prototype.map=function(f){return this.chain((function(x){return Task.of(f(x))}))},Task.rejected=Task.prototype.rejected=function(e){return new Task((function(reject,resolve){reject(e)}))},Task.parallel=function(tasks){return new Task((function(reject,resolve){var error,counter=tasks.length,results=new Array(tasks.length);0!==tasks.length?tasks.forEach((function(task,i){task.fork((function(e){void 0===error&&(error=e,reject(e))}),function(i){return function(x){results[i]=x,void 0===error&&0==--counter&&resolve(results)}}(i))})):resolve(results)}))},Task.sequence=function(tasks){return tasks.reduce((function(acc,task){return acc.chain((function(_){return task}))}),Task.of(null))};const TaskReader=new function(M){function ReaderX(f){this.run=f}return ReaderX.prototype.chain=function(f){return new ReaderX(function(r){return this.run(r).chain((function(a){return f(a).run(r)}))}.bind(this))},ReaderX.prototype.ap=function(ma){return new ReaderX(function(r){return this.run(r).ap(ma.run(r))}.bind(this))},ReaderX.prototype.map=function(f){return this.chain((function(x){return ReaderX.of(f(x))}))},ReaderX.of=function(x){return new ReaderX((function(_){return M.of(x)}))},ReaderX.ask=function(){return new ReaderX(M.of)},ReaderX}(Task);TaskReader.rejected=function(e){return new TaskReader((function(_){return Task.rejected(e)}))},TaskReader.parallel=function(taskReaders){return new TaskReader(tx=>new Task((reject,resolve)=>{if(0===taskReaders.length)return void resolve([]);const results=new Array(taskReaders.length);let counter=taskReaders.length,rejected=!1;taskReaders.forEach((taskReader,i)=>{taskReader.run(tx).fork(e=>{rejected||(rejected=!0,reject(e))},result=>{results[i]=result,rejected||0!=--counter||resolve(results)})})}))},TaskReader.sequence=function(taskReaders){return taskReaders.reduce((accReader,taskReader)=>accReader.chain(acc=>taskReader.map(x=>acc.concat([x]))),TaskReader.of([]))};const METADATA_TABLE$1="_guidToTable",ATTRIBUTE_TO_SQL_TYPE={String:"text",Integer:"text",Long:"text",Decimal:"text",Enum:"text",HashString:"text",ObjectReference:"text",DateTime:"integer",Boolean:"integer",AutoNumber:"integer",Binary:"blob"},MODELER_TO_RUNTIME_CONVERTER={String:identity,Integer:identity,Long:identity,Decimal:identity,Enum:identity,HashString:identity,ObjectReference:identity,DateTime:function(s){return s?Number(s):null},Boolean:function(s){return"false"!==s},AutoNumber:identity,Binary:identity};function createFetchSliceTransaction(entity,constraints,offset,limit,sort){constraints=constraints||[],sort=sort||[];const meta=window.mx.meta.getEntity(entity),result=function(meta,constraintList){const args=[];return{builder:(new SqlSelectBuilder).where(constraintList.map((function processConstraint(constraint){if(constraint.constraints)return constraintBuilder[constraint.operator](constraint.constraints.map(processConstraint).filter(c=>null!==c));if(null==constraint.value)switch(constraint.operator){case"contains":return null;case"equals":return constraintBuilder.isNull(toSafeKey$1(constraint.attribute),constraint.negate)}const attrType=meta.getAttributeType(constraint.attribute),queryValue=runtimeToSql((0,MODELER_TO_RUNTIME_CONVERTER[attrType])(constraint.value),attrType);return args.push("contains"===constraint.operator?escapeBoundSqlString(queryValue):queryValue),constraintBuilder[constraint.operator](toSafeKey$1(constraint.attribute),constraint.negate)})).filter(c=>null!==c)),args:args}}(meta,constraints),countBuilder=result.builder.from(toSafeKey$1(entity)),constraintValues=result.args;let objectsBuilder=countBuilder.offset(offset).limit(limit).join(METADATA_TABLE$1,"guid",["dirty","readonlyAttrs"]);objectsBuilder=sort.reduce((function(acc,sortItem){return acc.order(sortItem[0],sortItem[1])}),objectsBuilder);var objectsTransaction=createTransaction(objectsBuilder.select(),constraintValues).map((function(res){const objs=[];for(let i=0;i<res.rows.length;++i){const row=res.rows.item(i),isDirty=Boolean(row[METADATA_TABLE$1+".dirty"]),readonlyAttrs=getMetadata(row,"readonlyAttrs");objs.push(rowToObject(meta,isDirty,readonlyAttrs,row))}return objs})),countTransaction=createTransaction(countBuilder.selectCount("cnt"),constraintValues).map((function(res){return res.rows.item(0).cnt}));return TaskReader.parallel([objectsTransaction,countTransaction])}function createRebuildTransaction(tables,tablesToPreserve,entityToGuidsMapToReset,objs){const tablesToReset=tables.filter(t=>!tablesToPreserve.includes(t)),fullReset=0===tablesToPreserve.length,resetTransaction=function(tablesToReset,resetMetadataTable){const dropTransactions=(resetMetadataTable?[METADATA_TABLE$1]:[]).concat(tablesToReset).map(tableName=>`DROP TABLE IF EXISTS '${toSafeKey$1(tableName)}'`).map(sqlText=>createTransaction(sqlText,[])),resetTransactions=[TaskReader.parallel(dropTransactions),createCreateTransaction(tablesToReset)];if(!resetMetadataTable){const metadataTableCleanSql=`DELETE FROM ${METADATA_TABLE$1} WHERE tableName IN (${tablesToReset.map(_=>"?").join(", ")})`;resetTransactions.push(createTransaction(metadataTableCleanSql,tablesToReset))}return TaskReader.sequence(resetTransactions)}(tablesToReset,fullReset),deleteObjectsTransaction=fullReset?void 0:(entityToGuidsMap=entityToGuidsMapToReset,TaskReader.parallel(Object.entries(entityToGuidsMap).flatMap(([entity,guids])=>createDeleteSqlQueries(entity,guids)).map(([sqlText,params])=>createTransaction(sqlText,params))));var entityToGuidsMap;const fillTransactions=tables.map(tableName=>function(storeName,objs){const transactions=objs.map(objectToJson).map(json=>createTransactions(createInsertSqlQueries(json))).reduce((a,b)=>a.concat(b),[]);return TaskReader.parallel(transactions).map(_=>{})}(0,objs.filter(obj=>obj.$objectType===tableName))),rebuildTransaction=[resetTransaction,deleteObjectsTransaction,TaskReader.parallel(fillTransactions)].filter(tx=>void 0!==tx);return TaskReader.sequence(rebuildTransaction).map(_=>{})}function createCreateTransaction(tableNames){var sql,createTableTransactions=[(sql=(new SqlCreateBuilder).table(METADATA_TABLE$1).primaryKeyColumn("guid","text").column("tableName","text").column("dirty","boolean").column("readonlyAttrs","text").createIfNotExists(),createTransaction(sql,[]))].concat(tableNames.map((function(entityName){return createTransaction(function(entityName){var meta=window.mx.meta.getEntity(entityName);return meta.getAttributes().map((function(attr){var attributeType=meta.getAttributeType(attr);return{attr:attr,type:ATTRIBUTE_TO_SQL_TYPE[attributeType]}}))}(entityName).reduce((function(acc,columnDescription){return acc.column(toSafeKey$1(columnDescription.attr),columnDescription.type)}),(new SqlCreateBuilder).table(toSafeKey$1(entityName)).primaryKeyColumn("guid","text")).createIfNotExists(),[])})));return TaskReader.parallel(createTableTransactions).map(_=>{})}function createFetchDirtyTablesTransaction(){return createTransaction((new SqlSelectBuilder).from(METADATA_TABLE$1).where(constraintBuilder.equals("dirty")).selectDistinct("tableName"),[1])}function identity(x){return x}function rowsToArray(rows){for(var arr=[],i=0;i<rows.length;++i)arr.push(rows.item(i));return arr}function escapeBoundSqlString(s){return s.replace(new RegExp("~","g"),"~~").replace(/%/g,"~%").replace(/_/g,"~_")}function toSafeKey$1(key){return key.replace(".","$")}function fromSafeKey$1(safeKey){return safeKey.replace("$",".")}function rowToObject(meta,dirty,readonlyAttrs,row){const result={guid:row.guid,$objectType:meta.getEntity(),$dirty:dirty,$readonlyAttrs:JSON.parse(readonlyAttrs)};for(const safeKey in row){if("guid"===(keyName=safeKey)||keyName.indexOf(".")>-1)continue;const attr=fromSafeKey$1(safeKey),attrType=meta.getAttributeType(attr);result[attr]=sqlToRuntime(row[safeKey],attrType)}var keyName;return result}function getMetadata(row,field){return row[`${METADATA_TABLE$1}.${field}`]}function createTransactions(metadataAwareSqlQuery){return metadataAwareSqlQuery.map(([sql,args])=>createTransaction(sql,args))}function createTransaction(sql,args){return args=args||[],new TaskReader((function(tx){return new Task((function(reject,resolve){tx.executeSql(sql,args,(_,res)=>resolve(res),(_,e)=>reject(e))}))}))}const runReadTransaction=createRunner("readTransaction"),runWriteTransaction=createRunner("transaction");function createRunner(name){return function(db,transaction){return new Task((function(reject,resolve){var result,counter=2;db[name]((function(tx){transaction.run(tx).fork(reject,(function(r){result=r,0==--counter&&resolve(result)}))}),reject,(function(){0==--counter&&resolve(result)}))}))}}function promiseFromTask(t){return new Promise((function(resolve,reject){t.fork(reject,resolve)}))}class SqlStore{constructor(schema,database){this._tableNames=schema;const initTransaction=createCreateTransaction(this._tableNames);this._databasePromise=promiseFromTask(runWriteTransaction(database,initTransaction)).then(()=>database)}async getByGuid(guid){const db=await this._databasePromise,transaction=function(guid){return createTransaction((new SqlSelectBuilder).from(METADATA_TABLE$1).where(constraintBuilder.equals("guid")).select(),[guid]).chain((function(metaRes){if(0===metaRes.rows.length)return TaskReader.of(null);if(1!==metaRes.rows.length)return TaskReader.rejected(new Error("db consistency error"));const row=metaRes.rows.item(0),entity=row.tableName,isDirty=Boolean(row.dirty),readonlyAttrs=row.readonlyAttrs;return createTransaction((new SqlSelectBuilder).from(toSafeKey$1(entity)).where(constraintBuilder.equals("guid")).select(),[guid]).chain((function(res){return 0===res.rows.length?TaskReader.rejected(new Error("entity not found")):1!==res.rows.length?TaskReader.rejected(new Error("db consistency error")):TaskReader.of(rowToObject(window.mx.meta.getEntity(entity),isDirty,readonlyAttrs,res.rows.item(0)))}))}))}(guid);return promiseFromTask(runReadTransaction(db,transaction))}async getSlice(entity,constraints,filter={}){const db=await this._databasePromise,transaction=createFetchSliceTransaction(entity,constraints,filter.offset,filter.limit,filter.sort);return promiseFromTask(runReadTransaction(db,transaction))}async rebuildDatabase(objs,entityToGuidsMapToReset,tablesToPreserve){const db=await this._databasePromise,transaction=createRebuildTransaction(this._tableNames,tablesToPreserve,entityToGuidsMapToReset,objs);return promiseFromTask(runWriteTransaction(db,transaction))}async insertOrReplace(objs){const db=await this._databasePromise,transaction=function(objs){return TaskReader.parallel(objs.map(obj=>createTransactions(createInsertSqlQueries(objectToJson(obj),!0))).reduce((a,b)=>a.concat(b),[])).map(_=>{})}(objs);return promiseFromTask(runWriteTransaction(db,transaction))}async cleanDatabase(){const db=await this._databasePromise,transaction=(tableNames=this._tableNames,deleteTransactions=[METADATA_TABLE$1].concat(tableNames).map(toSafeKey$1).map(safeTableName=>`DELETE FROM '${safeTableName}'`).map(sqlText=>createTransaction(sqlText,[])),TaskReader.parallel(deleteTransactions).map(_=>{}));var tableNames,deleteTransactions;return promiseFromTask(runWriteTransaction(db,transaction))}async fetchDirty(){const db=await this._databasePromise,transaction=createFetchDirtyTablesTransaction().chain((function(resTables){const transactions=rowsToArray(resTables.rows).map(({tableName:tableName})=>{const sql=(new SqlSelectBuilder).from(toSafeKey$1(tableName)).join(METADATA_TABLE$1,"guid",["dirty","readonlyAttrs"]).where(constraintBuilder.equals(METADATA_TABLE$1+".dirty")).select(),meta=window.mx.meta.getEntity(tableName);return createTransaction(sql,[1]).map(resRows=>rowsToArray(resRows.rows).map(row=>rowToObject(meta,!0,getMetadata(row,"readonlyAttrs"),row)))});return TaskReader.parallel(transactions)})).map(arrs=>arrs.reduce((a,b)=>a.concat(b),[]));return promiseFromTask(runReadTransaction(db,transaction))}async makeClean(objs){const db=await this._databasePromise,transaction=function(objs){var transactions=objs.map(obj=>createTransaction(`UPDATE ${METADATA_TABLE$1} set dirty = 0 where guid = ?`,[obj.guid]));return TaskReader.parallel(transactions).map(_=>{})}(objs);return promiseFromTask(runWriteTransaction(db,transaction))}async cleanupDirtyObjects(){const db=await this._databasePromise,transaction=createFetchDirtyTablesTransaction().chain((function(res){var deleteTransactions=rowsToArray(res.rows).map((function(row){var entity=row.tableName;return createTransaction(`DELETE FROM ${toSafeKey$1(entity)} WHERE guid IN (\n                            SELECT guid FROM ${METADATA_TABLE$1} WHERE tableName = ? AND dirty = 1)`,[entity])}));return TaskReader.sequence([TaskReader.parallel(deleteTransactions),createTransaction(`DELETE FROM ${METADATA_TABLE$1} WHERE dirty = 1`)]).map(_=>{})}));return promiseFromTask(runWriteTransaction(db,transaction))}}function getRemoteDynamicResourceUrl(guid,changedDate,isThumb){return mx.remoteUrl+function(guid,changedDate,isThumb){let url="file?"+["guid="+guid,"changedDate="+changedDate].join("&");return isThumb&&(url+="&thumb=true"),url}(guid,changedDate,isThumb)}class Synchronizer{constructor(store,fileBackend,objectCache,syncConfig){this._store=store,this._fileBackend=fileBackend,this._objectCache=objectCache,this._syncConfig=syncConfig}async upload(){try{return await this._upload()}catch(e){throw window.mx.logger.warn(e),e instanceof DanglingError?e:new SynchronizationError}}async download(uploadedObjsEntityToGuidsMap,fullReset){try{return await this._download(uploadedObjsEntityToGuidsMap,fullReset)}catch(e){throw window.mx.logger.warn(e),new SynchronizationError}}async _upload(){const dirtyObjs=await this._store.fetchDirty();if(0===dirtyObjs.length)return{};!function(syncInternalObjs){const internalGuidsToSync=syncInternalObjs.map(obj=>obj.guid),danglingGuids=unique$1(syncInternalObjs.flatMap(obj=>collectGuidAttrs(obj).map(([_attr,guid])=>guid))).filter(guid=>!wasGuidSynced(guid)).filter(guid=>!internalGuidsToSync.includes(guid));if(danglingGuids.length>0){const danglingGuidsInfo=unique$1(syncInternalObjs.flatMap(obj=>collectGuidAttrs(obj).filter(([_,guid])=>danglingGuids.includes(guid)).map(([attr,_])=>`object of type ${obj.$objectType} (reference ${attr})`))).join(", ");throw new DanglingError(`Sync has failed due to a modeling error. Your database contains objects that reference uncommitted objects:\n${danglingGuidsInfo}.`)}}(dirtyObjs);const[modifiedObjs,createdObjs]=partition(internalObj=>wasGuidSynced(internalObj.guid),dirtyObjs),dirtyFileObjs=dirtyObjs.filter((function(obj){return window.mx.meta.getEntity(obj.$objectType).isA("System.FileDocument")&&obj.HasContents})),[tempUploadPairs,[remoteJsons,offlineToRuntimeGuidMapping]]=await Promise.all([Promise.all(dirtyFileObjs.map(fileObj=>this._tempUploadFile(fileObj))),instantiateObjects(createdObjs.map(objectToJson))]),tempFileToFileGuidMap=objectFromArray(tempUploadPairs.map(({tempGuid:tempGuid,fileObjGuid:fileObjGuid})=>wasGuidSynced(fileObjGuid)?[tempGuid,fileObjGuid]:[tempGuid,offlineToRuntimeGuidMapping.map(fileObjGuid)])),guidsToSend=modifiedObjs.map(obj=>obj.guid).concat(remoteJsons.map(remoteJson=>remoteJson.guid)),changesToSend={};dirtyObjs.forEach(obj=>{const objJson=objectToJson(obj),change=createChange(objJson),meta=window.mx.meta.getEntity(objJson.objectType),remappedChange=offlineToRuntimeGuidMapping.mapChange(change,meta),remappedGuid=offlineToRuntimeGuidMapping.map(objJson.guid);changesToSend[remappedGuid]=remappedChange});const syncResponse=await async function(guids,fileGuidMapping,changes,objects){return post(xasUrl(),{action:"synchronize",params:{guids:guids,fileGuidMapping:fileGuidMapping},changes:changes,objects:objects})}(guidsToSend,tempFileToFileGuidMap,changesToSend,remoteJsons);await this._store.makeClean(dirtyObjs),await Promise.all(dirtyFileObjs.map(async obj=>{const newGuid=offlineToRuntimeGuidMapping.map(obj.guid),newChangedDate=syncResponse.fileChangedDates[newGuid],documentsPath=this._fileBackend.toAbsolutePath("documents/"),currentPath=documentsPath+getFsFileName(obj.guid,obj.changedDate),stablePath=documentsPath+getFsFileName(newGuid,newChangedDate);await this._fileBackend.moveFile(currentPath,stablePath)})),syncedObjsRuntimeToOfflineMap.import(offlineToRuntimeGuidMapping.reverse());const uploadedObjsEntityToGuidsMap={};return dirtyObjs.forEach(({$objectType:$objectType,guid:guid})=>{const guidsUploadedForEntity=uploadedObjsEntityToGuidsMap[$objectType]||[];guidsUploadedForEntity.push(offlineToRuntimeGuidMapping.map(guid)),uploadedObjsEntityToGuidsMap[$objectType]=guidsUploadedForEntity}),uploadedObjsEntityToGuidsMap;function collectGuidAttrs(obj){const meta=window.mx.meta.getEntity(obj.$objectType);return arrayFromObject(obj).filter(([attr,_])=>"guid"===attr||!isSpecialAttributeName(attr)&&meta.isReference(attr))}}async _download(entityToUploadedGuidsMap,fullReset){const{fetch:fetch,preserveData:preserveData,schema:schema}=this._syncConfig,preservedEntityToGuidsMap=fullReset?{}:Object.assign({},...Object.entries(entityToUploadedGuidsMap).filter(([objectType])=>preserveData.includes(objectType)).map(([objectType,guids])=>({[objectType]:guids}))),fetchedObjs=flatten(await Promise.all([...fetch.map(({store:store,xpath:xpath})=>async function(expectedObjectType,xpath){const json=await async function(xpath,schema={},wantCount=!1){return post(xasUrl(),{action:"retrieve_by_xpath",params:{xpath:xpath,schema:schema,count:wantCount}})}(xpath);return extractObjectsFromJSON(expectedObjectType,json,json.resultGuids)}(store,xpath)),async function(){const guidsToRetrieve=flatten(Object.values(preservedEntityToGuidsMap));if(0===guidsToRetrieve.length)return[];const json=await retrieveByIds(guidsToRetrieve,{});return Object.entries(preservedEntityToGuidsMap).flatMap(([objectType,guids])=>extractObjectsFromJSON(objectType,json,guids.filter(guid=>json.resultGuids.includes(guid))))}()])),[downloadFileInstructions,filesToRemove]=await this._computeFilesToDownloadAndDelete(fetchedObjs,!1),[downloadThumbInstructions,thumbsToRemove]=await this._computeFilesToDownloadAndDelete(fetchedObjs,!0);await Promise.all(downloadFileInstructions.concat(downloadThumbInstructions).map(({source:source,destination:destination})=>this._fileBackend.downloadFile(source,destination)));const preservedEntityToOfflineGuidsMap=Object.assign({},...Object.entries(preservedEntityToGuidsMap).map(([objectType,guids])=>({[objectType]:syncedObjsRuntimeToOfflineMap.map(guids)})));await this._store.rebuildDatabase(fetchedObjs,preservedEntityToOfflineGuidsMap,fullReset?[]:preserveData),Promise.all(filesToRemove.concat(thumbsToRemove).map(file=>this._fileBackend.removeFile(file))).catch(window.mx.onError);const externalFetchedObjs=fetchedObjs.map(obj=>jsonToObject(syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(objectToJson(obj)))),cachedWithFetchedObjs=this._objectCache.getAllObjects().filter(mxobj=>{if(!mxobj.isPersistable()||this._objectCache.isNew(mxobj.getGuid()))return!1;if(fullReset||!preserveData.includes(mxobj.getEntity()))return!0;const uploadedRuntimeGuids=entityToUploadedGuidsMap[mxobj.getEntity()]||[];return syncedObjsRuntimeToOfflineMap.map(uploadedRuntimeGuids).includes(mxobj.getGuid())}).map(mxobj=>[externalFetchedObjs.find(obj=>obj.guid===mxobj.getGuid()),mxobj]),[updates,deletes]=partition(([obj])=>void 0!==obj,cachedWithFetchedObjs);return this._objectCache.setMxObjects(updates.map(([obj])=>objectToJson(obj))),this._objectCache.onDelete(deletes.map(([_,mxobj])=>mxobj.getGuid())),[...schema.filter(entity=>!(!fullReset&&preserveData.includes(entity))||void 0!==preservedEntityToGuidsMap[entity]&&!preservedEntityToGuidsMap[entity].every(guid=>void 0!==fetchedObjs.find(f=>f.guid===guid))).map(entity=>({entity:entity})),...updates.map(([{guid:guid}])=>({guid:guid})),...deletes.map(([_,mxobj])=>({guid:mxobj.getGuid()}))];function extractObjectsFromJSON(expectedObjectType,json,guids){return guids.map(guid=>json.objects.find(obj=>obj.guid===guid)).map(jsonToObject).map(obj=>Object.assign({},obj,{$objectType:expectedObjectType}))}}async _tempUploadFile(fileObj){const filePath="documents/"+getFsFileName(fileObj.guid,fileObj.changedDate),blob=await this._fileBackend.readFile(this._fileBackend.toAbsolutePath(filePath));return{tempGuid:(await async function(fileObjGuid,fileName,blob,numberOfRetries){for(let i=0;i<=numberOfRetries;i++)try{return await upload(fileObjGuid,fileName,{},blob,{},[])}catch(e){if(!(i<numberOfRetries))throw e;{const timeout=Math.pow(2,i);await wait(timeout)}}throw new AssertionError}("__sync__","",blob,2)).commits[0],fileObjGuid:fileObj.guid}}async _computeFilesToDownloadAndDelete(internalObjs,isThumb){const root=this._fileBackend.toAbsolutePath(isThumb?"thumbnails":"documents")+"/",objsToHaveFiles=internalObjs.filter(obj=>window.mx.meta.getEntity(obj.$objectType).isA(isThumb?"System.Image":"System.FileDocument")).filter(obj=>obj.HasContents).map(obj=>({source:getRemoteDynamicResourceUrl(obj.guid,obj.changedDate,isThumb),destination:root+getFsFileName(obj.guid,obj.changedDate)})),existingFiles=(await this._fileBackend.listDir(root)).map(name=>root+name);return[objsToHaveFiles.filter(x=>!existingFiles.includes(x.destination)),existingFiles.filter(path=>!objsToHaveFiles.find(x=>x.destination===path))]}}class FormBase{constructor(place){this.place=place,this.listeners={},this.suspended=!1,this.title=""}getTitle(){return this.title}setSuspend(suspend){this.suspended!==suspend&&(this.suspended=suspend)}isSuspended(){return this.suspended}publish(event,callback,error){const list=(event in this.listeners?this.listeners[event]:[]).slice();!function next(){list.length?list.pop()(next,error):void 0!==callback&&callback()}()}listen(event,handler){const list=event in this.listeners?this.listeners[event]:[];return this.listeners[event]=list,list.push(handler),()=>list.splice(list.indexOf(handler),1)}unlisten(handler){handler()}close(callback,error){this.closeMultiple(1).then(callback).catch(error)}}class Parser{formatValue(value,type,config){if(""===value||null===value)return"";switch(type.toLowerCase()){case"decimal":case"integer":case"long":{if("string"==typeof value||"number"==typeof value)try{value=new Big(value)}catch(e){throw new Error(`Value '${value}' cannot be formatted as a numeric value.`)}if(!(value instanceof Big))throw new Error(`Value '${value}' cannot be formatted as a numeric value.`);const numberConfig=toNumberFormatterConfig(config),groupDigits=numberConfig&&numberConfig.groupDigits,configuredDecimals=numberConfig&&numberConfig.decimalPrecision,defaultDecimals="decimal"===type.toLowerCase()?void 0:0;return formatNumber(value,groupDigits,void 0!==configuredDecimals?configuredDecimals:defaultDecimals)}case"datetime":{if(!("number"==typeof value||value instanceof Date))throw new Error(`Value '${value}' cannot be formatted as Date.`);const dateTimeConfig=toDateTimeFormatterConfig(config);return formatDate(new Date(value),dateTimeConfig)}case"boolean":if("boolean"!=typeof value)throw new Error(`Value '${value}' cannot be formatted as boolean.`);return translate("mxui.common",value.toString());default:return String(value)}}formatAttribute(object,attribute,config){const type=object.getAttributeType(attribute),value=object.get(attribute);return"Enum"===type?object.getEnumCaption(attribute)||value:this.formatValue(value,type,config)}parseValue(value,type,config){if(""===value)return"";switch(type.toLowerCase()){case"integer":case"long":case"decimal":{const numberConfig=toNumberFormatterConfig(config),configuredDecimals=numberConfig&&numberConfig.decimalPrecision;return parseNumber(value,configuredDecimals)||null}case"datetime":{const dateTimeConfig=toDateTimeFormatterConfig(config);return parseDate(value,dateTimeConfig)||null}case"enum":return value;case"boolean":return value===translate("mxui.common","true");default:return value}}}function toNumberFormatterConfig(config){if(config)return"places"in config?{decimalPrecision:config.places,groupDigits:Boolean(config.groups)}:config}function toDateTimeFormatterConfig(config){return config?"datePattern"in config&&config.datePattern?{type:"custom",pattern:config.datePattern}:"selector"in config?{type:config.selector}:config:{type:"date"}}class AsyncStore{constructor(key){this.key=key}async get(){const result=await AsyncStorage.getItem(this.key);return null!==result?result:void 0}async set(value){await AsyncStorage.setItem(this.key,value)}async remove(){await AsyncStorage.removeItem(this.key)}}function stackNavigator(routeConfigMap,routerConfig,options={}){return createStackNavigator(routeConfigMap,Object.assign({headerMode:Platform.select({android:"screen",ios:"float"}),defaultNavigationOptions:Object.assign({headerStyleInterpolator:Platform.select({ios:HeaderStyleInterpolators.forUIKit,android:HeaderStyleInterpolators.forFade}),headerTruncatedBackTitle:translate("mxui.widget.native","Navigation.back")},options)},routerConfig))}function drawerNavigator(topLevelRoutes,nonTopLevelRoutes,otherRoutes,config,pages){const routeConfigMap=Object.entries(topLevelRoutes).reduce((map,[pageName,page])=>(map[addStackNavigatorSuffix(pageName)]=stackNavigator(Object.assign(Object.assign({},nonTopLevelRoutes),{[pageName]:page}),{initialRouteName:pageName}),map),otherRoutes);return createDrawerNavigator(routeConfigMap,Object.assign({contentComponent:()=>{var _a;const form=getLastOpenedForm(),pageName=form.getName(),page=pages[pageName];return createElement(RootStoreProvider,{key:pageName,registry:form.storeRegistry,store:form.store},createElement(View,{style:[null===(_a=page.style.sidebar)||void 0===_a?void 0:_a.container,{flex:1}]},page.page.$$sidebar()))},backBehavior:"history",defaultNavigationOptions:()=>{const form=getLastOpenedForm(),page=void 0!==form?pages[form.getName()]:void 0;return{drawerLockMode:(null==page?void 0:page.navigation.sidebar)?"unlocked":"locked-closed"}}},config))}let navigator,lastOpenedForm,navigationStyle={};function setTopLevelNavigator(navigatorRef){navigatorRef&&(navigator=navigatorRef)}function setLastOpenedForm(form){lastOpenedForm=form}function getLastOpenedForm(){return lastOpenedForm}function getNavigationStyle(){return navigationStyle}const transitionResolvers=[];async function dispatch(action){return new Promise(resolve=>{transitionResolvers.push(resolve),navigator.dispatch(action)||(navigator.dispatch(NavigationActions.navigate({routeName:"drawerNavigator"})),navigator.dispatch(action))})}function addStackNavigatorSuffix(pageName){return pageName+"_stackNavigator"}const reloadStore=new AsyncStore("hot-reload"),pageStateStore=new AsyncStore("pageState");let navigationState,lastUsedTabName;function setLastUsedTabName(tabName){lastUsedTabName=tabName}function setNavigationState(navState){navigationState=navState}function errorHandler$1(e){mx.logger.error(e.message,e.stack),Alert.alert("Error","An error has occurred that might have been caused by fast reload. Reload the app to fix it.",[{text:"Cancel",style:"cancel"},{text:"Reload app",onPress:()=>mx.reload()}])}FormData.prototype.append=function(key,value,name){"blob"===key&&value.nativePayload&&(value=value.nativePayload,name&&(value.name=name)),this._parts.push([key,value])};class NativeFileBackend{constructor(rootDirectory){this.rootDirectory=rootDirectory}async listDir(dirPath){return NativeModules.NativeFsModule.list(relativeToAbsolutePath(dirPath))}async removeDir(dirPath){return NativeModules.NativeFsModule.remove(relativeToAbsolutePath(dirPath))}async readFile(filePath){const blob=new Blob;return blob.nativePayload={uri:"file://"+relativeToAbsolutePath(filePath),name:filePath.substring(filePath.lastIndexOf("/")+1),type:"*/*"},blob}async storeFile(blob,filePath){await NativeModules.NativeFsModule.save(blob.data,relativeToAbsolutePath(filePath)),blob.close()}async moveFile(filePath,newPath){return NativeModules.NativeFsModule.move(relativeToAbsolutePath(filePath),relativeToAbsolutePath(newPath))}async removeFile(filePath){return NativeModules.NativeFsModule.remove(relativeToAbsolutePath(filePath))}async downloadFile(url,filePath){const blob=await async function(url,handleAs){const request={url:url,init:{method:"get",headers:new Headers,cache:"force-cache",credentials:"include"}},response=await applyMiddleware(request,doFetch);if(!response.ok)throw new ServerError(response.status,response.statusText);switch(handleAs){case"text":return response.text();case"json":return response.json();case"blob":return response.blob()}}(url,"blob");await NativeModules.NativeFsModule.save(blob.data,relativeToAbsolutePath(filePath)),blob.close()}toAbsolutePath(path){return function(rootDirectory,path){return rootDirectory+"/"+path}(this.rootDirectory,path)}static async readAsDataURL(filePath){return NativeModules.NativeFsModule.readAsDataURL(relativeToAbsolutePath(filePath))}}function relativeToAbsolutePath(path){const DocumentDirectoryPath=NativeModules.NativeFsModule.DocumentDirectoryPath;return path.includes(DocumentDirectoryPath)?path:[DocumentDirectoryPath,path].join("/")}const listeners={sessionWillStart:[]},hooks={onSessionWillStart:listener=>listeners.sessionWillStart.push(listener)};const DocumentDirectoryPath=NativeModules.NativeFsModule.DocumentDirectoryPath;async function startupNativeClient(bundleVersion,languages,systemTexts){const remoteUrl=NativeModules.MxConfiguration.RUNTIME_URL;setSystemTexts(systemTexts);const cache=new MxObjectCache,session=new Session(new AsyncStore("session"),new AsyncStore("token"),bundleVersion,"8.10.0.6992",!0,logout$1),meta=new Meta,data=new Data({garbageCollectionInterval:1e4,logCleanupStatistics:!1},cache),logger=new NativeLogger;!function(){const filterLevel=getWarningsFilterLevel();console.disableYellowBox="none"===filterLevel,"partial"===filterLevel&&YellowBox.ignoreWarnings(IgnoredWarnings)}(),window.mx={appUrl:"resources://",data:data,homeUrl:"not-supported",isOffline:()=>!0,logger:logger,login:login$1,logout:logout$1,meta:meta,onError:errorHandler,reload:()=>NativeModules.NativeReloadHandler.reload(),remoteUrl:remoteUrl,session:session,ui:new NativeUI,version:"8.10.0.6992"},window.mx.data.update=function(args){publish(args).then(args.callback,window.mx.onError)},window.mx.ui.openForm=function(path,args,scope){const pageObjectGuid=args.context&&args.context.getTrackId()||void 0,params=Object.assign({location:"content"},args,{context:void 0,contextParams:args.context?args.context.getParams():{}},args.domNode?{location:"node"}:void 0),callback=args.callback?args.callback.bind(scope):void 0,error=args.error?args.error.bind(scope):window.mx.onError;window.mx.ui.openForm2(path,pageObjectGuid,args.title,window.mx.ui.getContentForm(),params).then(callback,error)},window.mx.server={getCacheBust:()=>window.mx.session.getConfig("cachebust")},window.mx.session.getUserName=function(){return this.getUserObject().get("Name")},FormBase.prototype.commit=function(callback,error){const self=this;function handleError(e){self.setSuspend(!1),error?error(e):window.mx.onError(e)}this.setSuspend(!0),this.publish("submit",(function(){self.publish("commit",(function(){window.mx.data.commit({mxobjs:self.getSubmitObjects(),callback(){self.setSuspend(!1),callback&&callback()},error:handleError})}),handleError)}),handleError)},FormBase.prototype.rollback=function(callback,error){const self=this;function handleError(e){self.setSuspend(!1),error?error(e):window.mx.onError(e)}this.setSuspend(!0),this.publish("rollback",(function(){window.mx.data.rollback({mxobjs:self.getSubmitObjects(),callback(){self.setSuspend(!1),callback&&callback()},error:handleError})}),handleError)},FormBase.prototype.validate=function(callback,error){this.triggerValidation().then(callback,error)},window.mx.parser=new Parser;const{preferredLanguages:preferredLanguages}=await async function(hook){const promises=listeners[hook].map(listener=>listener());return(await Promise.all(promises)).filter(isDefined).reduce((previousValue,currentValue)=>Object.assign(previousValue,currentValue),{})}("sessionWillStart"),shouldSync=await session.startup({hybrid:!0,offline:!0,profile:"NativePhone",timezoneoffset:(new Date).getTimezoneOffset(),preferredLanguages:void 0!==preferredLanguages?preferredLanguages:getLocales().map(local=>local.languageTag)});if(startupLocalization(session.getConfig("locale"),session.getConfig("uiconfig.roundingmode")),updateActiveLanguageIndex(languages,session.getConfig("locale.code")),session.getConfig("isDevModeEnabled")){const devTools=new DevTools(remoteUrl);devTools.connect(),devTools.addOnReload(reload),logger.addHandler((level,...args)=>{devTools.log(level,...args)}),new NativeEventEmitter(NativeModules.NativeReloadHandler).addListener("reloadWithState",()=>reload(!0))}meta.startup();const rootDirectory=NativeModules.MxConfiguration.FILES_DIRECTORY_NAME,database=openDatabase(NativeModules.MxConfiguration.DATABASE_NAME,"1","Mendix Database",-1),syncConfig=session.getOfflineConfig(),fileBackend=new NativeFileBackend(rootDirectory),{offlineData:offlineData,dataBackend:dataBackend}=await async function(objectCache,database,syncConfig,fileBackend,getDocumentUrlFn){const store=new SqlStore(syncConfig.schema,database),synchronizer=new Synchronizer(store,fileBackend,objectCache,syncConfig),dataBackend=new OfflineDataBackend(objectCache,store,fileBackend,synchronizer,getDocumentUrlFn);return await dataBackend.initialize(),{dataBackend:dataBackend,offlineData:new OfflineData(objectCache,database)}}(cache,database,syncConfig,fileBackend,(fileName,changedDate,isThumb)=>`${DocumentDirectoryPath}/${rootDirectory}/${isThumb?"thumbnails":"documents"}/${fileName}`);window.mx.offlineData=offlineData,data.startup(dataBackend),shouldSync&&(await data.uploadOffline(),await data.downloadOffline({},!0))}function login$1(username,password,onSuccess,onError){window.mx.session.login({username:username,password:password}).then(()=>{onSuccess&&onSuccess(),window.mx.reload()},onError)}function logout$1(){window.mx.session.logout().then(()=>window.mx.data.clear(window.mx.reload))}async function reload(hotReload){hotReload&&(await async function(){const lastOpenedForm=getLastOpenedForm();if(void 0===lastOpenedForm)return;const pageState={name:lastOpenedForm.getName(),formParameterGuid:lastOpenedForm.getGuid(),tabName:lastUsedTabName,cache:mx.data.dehydrateCache(),navState:JSON.stringify(navigationState)};await pageStateStore.set(JSON.stringify(pageState))}(),await async function(){await reloadStore.set("reload")}()),window.mx.reload()}class NativeForm extends FormBase{constructor(name,title,formParameterGuid){super("content"),this.name=name,this.formParameterGuid=formParameterGuid,this.title=title,[this.storeRegistry,this.store]=createRootStore([]),this.store.set(pageScope,"form",[this,""]),this.store.set(pageScope,"formSuspended",!1),formParameterGuid?mx.data.get({guid:formParameterGuid,callback:this.setFormParameter.bind(this),error:e=>mx.onError(e)}):(this.store.set(pageScope,"object",unavailable()),this.store.set(pageScope,"firstLoadDone",!0))}setFormParameter(mxobj){this.store.set(pageScope,"object",available(mxobj)),this.store.set(pageScope,"firstLoadDone",!0)}getName(){return this.name}getGuid(){return this.formParameterGuid}setSuspend(suspend){super.setSuspend(suspend),this.store.set(pageScope,"formSuspended",suspend)}getSubmitObjects(){const objects=this.storeRegistry.getAll$("object").map(s=>getOrElseL(s,void 0)).filter(s=>s);return unique(objects)}async closeMultiple(numberOfPages){if(numberOfPages<1)throw new AssertionError("The minimum number of pages to close is 1");await async function(numberOfPages){numberOfPages&&numberOfPages>1?await dispatch(StackActions.pop({n:numberOfPages})):await dispatch(NavigationActions.back())}(numberOfPages)}async triggerValidation(){if(this.store.set(pageScope,"validationRequest",newId("validation_request")),await wait(0),this.storeRegistry.getAll$("isInvalid").some(x=>x))throw new ValidationError}}function DrawerNavigationMenuButton({onPress:onPress,testID:testID,style:style}){const flatStyle=StyleSheet.flatten([defaultStyle,style]);return createElement(Touchable,{onPress:onPress,testID:testID,borderless:!0},createElement(Svg,{fill:flatStyle.tintColor,style:flatStyle,viewBox:"0 0 512 512"},Platform.select({ios:createElement(Path,{d:"M432 176H80c-8.8 0-16-7.2-16-16s7.2-16 16-16h352c8.8 0 16 7.2 16 16s-7.2 16-16 16zM432 272H80c-8.8 0-16-7.2-16-16s7.2-16 16-16h352c8.8 0 16 7.2 16 16s-7.2 16-16 16zM432 368H80c-8.8 0-16-7.2-16-16s7.2-16 16-16h352c8.8 0 16 7.2 16 16s-7.2 16-16 16z"}),android:createElement(Path,{d:"M64 384h384v-42.666H64V384zm0-106.666h384v-42.667H64v42.667zM64 128v42.665h384V128H64z"})})))}const defaultStyle={width:24,height:24,marginHorizontal:16,marginVertical:12};function PopupNavigatorCloseButton({onPress:onPress,testID:testID,style:style}){const flatStyle=StyleSheet.flatten([defaultStyle$1,style]);return createElement(Touchable,{onPress:onPress,testID:testID,borderless:!0},createElement(Svg$1,{fill:flatStyle.tintColor,style:flatStyle,viewBox:"0 0 512 512"},Platform.select({ios:createElement(Path,{d:"M278.6 256l68.2-68.2c6.2-6.2 6.2-16.4 0-22.6-6.2-6.2-16.4-6.2-22.6 0L256 233.4l-68.2-68.2c-6.2-6.2-16.4-6.2-22.6 0-3.1 3.1-4.7 7.2-4.7 11.3 0 4.1 1.6 8.2 4.7 11.3l68.2 68.2-68.2 68.2c-3.1 3.1-4.7 7.2-4.7 11.3 0 4.1 1.6 8.2 4.7 11.3 6.2 6.2 16.4 6.2 22.6 0l68.2-68.2 68.2 68.2c6.2 6.2 16.4 6.2 22.6 0 6.2-6.2 6.2-16.4 0-22.6L278.6 256z"}),android:createElement(Path,{d:"M405 136.798L375.202 107 256 226.202 136.798 107 107 136.798 226.202 256 107 375.202 136.798 405 256 285.798 375.202 405 405 375.202 285.798 256z"})})))}const defaultStyle$1=Platform.select({ios:{width:40,height:40,marginHorizontal:8},android:{width:24,height:24,marginHorizontal:16}});function StackNavigatorBackIcon({testID:testID,style:style}){const flatStyle=StyleSheet.flatten([defaultStyle$2,style]);return createElement(Svg,{testID:testID,fill:flatStyle.tintColor,style:flatStyle,viewBox:"0 0 512 512"},Platform.select({ios:createElement(Path,{d:"M217.9 256L345 129c9.4-9.4 9.4-24.6 0-33.9-9.4-9.4-24.6-9.3-34 0L167 239c-9.1 9.1-9.3 23.7-.7 33.1L310.9 417c4.7 4.7 10.9 7 17 7s12.3-2.3 17-7c9.4-9.4 9.4-24.6 0-33.9L217.9 256z"}),android:createElement(Path,{d:"M427 234.625H167.296l119.702-119.702L256 85 85 256l171 171 29.922-29.924-118.626-119.701H427v-42.75z"})}))}const defaultStyle$2=Platform.select({ios:{height:31,width:31,marginRight:-3},android:{height:24,width:24,margin:3}}),pageFormCache={cache:{},getForm(uuid,pageName,title,formParameterGuid){let form=this.cache[uuid];return void 0===form&&(form=new NativeForm(pageName,title,formParameterGuid),this.cache[uuid]=form),form},clearForm(uuid){delete this.cache[uuid]}};function createPage(pageName,{page:page,navigation:navigationConfig,style:style}){var _a;const globalStyle=getNavigationStyle(),_b=flatten$1([{header:convertDeprecatedTopBarStyle(globalStyle.topBar),statusBar:globalStyle.statusBar},style]),{container:container,statusBar:statusBar={},header:header={},sidebar:sidebar}=_b,legacyPageStyle=__rest(_b,["container","statusBar","header","sidebar"]);return(_a=class extends Component{constructor(props){super(props),this.onDidFocusHandler=this.onDidFocus.bind(this);const{title:title=page.$$title,formParameterGuid:formParameterGuid,pageUuid:pageUuid}=this.props.navigation.state.params;this.form=pageFormCache.getForm(pageUuid,pageName,title,formParameterGuid),setLastOpenedForm(this.form)}componentWillUnmount(){pageFormCache.clearForm(this.props.navigation.state.params.pageUuid)}render(){return createElement(View,{style:[legacyPageStyle,container,{flex:1}],testID:pageName},createElement(RootStoreProvider,{registry:this.form.storeRegistry,store:this.form.store},createElement(NavigationEvents,{onDidFocus:this.onDidFocusHandler}),createElement(StatusBar,{backgroundColor:statusBar.backgroundColor,barStyle:statusBar.barStyle}),page.$$page()))}onDidFocus(){setLastOpenedForm(this.form),function(){const resolver=transitionResolvers.shift();resolver&&resolver()}(),this.props.navigation.dispatch(DrawerActions.closeDrawer())}}).navigationOptions=({navigation:navigation})=>{const{title:title=page.$$title,formParameterGuid:formParameterGuid,pageUuid:pageUuid}=navigation.state.params,form=pageFormCache.getForm(pageUuid,pageName,title,formParameterGuid);return{title:title,headerShown:void 0!==navigationConfig.headerRegionName,headerTitle:props=>createElement(HeaderTitle,Object.assign({},props,{testID:pageName+"$headerTitle"})),headerBackImage:()=>createElement(StackNavigatorBackIcon,{testID:pageName+"$goBack",style:header.backButtonIcon}),headerStyle:header.container,headerBackTitleStyle:header.backButtonText,headerTitleContainerStyle:{maxWidth:Dimensions.get("window").width-175},headerTitleStyle:header.title,headerRight:()=>void 0!==navigationConfig.headerRegionName&&createElement(RootStoreProvider,{registry:form.storeRegistry,store:form.store},page[navigationConfig.headerRegionName]()),headerLeft:"Popup"===navigationConfig.type&&navigation.isFirstRouteInParent()?()=>createElement(PopupNavigatorCloseButton,{onPress:()=>navigation.pop(),testID:pageName+"$closePopup",style:header.backButtonIcon}):navigationConfig.sidebar?()=>createElement(DrawerNavigationMenuButton,{onPress:()=>navigation.toggleDrawer(),testID:pageName+"$toggleSidebar",style:header.backButtonIcon}):void 0}},_a}function convertDeprecatedTopBarStyle(style={}){return{container:Object.assign({backgroundColor:style.backgroundColor},style.container),title:Object.assign({color:style.titleColor,fontFamily:style.titleFontFamily,fontSize:style.titleFontSize},style.title),backButtonText:Object.assign({color:style.backButtonColor},style.backButtonText),backButtonIcon:Object.assign({tintColor:style.backButtonColor},style.backButtonIcon)}}function TabNavigatorLabel(bottomBarStyle,caption){return({tintColor:tintColor,focused:focused})=>createElement(Text,{numberOfLines:1,style:Object.assign(Object.assign({textAlign:"center",marginBottom:1.5,color:null!=tintColor?tintColor:void 0,fontFamily:bottomBarStyle.fontFamily,fontSize:bottomBarStyle.fontSize},bottomBarStyle.label),focused?bottomBarStyle.selectedLabel:{})},caption)}function tabNavigator(pageTypes,tabs,initialRouteName){const initialTabIndex=tabs.findIndex(tab=>tab.pageName===initialRouteName);return stackNavigator(Object.assign(Object.assign({},pageTypes.nonTopLevel),{innerTabNavigator:innerTabNavigator(createRouteConfigMap(tabs,pageTypes.inBottomBar,pageTypes.visibleBottomBar),{initialRouteName:-1!==initialTabIndex?String(initialTabIndex):void 0})}),{initialRouteName:"innerTabNavigator"})}function innerTabNavigator(routes,config){const{bottomBar:bottomBar={}}=getNavigationStyle();return createBottomTabNavigator(routes,Object.assign({tabBarOptions:{activeTintColor:bottomBar.selectedColor,inactiveTintColor:bottomBar.color,style:[{backgroundColor:bottomBar.backgroundColor},bottomBar.container]},navigationOptions:{headerShown:!1}},config))}function createRouteConfigMap(tabs,pagesInBottomBar,pagesWithBottomBar){const{bottomBar:bottomBar={}}=getNavigationStyle();return tabs.reduce((map,tab,index)=>{var bottomBarStyle,icon;return map[index]={screen:stackNavigator(Object.assign(Object.assign({},pagesWithBottomBar),{[tab.pageName]:Object.assign(Object.assign({},pagesInBottomBar[tab.pageName]),{params:{pageUuid:newId("tab")}})}),{initialRouteName:tab.pageName,initialRouteParams:{title:tab.title}}),navigationOptions:Object.assign({title:tab.caption,tabBarIcon:(bottomBarStyle=bottomBar,icon=tab.icon,({tintColor:tintColor,focused:focused})=>{const style=Object.assign(Object.assign({color:null!=tintColor?tintColor:void 0},bottomBarStyle.icon),focused?bottomBarStyle.selectedIcon:{}),{color:color,size:size}=style,viewStyle=__rest(style,["color","size"]);return createElement(View,{style:viewStyle},createElement(Icon,{icon:icon,color:color,size:size}))}),tabBarLabel:TabNavigatorLabel(bottomBar,tab.caption),tabBarTestID:"bottomBarItem$"+tab.caption},"Blank"===tab.pageName?{tabBarOnPress:()=>{},tabBarOnLongPress:()=>{}}:{tabBarOnPress:options=>{setLastUsedTabName(tab.pageName),options.defaultHandler()}})},map},{})}function createAppNavigator({pages:pages,tabs:tabs}){const initialRouteNames=function(pages,tabs){const defaultHomePage=function(){const openFormInstruction=mx.session.getConfig("instructions")[0];if("open_form"!==openFormInstruction.type)throw new AssertionError;return openFormInstruction.args.FormPath.replace("/",".").replace(".page.xml","")}();if("TopLevel"!==pages[defaultHomePage].navigation.type&&tabs.filter(tab=>"Blank"!==tab.pageName).length>0)return{drawer:"tabNavigator"};return tabs.some(tab=>tab.pageName===defaultHomePage)?{drawer:"tabNavigator",tab:defaultHomePage}:{drawer:addStackNavigatorSuffix(defaultHomePage)}}(pages,tabs),pageTypes=function(pages,tabs,initialPage){return Object.entries(pages).reduce((pageTypes,[pageName,page])=>{const route={screen:createPage(pageName,page),params:{pageUuid:newId("page")}};switch(page.navigation.type){case"Popup":pageTypes.popup[pageName]=route;break;case"TopLevel":tabs.some(tab=>tab.pageName===pageName)?pageTypes.inBottomBar[pageName]=route:pageTypes.topLevel[pageName]=route;break;case"Default":tabs.some(tab=>tab.pageName===pageName)?pageTypes.inBottomBar[pageName]=route:addStackNavigatorSuffix(pageName)===initialPage&&(pageTypes.topLevel[pageName]=route),page.navigation.showBottomBar&&(pageTypes.visibleBottomBar[pageName]=route),pageTypes.nonTopLevel[pageName]=route;break;default:throw new TypeError(`Invalid value '${page.navigation.type}' for page.navigation.type`)}return pageTypes},{topLevel:{},nonTopLevel:{},inBottomBar:{},visibleBottomBar:{},popup:{}})}(pages,tabs,initialRouteNames.drawer);return function(popupRoutes,otherRoutes,config){const routeConfigMap=Object.keys(popupRoutes).reduce((map,pageName)=>(map[pageName]=stackNavigator(popupRoutes,{initialRouteName:pageName},"ios"===Platform.OS?{headerStatusBarHeight:0}:{}),map),otherRoutes);return createStackNavigator(routeConfigMap,Object.assign({mode:"modal",headerMode:"none",defaultNavigationOptions:"ios"===Platform.OS?TransitionPresets.ModalPresentationIOS:{}},config))}(pageTypes.popup,{drawerNavigator:drawerNavigator(pageTypes.topLevel,pageTypes.nonTopLevel,tabs.length>0?{tabNavigator:tabNavigator(pageTypes,tabs,initialRouteNames.tab)}:{},{initialRouteName:initialRouteNames.drawer},pages)},{initialRouteName:"drawerNavigator"})}const initialState={activeMessage:void 0};class ProgressOverlay extends Component{constructor(){super(...arguments),this.state=initialState,this.showDelay=500,this.messageQueue=[],this.messageId=0}componentDidMount(){this.backHandler=BackHandler.addEventListener("hardwareBackPress",()=>void 0!==this.state.activeMessage)}componentWillUnmount(){this.hide(),this.backHandler&&this.backHandler.remove()}render(){return this.state.activeMessage?createElement(View,{style:[defaultStyle$3.background,this.props.style.background]},createElement(View,{style:[defaultStyle$3.container,this.props.style.container]},createElement(ActivityIndicator,{style:this.props.style.activityIndicator,color:this.props.style.activityIndicator&&this.props.style.activityIndicator.color,size:this.props.style.activityIndicator&&this.props.style.activityIndicator.size||defaultStyle$3.activityIndicator.size}),this.state.activeMessage.text?createElement(Text,{style:this.props.style.text},this.state.activeMessage.text):null)):null}add(text,immediate){const id=this.messageId++,message={id:id,text:text,immediate:immediate};return this.messageQueue.push(message),1===this.messageQueue.length?this.show(message):immediate&&this.showTimer&&(clearTimeout(this.showTimer),this.showTimer=void 0,this.show(message)),id}remove(id){this.messageQueue.some(message=>message.id===id)?(this.removeFromQueue(id),this.state.activeMessage&&this.state.activeMessage.id===id&&this.messageQueue.length>0?this.showImmediate(this.messageQueue[0]):0===this.messageQueue.length&&this.hide()):mx.logger.error(`mx.ui.hideProgress: progress id ${id} not found`)}show(message){message.immediate?this.showImmediate(message):this.showTimer=setTimeout(()=>this.showImmediate(message),this.showDelay)}showImmediate(message){this.showTimer=void 0,this.setState({activeMessage:message})}hide(){this.showTimer?(clearTimeout(this.showTimer),this.showTimer=void 0):this.setState(initialState)}removeFromQueue(id){const index=this.messageQueue.findIndex(message=>message.id===id);this.messageQueue.splice(index,1)}}const defaultStyle$3={background:{position:"absolute",left:0,top:0,right:0,bottom:0,alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.001)"},container:{alignItems:"center"},activityIndicator:{size:"large"}};let progressOverlay,progressOverlayId;function setProgressOverlayRef(progressOverlayRef){progressOverlayRef&&(progressOverlay=progressOverlayRef)}function addProgressOverlay(text,immediate){return progressOverlay.add(text,immediate)}function removeProgressOverlay(id){progressOverlay.remove(id)}function createApp(navigatorConfig){const AppContainer=createAppContainer(createAppNavigator(navigatorConfig));return function(){var _a;return createElement(TopLevelView,{style:{flex:1}},createElement(AppContainer,{ref:setTopLevelNavigator,persistNavigationState:persistNavigationState,loadNavigationState:loadNavigationState}),createElement(ProgressOverlay,{style:null!==(_a=getNavigationStyle().progressOverlay)&&void 0!==_a?_a:{},ref:setProgressOverlayRef}))};async function loadNavigationState(){if(!await async function(){return void 0!==await reloadStore.get()}())throw new Error("Not hot reloaded");await async function(){await reloadStore.remove()}();const pageState=await async function(){mx.onError=errorHandler$1;const state=await pageStateStore.get();try{return JSON.parse(state)}catch(_a){return}}();if(!pageState)throw new Error("Page state could not be loaded");if(void 0===pageState.name||void 0===navigatorConfig.pages[pageState.name]||void 0!==pageState.tabName&&!navigatorConfig.tabs.some(tab=>tab.pageName===pageState.tabName))throw new Error("Page state is incorrect");mx.data.hydrateCache(pageState.cache);const navigationState=JSON.parse(pageState.navState);return setNavigationState(navigationState),void 0!==pageState.tabName&&setLastUsedTabName(pageState.tabName),navigationState}async function persistNavigationState(navState){return setNavigationState(navState)}}function shouldUseCodePush(){const CODE_PUSH_KEY=NativeModules.MxConfiguration.CODE_PUSH_KEY;return void 0!==CODE_PUSH_KEY&&0!==CODE_PUSH_KEY.trim().length}async function synchronizeCodePush(){if(shouldUseCodePush())return codePush.sync({updateDialog:{appendReleaseDescription:!0},rollbackRetryOptions:{delayInHours:.004,maxRetryAttempts:5}},status=>{switch(status){case codePush.SyncStatus.DOWNLOADING_PACKAGE:void 0===progressOverlayId&&(progressOverlayId=addProgressOverlay("Downloading...",!1));break;case codePush.SyncStatus.UPDATE_INSTALLED:Alert.alert("Update Installed","The new update is installed",[{text:"continue"}]);break;case codePush.SyncStatus.UNKNOWN_ERROR:hideProgressOverlay()}},progress=>{console.log(`OTA: ${Math.floor(progress.receivedBytes/progress.totalBytes*100)}%`),progress.receivedBytes>=progress.totalBytes&&hideProgressOverlay()}).catch(_=>{hideProgressOverlay()})}function hideProgressOverlay(){void 0!==progressOverlayId&&(removeProgressOverlay(progressOverlayId),progressOverlayId=void 0)}function createAppLoader(props,pages){return class extends Component{constructor(){super(...arguments),this.state={}}async componentDidMount(){try{await async function(){return void 0===codePush||await synchronizeCodePush()!==codePush.SyncStatus.UPDATE_INSTALLED}()&&(await startupNativeClient(await async function(){var _a;let label;return void 0!==codePush&&(label=null===(_a=await codePush.getUpdateMetadata())||void 0===_a?void 0:_a.label),`${DeviceInfo.getVersion()}-${DeviceInfo.getBuildNumber()}-${null!=label?label:"default"}`}(),props.languages,props.systemTexts),props.onStartupNativeClient()),style=props.navigationStyle,navigationStyle=style,(style.statusBar||style.topBar)&&mx.logger.warn("DEPRECATED: The topBar and statusBar properties of the navigationStyle class, use Page and Layout classes instead -- will be removed in version: 9.0.0");const visibleTabs=props.getTabs().filter(tab=>void 0===tab.visibleForRoles||mx.session.hasSomeRole(tab.visibleForRoles));this.setState({component:createApp({pages:pages,tabs:visibleTabs})})}catch(e){errorHandler(e)}var style}componentDidCatch(error,_){errorHandler(error)}render(){if(void 0===this.state.component)return createElement(ProgressOverlay,{style:{},ref:setProgressOverlayRef});const AppComponent=this.state.component;return createElement(AppComponent,null)}}}const pages={Blank:{page:{$$page:()=>null,$$sidebar:()=>null,$$style:[],$$title:""},navigation:{sidebar:!1,showBottomBar:!0,type:"Default"},style:{}}};class NativeUI{confirmation(args){args.handler()}downloadFile(){}showProgress(message,modal=!1){return addProgressOverlay(message,modal)}hideProgress(progressId){removeProgressOverlay(progressId)}toggleSidebar(){pages[getLastOpenedForm().getName()].navigation.sidebar&&navigator.dispatch(DrawerActions.toggleDrawer())}async openForm2(pageName,formParameterGuid,title){const navObj={routeName:pageName,params:{formParameterGuid:formParameterGuid,pageUuid:newId("page")}};let subscription;title&&(navObj.params=Object.assign(Object.assign({},navObj.params),{title:title})),formParameterGuid&&(subscription=subscribe({guid:formParameterGuid,tag:"currently loading page"}));try{return"TopLevel"===pages[pageName].navigation.type?await async function(payload){lastOpenedForm.getName()!==payload.routeName&&await dispatch(NavigationActions.navigate(Object.assign(Object.assign({},payload),{action:StackActions.popToTop({immediate:!0})})))}(navObj):await async function(payload){await dispatch(StackActions.push(payload))}(navObj),getLastOpenedForm()}finally{subscription&&subscription.unsubscribe()}}reload(){}showLogin(){throw new NotImplementedError("showLogin")}showMessage(type,message){const title=translate("mxui.widget.DialogMessage",type),buttonText=translate("mxui.widget.DialogMessage","ok");Alert.alert(title,message,[{text:buttonText}])}static registerPage(pageName,page,navigation){pages[pageName]={page:page,navigation:navigation,style:flatten$1(page.$$style)}}static registerRootComponent(props){const appLoader=createAppLoader(props,pages);AppRegistry.registerComponent("App",()=>{return Application=appLoader,shouldUseCodePush()?codePush({checkFrequency:codePush.CheckFrequency.MANUAL})(Application):Application;var Application})}}async function startApp(props){console.reportErrorsAsExceptions=!1,NativeUI.registerRootComponent(props)}configure({reactionScheduler:unstable_batchedUpdates});export{NativeUI,asPluginWidget,asPluginWidgets,hooks,startApp};
